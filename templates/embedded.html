{% extends "base.html" %}
{% block title %}{{ embedded_name }} â€“ Aircraft Ops{% endblock %}

{% block content %}
<style>
  /* Reset full page and prevent scrolling */
  html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  /* Pin content between header & footer and allow full-bleed width */
  body.embedded main.container {
    position: absolute;
    top: 3.5rem;    /* header height */
    bottom: 2.5rem; /* footer height */
    left: 0;
    right: 0;
    margin: 0;
    padding: 0;
    max-width: none !important;   /* override base max-width */
  }

  /* Scoped iframe fills the container */
  #tar1090-frame {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;    /* ensure initial correct sizing */
    height: 100%;   /* ensure initial correct sizing */
    border: none;
    touch-action: none;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
</style>

<!-- iframe width/height attributes ensure the browser allocates correct space before load -->
<iframe id="tar1090-frame" src="{{ url }}" width="100%" height="100%"></iframe>

<script>
  const iframe = document.getElementById('tar1090-frame');
  iframe.addEventListener('load', () => {
    try {
      // Only inject into our tar1090 instance
      if (!iframe.src.includes('/tar1090/')) {
        console.warn('Skipping tar1090 injection: URL mismatch');
        return;
      }
      const { contentWindow: childWin } = iframe;
      const map = childWin.map;
      if (!map || typeof map.invalidateSize !== 'function') {
        console.warn('tar1090 `map` not found for injection');
        return;
      }

      // On touch end: reload any missing tiles
      map.on('touchend', () => map.invalidateSize({ pan: false }));

      // On resize/orientation change: redraw the map
      window.addEventListener('resize', () => map.invalidateSize({ animate: true }));

      console.log('Injected tar1090 resize/touchend handlers');
    } catch (err) {
      console.error('Injection into tar1090 iframe failed:', err);
    }
  });
</script>
{% endblock %}
