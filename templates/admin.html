{% extends "base.html" %}
{% block title %}Admin Console ‚Äì Aircraft Ops{% endblock %}

{% block content %}
<div class="container admin-console">
  <h2>üêô Admin Console</h2>

  <form id="admin-form" method="POST" action="{{ url_for('admin.admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- ‚îÄ‚îÄ Core Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <hr>
    <h3>Core Settings</h3>

    <label>Default Origin (DB-backed):</label>
    <input
      id="admin-default-origin"
      type="text"
      name="default_origin"
      value="{{ default_origin }}"
      placeholder="e.g. KSEA or SEA"
      class="{% if 'db_reset' in (_all_flashes|map(attribute=0)) %}fade-red{% endif %}">
    <label>Embedded Site (optional):</label>
    <div class="embedded-config">
      <input
        id="embedded-url"
        type="text"
        name="embedded_url"
        value="{{ embedded_url }}"
        placeholder="https://your.local/app">

      <input
        id="embedded-name"
        type="text"
        name="embedded_name"
        value="{{ embedded_name }}"
        placeholder="Tab label‚Ä¶">

      <button
        name="clear_embedded"
        value="1"
        type="submit"
        class="danger">
        Clear
      </button>
      <label for="embedded-mode" style="margin-left:1rem">Embed Mode:</label>
      <select
        id="embedded-mode"
        name="embedded_mode"
        style="width:16ch; display:inline-block; margin-left:0.5rem;"
        onchange="this.form.submit()">
        <option value="iframe" {% if embedded_mode=='iframe' %}selected{% endif %}>
          Iframe
        </option>
        <option value="proxy" {% if embedded_mode=='proxy' %}selected{% endif %}>
          Proxy
        </option>
      </select>
    </div>
      <!-- distances controlled automatically; hide manual toggle -->
      <label id="distances-toggle" style="display:none; margin-top:1rem;">
      <input type="checkbox"
             name="enable_1090_distances"
             onchange="this.form.submit()"
             {% if enable_1090_distances %}checked{% endif %}>
        Compute and show 1090 feed distances
      </label>
    <label style="margin-top:18px">Show Debug Logs:</label>
    <select name="show_debug_logs" onchange="this.form.submit()">
      <option value="no"  {% if show_debug_logs=='no'  %}selected{% endif %}>No</option>
      <option value="yes" {% if show_debug_logs=='yes' %}selected{% endif %}>Yes</option>
    </select>

    <label style="margin-top:12px">Force Internet Online:</label>
    <select name="internet_force_online" onchange="this.form.submit()">
      <option value="no"  {% if internet_force_online=='no'  %}selected{% endif %}>No</option>
      <option value="yes" {% if internet_force_online=='yes' %}selected{% endif %}>Yes</option>
    </select>
    <small class="hint">
      When ‚ÄúYes‚Äù, the system assumes WAN is available and keeps Winlink jobs running,
      even if probes fail.
    </small>
  </form>

  <!-- ‚îÄ‚îÄ Wargame Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin.admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label>Wargame Mode:</label>
    <select name="toggle_wargame" onchange="this.form.submit()">
      <option value="off" {% if not wargame_mode %}selected{% endif %}>Off</option>
      <option value="on"  {% if wargame_mode     %}selected{% endif %}>On</option>
    </select>
  </form>

  <!-- ‚îÄ‚îÄ Change App Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <hr>
  <form method="POST" action="{{ url_for('admin.admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>Change App Password</h3>

    <label for="new-password">New Password:</label>
    <input id="new-password" type="password" name="new_password" required>

    <label for="confirm-password">Confirm Password:</label>
    <input id="confirm-password" type="password" name="confirm_password" required>

    <button
      name="change_password"
      value="1"
      style="margin-top:0.5rem">
      Update Password
    </button>
  </form>
  <!-- ‚îÄ‚îÄ Winlink Client Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin.admin') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>WinLink CMS Settings</h3>
    {% for i in [1,2,3] %}
    <div>
      <label for="winlink_callsign_{{i}}">Callsign {{i}}</label>
      <input type="text" id="winlink_callsign_{{i}}" name="winlink_callsign_{{i}}"
             value="{{ winlink_callsign_1 if i==1 else winlink_callsign_2 if i==2 else winlink_callsign_3 }}"
             placeholder="CALLSIGN">

      <label for="winlink_password_{{i}}">Password {{i}}</label>
      <input type="password" id="winlink_password_{{i}}" name="winlink_password_{{i}}"
             value="{{ winlink_password_1 if i==1 else winlink_password_2 if i==2 else winlink_password_3 }}">
    </div>
    {% endfor %}
    <button type="submit">Save WinLink Settings</button>
  </form>

  <!-- ‚îÄ‚îÄ PAT Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin.configure_pat') }}" style="display:inline; margin-left:1rem;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit">Configure PAT</button>
  </form>

  <!-- ‚îÄ‚îÄ Exit Admin Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin.admin') }}" style="margin-top:1rem">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button name="exit_admin" value="1">Exit Admin Mode</button>
  </form>

  <!-- ‚îÄ‚îÄ Invalidate All Sessions (danger!) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin.admin') }}" style="margin-top:1rem">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button name="invalidate_sessions" value="1" class="danger">
      Invalidate All Sessions
    </button>
  </form>

  <!-- ‚îÄ‚îÄ NetOps Feeder (Remote Push) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <hr>
  <h3>NetOps Feeder</h3>
  <form id="netops-form" method="POST" action="{{ url_for('admin.admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="netops_save" value="1">
    <label for="netops_enabled">Enable NetOps Feeder:</label>
    <select id="netops_enabled" name="netops_enabled">
      <option value="no"  {% if netops_enabled!='yes' %}selected{% endif %}>No</option>
      <option value="yes" {% if netops_enabled=='yes' %}selected{% endif %}>Yes</option>
    </select>

    <label for="netops_url">NetOps URL:</label>
    <input id="netops_url" name="netops_url" value="{{ netops_url }}" placeholder="http://example.org:5250">

    <label for="netops_station">Station ID (Pelican Case):</label>
    <input id="netops_station" name="netops_station" value="{{ netops_station }}" placeholder="KALW" oninput="this.value=this.value.toUpperCase()">

    <label for="netops_password">Password:</label>
    <input id="netops_password" type="password" name="netops_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
    <small>Leave blank to keep existing.</small>

    <label for="netops_push_interval_sec">Push Interval (seconds):</label>
    <input id="netops_push_interval_sec" name="netops_push_interval_sec"
           type="number" inputmode="numeric" min="1" step="1"
           value="{{ netops_push_interval_sec }}"
           placeholder="e.g. 30">

    <label for="netops_window_hours">Data Window (hours):</label>
    <input id="netops_window_hours" name="netops_window_hours"
           type="number" inputmode="numeric" min="1" step="1"
           value="{{ netops_window_hours }}"
           placeholder="e.g. 24">

    <label for="origin-lat">Origin Coordinates (lat, lon):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="origin-lat" name="origin_lat"
             type="number" inputmode="decimal" step="any" min="-90"  max="90"
             value="{{ origin_lat }}" placeholder="Latitude (‚àí90 to 90)" style="flex:1;">
      <input id="origin-lon" name="origin_lon"
             type="number" inputmode="decimal" step="any" min="-180" max="180"
             value="{{ origin_lon }}" placeholder="Longitude (‚àí180 to 180)" style="flex:1;">
    </div>
    <button type="submit" style="margin-top:12px;">üíæ Save NetOps Settings</button>
    <button type="submit"
            name="netops_action"
            value="test"
            style="margin-top:12px;margin-left:8px;">
      üîå Test Connection
    </button>
  </form>

  <!-- ‚îÄ‚îÄ Data Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <hr>
  <h3>Data Management</h3>
  <form style="display:inline" action="{{ url_for('exports.export_all_csv') }}" method="GET">
    <button>Export All CSVs</button>
  </form>
  {# importer disabled: use local DB functions instead #}
  {# <form style="display:inline" action="{{ url_for('exports.import_csv') }}" method="POST" enctype="multipart/form-data">
       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
       <input type="file" name="csv_file" accept=".csv" required>
       <button>Import CSV</button>
     </form> #}
  <br><br>
  <form method="POST"
        action="{{ url_for('core.reset_db') }}"
        onsubmit="return confirm('This will wipe ALL data‚Äîcontinue?')">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="danger">Reset Database</button>
  </form>
</div>

<script>
;(function(){
  const form  = document.getElementById('admin-form');
  const input = document.getElementById('admin-default-origin');
  let   timer;

  // ‚îÄ‚îÄ Default-Origin autosave ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(()=> {
      // Only submit if no embedded save is pending
      if (!form.querySelector('input[name="save_embedded"]')) {
        form.submit();
      }
    }, 800);
  });
  input.addEventListener('blur', () => {
    clearTimeout(timer);
    // Only submit for default origin if no embedded save is pending
    if (!form.querySelector('input[name="save_embedded"]')) {
      form.submit();
    }
  });

  // ‚îÄ‚îÄ Embedded-Tab autosave (only when both fields filled) ‚îÄ
  const urlInput  = document.getElementById('embedded-url');
  const nameInput = document.getElementById('embedded-name');
  const distCheckbox = document.querySelector('input[name="enable_1090_distances"]');
  let   embedTimer;
  let   embedSaving = false; // prevent double-submit

  // ‚îÄ‚îÄ Prevent Enter from submitting & clearing url fields ‚îÄ
  [urlInput, nameInput].forEach(el => {
    el.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        // Trigger save on Enter
        clearTimeout(embedTimer);
        trySaveEmbedded();
      }
    });
  });

  function trySaveEmbedded(){
    if (embedSaving) return;
    const u = urlInput .value.trim();
    const n = nameInput.value.trim();
    if (!u || !n) return;

    embedSaving = true;

    // if they're pointing at tar1090, auto-enable distances
    if (u.toLowerCase().includes('tar1090')) {
      distCheckbox.checked = true;
    } else {
      distCheckbox.checked = false;
    }

    // inject a hidden flag so the server knows to save these two
    let flag = form.querySelector('input[name="save_embedded"]');
    if (!flag){
      flag = document.createElement('input');
      flag.type  = 'hidden';
      flag.name  = 'save_embedded';
      flag.value = '1';
      form.appendChild(flag);
    }
    form.submit();
  }

  [urlInput, nameInput].forEach(el => {
    el.addEventListener('input', () => {
      clearTimeout(embedTimer);
      // Increased to 2400ms (3x original) to give user time to complete entry
      embedTimer = setTimeout(trySaveEmbedded, 2400);
    });
    el.addEventListener('blur', () => {
      clearTimeout(embedTimer);
      // Small delay on blur to avoid race conditions
      setTimeout(trySaveEmbedded, 100);
    });
  });

})();
</script>
{% endblock %}
