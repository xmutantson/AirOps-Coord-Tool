{% extends "base.html" %}
{% block title %}Admin Console ‚Äì Aircraft Ops{% endblock %}

{% block content %}
<div class="container admin-console">
  <h2>üêô Admin Console</h2>

  <form id="admin-form" method="POST" action="{{ url_for('admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- ‚îÄ‚îÄ Core Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <hr>
    <h3>Core Settings</h3>

    <label>Default Origin (DB-backed):</label>
    <input
      id="admin-default-origin"
      type="text"
      name="default_origin"
      value="{{ default_origin }}"
      placeholder="e.g. KSEA or SEA"
      class="{% if 'db_reset' in (_all_flashes|map(attribute=0)) %}fade-red{% endif %}">
    <label>Embedded Site (optional):</label>
    <div class="embedded-config">
      <input
        id="embedded-url"
        type="text"
        name="embedded_url"
        value="{{ embedded_url }}"
        placeholder="https://your.local/app">

      <input
        id="embedded-name"
        type="text"
        name="embedded_name"
        value="{{ embedded_name }}"
        placeholder="Tab label‚Ä¶">

      <button
        name="clear_embedded"
        value="1"
        type="submit"
        class="danger">
        Clear
      </button>
      <label for="embedded-mode" style="margin-left:1rem">Embed Mode:</label>
      <select
        id="embedded-mode"
        name="embedded_mode"
        style="width:16ch; display:inline-block; margin-left:0.5rem;"
        onchange="this.form.submit()">
        <option value="iframe" {% if embedded_mode=='iframe' %}selected{% endif %}>
          Iframe
        </option>
        <option value="proxy" {% if embedded_mode=='proxy' %}selected{% endif %}>
          Proxy
        </option>
      </select>
    </div>
      <!-- distances controlled automatically; hide manual toggle -->
      <label id="distances-toggle" style="display:none; margin-top:1rem;">
      <input type="checkbox"
             name="enable_1090_distances"
             onchange="this.form.submit()"
             {% if enable_1090_distances %}checked{% endif %}>
        Compute and show 1090 feed distances
      </label>
    <label style="margin-top:18px">Show Debug Logs:</label>
    <select name="show_debug_logs" onchange="this.form.submit()">
      <option value="no"  {% if show_debug_logs=='no'  %}selected{% endif %}>No</option>
      <option value="yes" {% if show_debug_logs=='yes' %}selected{% endif %}>Yes</option>
    </select>
  </form>

  <!-- ‚îÄ‚îÄ Wargame Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label>Wargame Mode:</label>
    <select name="toggle_wargame" onchange="this.form.submit()">
      <option value="off" {% if not wargame_mode %}selected{% endif %}>Off</option>
      <option value="on"  {% if wargame_mode     %}selected{% endif %}>On</option>
    </select>
  </form>

  <!-- ‚îÄ‚îÄ Change App Password ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <hr>
  <form method="POST" action="{{ url_for('admin') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>Change App Password</h3>

    <label for="new-password">New Password:</label>
    <input id="new-password" type="password" name="new_password" required>

    <label for="confirm-password">Confirm Password:</label>
    <input id="confirm-password" type="password" name="confirm_password" required>

    <button
      name="change_password"
      value="1"
      style="margin-top:0.5rem">
      Update Password
    </button>
  </form>
  <!-- ‚îÄ‚îÄ Winlink Client Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin') }}">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>WinLink CMS Settings</h3>
    <div>
      <label for="winlink_cms_host">CMS Host</label>
      <input
        type="text" id="winlink_cms_host" name="winlink_cms_host"
        value="{{ winlink_cms_host }}"
        placeholder="e.g. cms.winlink.org">
    </div>
    <div>
      <label for="winlink_cms_port">CMS Port</label>
      <input
        type="number" id="winlink_cms_port" name="winlink_cms_port"
        value="{{ winlink_cms_port }}"
        placeholder="e.g. 8773">
    </div>
    {% for i in [1,2,3] %}
    <div>
      <label for="winlink_callsign_{{i}}">Callsign {{i}}</label>
      <input type="text" id="winlink_callsign_{{i}}" name="winlink_callsign_{{i}}"
             value="{{ winlink_callsign_1 if i==1 else winlink_callsign_2 if i==2 else winlink_callsign_3 }}"
             placeholder="CALLSIGN">

      <label for="winlink_password_{{i}}">Password {{i}}</label>
      <input type="password" id="winlink_password_{{i}}" name="winlink_password_{{i}}"
             value="{{ winlink_password_1 if i==1 else winlink_password_2 if i==2 else winlink_password_3 }}">
    </div>
    {% endfor %}
    <button type="submit">Save WinLink Settings</button>
  </form>

  <!-- ‚îÄ‚îÄ PAT Configuration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('configure_pat') }}" style="display:inline; margin-left:1rem;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit">Configure PAT</button>
  </form>

  <!-- ‚îÄ‚îÄ Exit Admin Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin') }}" style="margin-top:1rem">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button name="exit_admin" value="1">Exit Admin Mode</button>
  </form>

  <!-- ‚îÄ‚îÄ Invalidate All Sessions (danger!) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <form method="POST" action="{{ url_for('admin') }}" style="margin-top:1rem">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button name="invalidate_sessions" value="1" class="danger">
      Invalidate All Sessions
    </button>
  </form>

  <!-- ‚îÄ‚îÄ Data Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <hr>
  <h3>Data Management</h3>
  <form style="display:inline" action="{{ url_for('export_all_csv') }}" method="GET">
    <button>Export All CSVs</button>
  </form>
  {# importer disabled: use local DB functions instead #}
  {# <form style="display:inline" action="{{ url_for('import_csv') }}" method="POST" enctype="multipart/form-data">
       <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
       <input type="file" name="csv_file" accept=".csv" required>
       <button>Import CSV</button>
     </form> #}
  <br><br>
  <form method="POST"
        action="{{ url_for('reset_db') }}"
        onsubmit="return confirm('This will wipe ALL data‚Äîcontinue?')">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button class="danger">Reset Database</button>
  </form>
</div>

<script>
;(function(){
  const form  = document.getElementById('admin-form');
  const input = document.getElementById('admin-default-origin');
  let   timer;

  // ‚îÄ‚îÄ Default-Origin autosave (unchanged) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(()=> form.submit(), 800);
  });
  input.addEventListener('blur', () => {
    clearTimeout(timer);
    form.submit();
  });

  // ‚îÄ‚îÄ Embedded-Tab autosave (only when both fields filled) ‚îÄ
  const urlInput  = document.getElementById('embedded-url');
  const nameInput = document.getElementById('embedded-name');
  const distCheckbox = document.querySelector('input[name="enable_1090_distances"]');
  let   embedTimer;

  // ‚îÄ‚îÄ Prevent Enter from submitting & clearing url fields ‚îÄ
  [urlInput, nameInput].forEach(el => {
    el.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
  }); 

  function trySaveEmbedded(){
    const u = urlInput .value.trim();
    const n = nameInput.value.trim();
    if (!u || !n) return;

    // if they‚Äôre pointing at tar1090, auto-enable distances
    if (u.toLowerCase().includes('tar1090')) {
      distCheckbox.checked = true;
    } else {
      distCheckbox.checked = false;
    }

    // inject a hidden flag so the server knows to save these two
    let flag = form.querySelector('input[name="save_embedded"]');
    if (!flag){
      flag = document.createElement('input');
      flag.type  = 'hidden';
      flag.name  = 'save_embedded';
      flag.value = '1';
      form.appendChild(flag);
    }
    form.submit();
  }

  [urlInput, nameInput].forEach(el => {
    el.addEventListener('input', () => {
      clearTimeout(embedTimer);
      embedTimer = setTimeout(trySaveEmbedded, 800);
    });
    el.addEventListener('blur', trySaveEmbedded);
  });

})();
</script>
{% endblock %}
