{% extends "base.html" %}
{% block title %}WinLink Inbox{% endblock %}
{% block content %}
<h2>WinLink Inbox</h2>
<p><a href="{{ url_for('radio.radio') }}">← Back to Out-box</a></p>
<div class="container">
  <div style="display:flex; align-items:center; gap:.75rem; margin:.5rem 0 0.25rem;">
    <label style="display:flex; align-items:center; gap:.5rem; font-weight:600;">
      <input type="checkbox" id="hideParsableToggle">
      Hide parsable
    </label>
    <small style="color:#666;">(AOCT CARGO QUERY / STATUS / REPLY, AIR OPS:)</small>
    <!-- Mark-all-read (ignores parsing filter; affects cookie-based read state) -->
    <button
      id="wlMarkAllRead"
      class="btn-secondary" title="Mark entire inbox as read">Mark all read</button>
    <!-- Global Cargo Intake (aligned right) -->
    <button
      id="wlOpenGlobalIntake"
      class="btn-secondary"
      style="margin-left:auto;"
      title="Open Cargo Intake form">Cargo Intake</button>
  </div>
  <table id="wl-inbox-table" class="wg-inbox">
    <thead>
      <tr>
        <th>#</th>
        <th>To</th>
        <th>From</th>
        <th>Subject</th>
        <th>Received</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Modal for Winlink Message -->
<dialog id="winlinkMsgDialog" class="wg-modal" aria-modal="true">
  <form method="dialog" class="email-modal">
    <div id="winlinkModalDrag" class="wg-modal-header">
      <button type="button" id="btnCargoIntake" class="wg-modal-action" title="Toggle Cargo Intake form for this message">Cargo Intake</button>
      <button type="button" id="winlinkModalClose" class="wg-modal-close" aria-label="Close">✕</button>
    </div>
    <div class="wg-modal-body email-content">
      <h3 id="winlinkModalSubject" class="wg-modal-subject"></h3>
      <div style="color:#666; font-size:0.98em; margin-bottom:0.7em;">
        <span id="winlinkModalSender"></span>
        &nbsp;·&nbsp;<span id="winlinkModalTimestamp"></span>
      </div>

      <!-- Attachments list (shown when present) -->
      <div id="winlinkModalAttachments" style="display:none; margin:.25rem 0 .75rem;">
        <div style="font-weight:600; margin-bottom:.25rem;">Attachments</div>
        <ul id="winlinkModalAttachList" style="margin:0; padding-left:1.1rem;"></ul>
      </div>

      <!-- Cargo Intake Prefill (STRUCTURED) — sits ABOVE the email body; toggled by the header button -->
      <div id="wl-intake-panel" style="display:none; margin:.5rem 0 .75rem; border:1px solid #ddd; padding:.75rem; border-radius:.4rem;">
        <h4 style="margin:.25rem 0 .5rem;">Cargo Intake (WebEOC or Manual)</h4>
        <!-- WebEOC import toolbar -->
        <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.75rem;">
          <strong>Import:</strong>
          <button type="button" id="wl-intake-webeoc-from-email" class="button small" title="Parse this email (and attachments) as a WebEOC Resource Request">From this message</button>
          <button type="button" id="wl-intake-webeoc-toggle" class="button small" title="Paste WebEOC text / JSON">Paste WebEOC…</button>
        </div>
        <!-- Paste panel (hidden until toggled) -->
        <div id="wl-intake-webeoc-paste-wrap" style="display:none; margin-bottom:.75rem;">
          <textarea id="wl-intake-webeoc-text" placeholder="Paste WebEOC Resource Request text or JSON here…" style="width:100%; min-height:7rem;"></textarea>
          <div style="display:flex; justify-content:flex-end; margin-top:.4rem;">
            <button type="button" id="wl-intake-webeoc-parse" class="button">Parse</button>
          </div>
        </div>
        <!-- Manual / common fields -->
        <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem;">
          <div style="display:flex; gap:.5rem; align-items:center;">
            <label for="wl-intake-airport" style="font-weight:600;">Airport</label>
            <input id="wl-intake-airport" class="force-upper" placeholder="KAAA" style="min-width:12ch;">
          </div>
          <div style="display:flex; gap:.5rem; align-items:center;">
            <label for="wl-intake-priority" style="font-weight:600;">Priority</label>
            <select id="wl-intake-priority" data-role="priority">
              <option value="Incident Stabilization" selected>Incident Stabilization</option>
              <option value="Property Preservation">Property Preservation</option>
              <option value="Lifesaving">Lifesaving</option>
            </select>
          </div>
          <small id="wl-intake-airport-hint" style="color:#b25500; display:none;">airport not found; please enter manually</small>
        </div>
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin:.25rem 0 .5rem;">
            <label style="font-weight:600;">Items</label>
            <button type="button" id="wl-intake-add-row" class="button small">+ Add item</button>
          </div>
          <div id="wl-intake-rows" style="display:flex; flex-direction:column; gap:.35rem;"></div>
        </div>
        <div id="wl-intake-status" style="margin-top:.35rem; font-size:.92em; color:#2b6; display:none;"></div>
        <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:.6rem;">
          <button type="button" id="wl-intake-submit" class="btn-primary">Submit Cargo Intake</button>
        </div>
      </div>

      <pre id="winlinkModalBody" class="wg-modal-pre"></pre>
    </div>
  </form>
</dialog>

<!-- Global (header) Cargo Intake dialog -->
<dialog id="wlGlobalIntakeDialog" class="wg-modal" aria-modal="true">
  <form method="dialog" class="email-modal">
    <div class="wg-modal-header">
      <h3 style="margin:0;">Cargo Intake</h3>
      <button type="button" id="wlGlobalClose" class="wg-modal-close" aria-label="Close">✕</button>
    </div>
    <div class="wg-modal-body">
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.5rem;">
        <div style="display:flex; gap:.5rem; align-items:center;">
          <label for="wl-g-airport" style="font-weight:600;">Airport</label>
          <input id="wl-g-airport" class="force-upper" placeholder="KAAA" style="min-width:12ch;">
        </div>
        <div style="display:flex; gap:.5rem; align-items:center;">
          <label for="wl-g-priority" style="font-weight:600;">Priority</label>
          <select id="wl-g-priority" data-role="priority">
            <option value="Incident Stabilization" selected>Incident Stabilization</option>
            <option value="Property Preservation">Property Preservation</option>
            <option value="Lifesaving">Lifesaving</option>
          </select>
        </div>
      </div>
      <!-- WebEOC import toolbar (global) -->
      <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; margin-bottom:.75rem;">
        <strong>Import:</strong>
        <button type="button" id="wl-g-webeoc-toggle" class="button small" title="Paste WebEOC text / JSON">Paste WebEOC…</button>
      </div>
      <!-- Paste panel (hidden until toggled) -->
      <div id="wl-g-webeoc-paste-wrap" style="display:none; margin-bottom:.75rem;">
        <textarea id="wl-g-webeoc-text" placeholder="Paste WebEOC Resource Request text or JSON here…" style="width:100%; min-height:7rem;"></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:.4rem;">
          <button type="button" id="wl-g-webeoc-parse" class="button">Parse</button>
        </div>
      </div>
      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin:.25rem 0 .5rem;">
          <label style="font-weight:600;">Items</label>
          <button type="button" id="wl-g-add-row" class="button small">+ Add item</button>
        </div>
        <div id="wl-g-rows" style="display:flex; flex-direction:column; gap:.35rem;"></div>
      </div>
      <div id="wl-g-status" style="margin-top:.35rem; font-size:.92em; color:#2b6; display:none;"></div>
      <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:.6rem;">
        <button type="button" id="wl-g-submit" class="btn-primary">Submit Cargo Intake</button>
      </div>
    </div>
  </form>
</dialog>

<script>
/* ───── Read-state cookie helpers (range-encoded) ───────────────── */
const WL_COOKIE = 'winlink_emails_read';
function getCookie(name){
  const m = document.cookie.match(new RegExp('(?:^|;\\s*)' + name.replace(/[.*+?^${}()|[\\]\\\\]/g,'\\$&') + '=([^;]*)'));
  return m ? decodeURIComponent(m[1]) : '';
}
function setCookie(name, value){
  document.cookie = name + '=' + encodeURIComponent(value) + '; Max-Age=31536000; Path=/; SameSite=Lax';
}
function mergeRanges(ranges){
  if (!ranges.length) return [];
  ranges.sort((a,b)=> (a[0]-b[0]) || (a[1]-b[1]));
  const out=[ranges[0].slice()];
  for (let i=1;i<ranges.length;i++){
    const [s,e]=ranges[i], last=out[out.length-1];
    if (s<=last[1]+1) last[1]=Math.max(last[1],e);
    else out.push([s,e]);
  }
  return out;
}
function parseRanges(str){
  if (!str) return [];
  const parts=str.split(',').map(s=>s.trim()).filter(Boolean);
  const ranges=[];
  for(const p of parts){
    if (/^\d+$/.test(p)){ const v=+p; ranges.push([v,v]); }
    else{
      const m=p.match(/^(\d+)-(\d+)$/);
      if (m){ const a=+m[1], b=+m[2]; ranges.push([Math.min(a,b), Math.max(a,b)]); }
    }
  }
  return mergeRanges(ranges);
}
function encodeRanges(ranges){
  return ranges.map(([s,e])=> s===e ? String(s) : `${s}-${e}`).join(',');
}
function contains(ranges, id){
  id = +id; return ranges.some(([s,e]) => id>=s && id<=e);
}
function addId(ranges, id){
  id = +id; return mergeRanges([...ranges, [id,id]]);
}
function markRead(id, row){
  const ranges = parseRanges(getCookie(WL_COOKIE));
  const next   = encodeRanges(addId(ranges, id));
  setCookie(WL_COOKIE, next);
  if (row) row.classList.add('read');
}
function applyReadState(){
  const ranges = parseRanges(getCookie(WL_COOKIE) || '');
  document.querySelectorAll('#wl-inbox-table tbody tr[data-id]').forEach(tr=>{
    const id = +tr.getAttribute('data-id');
    if (contains(ranges, id)) tr.classList.add('read');
    else tr.classList.remove('read');
  });
}

/* Mark-all-read across filters:
   - Saves current 'hide_parsable' cookie
   - Fetches IDs with hide_parsable=no and hide_parsable=yes
   - Unions IDs, writes WL read cookie, restores filter, refreshes table */
async function markAllReadAcrossFilters(){
  const prev = getCookie('hide_parsable') || 'no';
  async function fetchIdsFor(flag){
    // Flip cookie so backend (if it uses it) returns desired set
    setCookie('hide_parsable', flag);
    const r = await fetch('/winlink/inbox.json', { cache:'no-store', credentials:'same-origin' });
    const arr = await r.json();
    return Array.isArray(arr) ? arr.map(m => +m.id).filter(Number.isFinite) : [];
  }
  const ids = new Set();
  try {
    for (const id of await fetchIdsFor('no')) ids.add(id);
  } catch(_) {}
  try {
    for (const id of await fetchIdsFor('yes')) ids.add(id);
  } catch(_) {}
  // Restore user preference
  setCookie('hide_parsable', prev);
  // Merge into WL read-cookie
  let ranges = parseRanges(getCookie(WL_COOKIE) || '');
  for (const id of ids) { ranges = addId(ranges, id); }
  setCookie(WL_COOKIE, encodeRanges(ranges));
  // Update UI and reload current view
  applyReadState();
  try { await loadInbox(); } catch(_){}
}

/* ───── Inbox loading ───────────────────────────────────────────── */
let wlMsgs = [];
async function loadInbox() {
  const resp = await fetch('/winlink/inbox.json', { cache:'no-store', credentials:'same-origin' });
  wlMsgs = await resp.json();
  const tb = document.querySelector('#wl-inbox-table tbody');
  tb.innerHTML = wlMsgs.map(m=>`
    <tr data-id="${m.id}">
      <td>${m.id}</td>
      <td>${m.callsign}</td>
      <td>${m.sender || '—'}</td>
      <td>
        <span class="unread-dot" title="Unread"></span>
        <a href="#" class="winlink-open-msg" data-msg-id="${m.id}">
          ${m.subject ? m.subject.replace(/</g,"&lt;").replace(/>/g,"&gt;") : '—'}
        </a>
        ${(+m.attach_count>0 || +m.has_attachments===1) ? ` <span title="Attachments">📎 (${m.attach_count||0})</span>` : ''}
      </td>
      <td>${m.timestamp}</td>
    </tr>
  `).join('');
  applyReadState();
}
loadInbox();
setInterval(loadInbox, 30000);

/* ───── Shared helpers ─────────────────────────────────────────── */
function dlgOpen(d){ if (d && d.showModal) d.showModal(); else d?.setAttribute('open','open'); }
function dlgClose(d){ if (d && d.close) d.close(); else d?.removeAttribute('open'); }
function centerDialogEl(d){
  if (!d) return;
  d.style.left = '50%';
  d.style.top = '50%';
  d.style.transform = 'translate(-50%, -50%)';
}
function canonCall(s){
  return (String(s||'').split(/[<\s@]/)[0] || '').trim().toUpperCase();
}
function canonAirport(s){
  const v = String(s||'').trim().toUpperCase();
  if (v.length===4 && (v.startsWith('K')||v.startsWith('C'))) return v;
  if (v.length===3) return 'K' + v;
  return v;
}
function isLikelyIcao4(s){
  const v = String(s||'').trim().toUpperCase();
  // Basic ICAO-4 heuristic: 4 alphanum, starts with a letter (K/ C ok, but we allow any A–Z first)
  return /^[A-Z][A-Z0-9]{3}$/.test(v);
}
function showIcaoHint(scopeEl, ok){
  const hint = scopeEl.querySelector('#' + (scopeEl.id === 'wlGlobalIntakeDialog' ? 'wl-g-airport-hint' : 'wl-intake-airport-hint'));
  if (hint){
    hint.textContent = ok ? '' : "That doesn't look like an ICAO-4 code (e.g., KELN). You can still submit, but Ramp will show the label as typed.";
    hint.style.display = ok ? 'none' : '';
  }
}
function toPounds(val, unit){
  const v = Number(val)||0;
  const u = String(unit||'lb').toLowerCase();
  if (u === 'kg') return v * 2.20462;
  if (u === 'oz') return v / 16.0;
  return v;
}
function addRow(container, def){
  const row = document.createElement('div');
  row.className = 'wl-intake-row';
  row.style.display = 'flex';
  row.style.alignItems = 'center';
  row.style.gap = '.5rem';
  row.innerHTML = `
    <input class="wl-name" placeholder="item (e.g., water)" style="flex:1 1 40%;">
    <input class="wl-weight" type="number" step="0.1" min="0.1" placeholder="0" style="flex:0 0 25%;" inputmode="decimal">
    <select class="wl-unit" style="flex:0 0 20%;">
      <option value="lb">lb</option>
      <option value="kg">kg</option>
      <option value="oz">oz</option>
    </select>
    <button type="button" class="button small wl-del" title="Remove">×</button>
  `;
  container.appendChild(row);
  if (def){
    row.querySelector('.wl-name').value = def.name || '';
    row.querySelector('.wl-weight').value = def.value != null ? String(def.value) : '';
    row.querySelector('.wl-unit').value = (def.unit || 'lb').toLowerCase();
  }
  row.querySelector('.wl-del').addEventListener('click', ()=> {
    row.remove();
    if (!container.querySelector('.wl-intake-row')) addRow(container);
  });
  return row;
}
function resetRows(container){ container.innerHTML = ''; }

// Attach CSRF / requested-with headers to POSTs (mirrors pattern used elsewhere)
function xhrHeaders(extra={}){
  const token = document.querySelector('input[name="csrf_token"]')?.value || '';
  const h = {'X-Requested-With':'XMLHttpRequest'};
  if (token){
    h['X-CSRFToken'] = token;
    h['X-CSRF-Token'] = token;
  }
  for (const k in extra) h[k] = extra[k];
  return h;
}

function gatherItems(container){
  const rows = Array.from(container.querySelectorAll('.wl-intake-row'));
  const items = [];
  for (const r of rows){
    const name = (r.querySelector('.wl-name')?.value || '').trim();
    const val  = parseFloat(r.querySelector('.wl-weight')?.value || '0');
    const unit = (r.querySelector('.wl-unit')?.value || 'lb').toLowerCase();
    const lbs  = toPounds(val, unit);
    if (!name || !(lbs > 0)) continue;
    items.push({ name, weight_lb: Math.round(lbs*10)/10 });
  }
  return items;
}

// Hard-stop validation: every non-blank row must have a name AND a positive weight.
function validateIntakeRows(container){
  const rows = Array.from(container.querySelectorAll('.wl-intake-row'));
  let firstBad = null;
  for (const r of rows){
    const nameEl = r.querySelector('.wl-name');
    const valEl  = r.querySelector('.wl-weight');
    const unitEl = r.querySelector('.wl-unit');
    const name   = (nameEl?.value || '').trim();
    const raw    = (valEl?.value ?? '');
    const hasAny = !!name || (raw !== '');
    if (!hasAny) continue; // allow fully-blank rows
    // Clear previous messages
    nameEl?.setCustomValidity?.('');
    valEl?.setCustomValidity?.('');
    const val = Number(raw);
    const lbs = toPounds(val, (unitEl?.value || 'lb').toLowerCase());
    if (!name){
      nameEl?.setCustomValidity?.('Enter an item name.');
      firstBad = firstBad || nameEl;
    }
    if (!Number.isFinite(lbs) || lbs <= 0){
      valEl?.setCustomValidity?.('Enter a positive weight.');
      firstBad = firstBad || valEl;
    }
  }
  if (firstBad?.reportValidity){
    firstBad.reportValidity();
    firstBad.focus?.();
    return false;
  }
  return true;
}
async function submitIntake(scopeEl, opts){
  const apEl = scopeEl.querySelector('input.force-upper');
  const rowsEl = scopeEl.querySelector('#' + (scopeEl.id === 'wlGlobalIntakeDialog' ? 'wl-g-rows' : 'wl-intake-rows'));
  const statusEl = scopeEl.querySelector('#' + (scopeEl.id === 'wlGlobalIntakeDialog' ? 'wl-g-status' : 'wl-intake-status'));
  const prEl = scopeEl.querySelector('select[data-role="priority"]');
  const airportRaw = apEl?.value || '';
  const airport = canonAirport(airportRaw);
  // Strict row validation first (cannot be bypassed by ICAO confirm)
  if (!validateIntakeRows(rowsEl)) return;
  const items = gatherItems(rowsEl);
  if (!airport){ alert('Airport is required.'); apEl?.focus(); return; }
  if (!items.length){ alert('Add at least one item with a positive weight.'); return; }
  // ICAO-4 confirmation if it doesn't look like one
  const looksIcao = isLikelyIcao4(airport);
  showIcaoHint(scopeEl, looksIcao);
  if (!looksIcao){
    const msg = `"${airportRaw}" doesn't look like an ICAO-4 code (e.g., KELN).\n\nSubmit anyway?`;
    if (!confirm(msg)) { apEl?.focus(); return; }
  }
  const payload = { airport, items, priority: (prEl?.value || '') };
  if (opts?.source_email_id) payload.source_email_id = String(opts.source_email_id);
  const resp = await fetch('/inventory/requests/intake', {
    method:'POST',
    headers: xhrHeaders({'Content-Type':'application/json'}),
    body: JSON.stringify(payload)
  });
  let j = {};
  try { j = await resp.json(); } catch(_){}
  if (!resp.ok || !j.ok){
    alert(j.error || 'Failed to save cargo intake.');
    return;
  }
  // Inline, non-blocking status update instead of alert()
  if (statusEl){
    statusEl.textContent = `Saved. ${(j.added||items.length)} item(s) recorded for ${airport}.`;
    statusEl.style.display = '';
    setTimeout(()=>{ statusEl.style.display='none'; }, 3500);
  }
  // Clear rows for another entry, keep scope open
  resetRows(rowsEl);
  addRow(rowsEl);
  // Clear any WebEOC paste and hide paste panel(s) in this scope
  const inlinePasteWrap = scopeEl.querySelector('#wl-intake-webeoc-paste-wrap');
  const inlinePasteArea = scopeEl.querySelector('#wl-intake-webeoc-text');
  const globalPasteWrap = scopeEl.querySelector('#wl-g-webeoc-paste-wrap');
  const globalPasteArea = scopeEl.querySelector('#wl-g-webeoc-text');
  if (inlinePasteArea) inlinePasteArea.value = '';
  if (globalPasteArea) globalPasteArea.value = '';
  if (inlinePasteWrap) inlinePasteWrap.style.display = 'none';
  if (globalPasteWrap) globalPasteWrap.style.display = 'none';
  apEl.focus();
}

/* ───── Page wiring ─────────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', function () {
  // “Hide parsable” toggle
  const hideToggle = document.getElementById('hideParsableToggle');
  const initial = (getCookie('hide_parsable') || ('{{ "yes" if hide_parsable else "no" }}')) === 'yes';
  hideToggle.checked = initial;
  hideToggle.addEventListener('change', () => {
    setCookie('hide_parsable', hideToggle.checked ? 'yes' : 'no');
    const url = new URL(location.href);
    url.searchParams.set('hide_parsable', hideToggle.checked ? '1' : '0');
    history.replaceState({}, '', url);
    loadInbox();
  });

  // “Mark all read” — covers visible and hidden (parsable) emails
  const markAllBtn = document.getElementById('wlMarkAllRead');
  markAllBtn?.addEventListener('click', async () => {
    const origText = markAllBtn.textContent;
    markAllBtn.disabled = true;
    markAllBtn.textContent = 'Marking…';
    try { await markAllReadAcrossFilters(); }
    finally {
      markAllBtn.disabled = false;
      markAllBtn.textContent = origText;
    }
  });

  // Modal controls (message)
  const dlg      = document.getElementById('winlinkMsgDialog');
  const subj     = document.getElementById('winlinkModalSubject');
  const body     = document.getElementById('winlinkModalBody');
  const closeBtn = document.getElementById('winlinkModalClose');
  const dragBar  = document.getElementById('winlinkModalDrag');
  const sender   = document.getElementById('winlinkModalSender');
  const ts       = document.getElementById('winlinkModalTimestamp');
  const attWrap  = document.getElementById('winlinkModalAttachments');
  const attList  = document.getElementById('winlinkModalAttachList');

  // Inline intake elements
  const panel       = document.getElementById('wl-intake-panel');
  const apInput     = document.getElementById('wl-intake-airport');
  const apHint      = document.getElementById('wl-intake-airport-hint');
  const rowsWrap    = document.getElementById('wl-intake-rows');
  const addRowBtn   = document.getElementById('wl-intake-add-row');
  const submitBtn   = document.getElementById('wl-intake-submit');
  const prSelect    = document.getElementById('wl-intake-priority');
  const pasteWrap   = document.getElementById('wl-intake-webeoc-paste-wrap');
  const pasteArea   = document.getElementById('wl-intake-webeoc-text');
  // Validate ICAO-ish on blur (inline)
  apInput?.addEventListener('blur', () => {
    const ap = canonAirport(apInput.value||'');
    showIcaoHint(dlg, isLikelyIcao4(ap));
  });

  function resetInlineIntake() {
    panel.style.display = 'none';
    rowsWrap.innerHTML = '';
    apInput.value = '';
    apHint.style.display = 'none';
    pasteWrap.style.display = 'none';
  }

  async function openMsgModal(msg) {
    subj.textContent   = msg.subject || '(no subject)';
    body.textContent   = msg.body || '(No message body)';
    sender.textContent = msg.sender || '';
    ts.textContent     = msg.timestamp || '';
    // Populate attachments (fresh each open)
    attWrap.style.display = 'none';
    attList.innerHTML = '';
    try{
      const r = await fetch(`/winlink/attachment/${encodeURIComponent(msg.id)}/`, { cache:'no-store', credentials:'same-origin' });
      if (r.ok){
        const j = await r.json();
        const files = Array.isArray(j.files) ? j.files : [];
        if (files.length){
          attList.innerHTML = files.map(f=>{
            const name = (f.name||'').replace(/"/g,'&quot;');
            const size = f.size ? ` (${f.size} bytes)` : '';
            const href = `/winlink/attachment/${encodeURIComponent(msg.id)}/${encodeURIComponent(f.name)}`;
            return `<li><a href="${href}" rel="noopener">${name}</a>${size}</li>`;
          }).join('');
          attWrap.style.display = '';
        }
      }
    }catch(_){}
    dlg.style.left = '50%';
    dlg.style.top  = '50%';
    dlg.style.transform = 'translate(-50%, -50%)';
    resetInlineIntake(); // collapsed by default each time
    if (dlg.showModal) dlg.showModal(); else dlg.setAttribute('open', 'open');
    window.__wlModalOpen = true;
  }

  function closeModal() {
    if (dlg.close) dlg.close(); else dlg.removeAttribute('open');
    window.__wlModalOpen = false;
  }

  closeBtn.addEventListener('click', closeModal);
  dlg.addEventListener('cancel', function(e){ e.preventDefault(); closeModal(); });

  // Open on subject click
  document.getElementById('wl-inbox-table').addEventListener('click', function(ev){
    const link = ev.target.closest('a.winlink-open-msg');
    if (!link) return;
    ev.preventDefault();
    const msg = wlMsgs.find(m => String(m.id) === String(link.dataset.msgId));
    if (msg) {
      openMsgModal(msg);
      window.__wlCurrentMsg = msg;  // cache for Cargo Intake prefill
      const row = link.closest('tr[data-id]');
      markRead(msg.id, row);
    }
  });

  // Optional: Click outside to close
  dlg.addEventListener('click', function(ev) {
    if (ev.target === this) closeModal();
  });

  // Esc key closes (if dialog unsupported)
  document.addEventListener('keydown', function(ev){
    if ((ev.key === 'Escape' || ev.keyCode === 27) && (dlg.open || dlg.hasAttribute('open'))) {
      closeModal();
    }
  });

  // Draggable logic
  (function enableDrag() {
    let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
    dragBar.addEventListener('mousedown', (ev) => {
      const box = dlg.getBoundingClientRect();
      dlg.style.left = box.left + 'px';
      dlg.style.top  = box.top  + 'px';
      dlg.style.transform = '';
      dragging = true;
      startLeft = box.left; startTop = box.top;
      startX = ev.clientX; startY = ev.clientY;
      ev.preventDefault();
    });
    window.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      dlg.style.left = (startLeft + dx) + 'px';
      dlg.style.top  = (startTop  + dy) + 'px';
    });
    window.addEventListener('mouseup', () => { dragging = false; });
  })();

  applyReadState();

  // ───── Reverse mapping for airport prefill ─────
  let WL_MAPPINGS = null; // { airport_to_call:{}, call_to_airport:{} }
  async function loadMappings(){
    if (WL_MAPPINGS) return WL_MAPPINGS;
    try{
      const r = await fetch('/winlink/mappings.json', { headers: { 'X-Requested-With':'XMLHttpRequest' } });
      if (r.ok) WL_MAPPINGS = await r.json();
    }catch(_){}
    WL_MAPPINGS = WL_MAPPINGS || { airport_to_call:{}, call_to_airport:{} };
    return WL_MAPPINGS;
  }
  function guessAirportFromSender(sender, maps){
    const call = canonCall(sender);
    const m = (maps?.call_to_airport || {});
    if (call && m[call]) return { airport: m[call], found:true };
    const lo = call.toLowerCase();
    for (const k of Object.keys(m)){
      if (k === call || k.toLowerCase() === lo) return { airport: m[k], found:true };
    }
    return { airport:'', found:false };
  }
  // Extractor: "<name>: <num> [lb|kg|oz]"
  function extractStructuredItemsFromBody(txt){
    const out = [];
    const lines = String(txt||'').split(/\r?\n/);
    for (const ln of lines){
      const m = ln.match(/^\s*([A-Za-z][\w\s\-\/]{0,80}?)\s*:\s*(\d+(?:\.\d+)?)\s*(lb|lbs|kg|oz)?\s*$/i);
      if (!m) continue;
      const name = m[1].trim().replace(/\s+/g,' ');
      const val  = parseFloat(m[2]);
      const unitRaw = (m[3]||'lb').toLowerCase();
      // map 'lbs' -> 'lb' to match the <select> options
      const unit = unitRaw === 'lbs' ? 'lb' : unitRaw;
      if (!name || !Number.isFinite(val)) continue;
      out.push({ name, value: val, unit });
    }
    return out;
  }

  // ───── Inline intake toggle + submit ─────
  const intakeBtn = document.getElementById('btnCargoIntake');
  intakeBtn?.addEventListener('click', async () => {
    const msg = window.__wlCurrentMsg || {};
    // Toggle
    if (panel.style.display === 'none' || panel.style.display === ''){
      const maps = await loadMappings();
      const { airport, found } = guessAirportFromSender(msg.sender || msg.callsign || '', maps);
      apInput.value = airport || '';
      apHint.style.display = found ? 'none' : '';
      resetRows(rowsWrap);
      const rows = extractStructuredItemsFromBody(msg.body || '');
      if (rows.length){
        for (const r of rows) addRow(rowsWrap, r);
      } else {
        addRow(rowsWrap);
      }
      panel.style.display = '';
      setTimeout(()=> (airport && found ? rowsWrap.querySelector('.wl-name') : apInput)?.focus(), 0);
    } else {
      panel.style.display = 'none';
    }
  });
  addRowBtn?.addEventListener('click', ()=> addRow(rowsWrap));
  submitBtn?.addEventListener('click', ()=> submitIntake(panel, { source_email_id: (window.__wlCurrentMsg?.id || null) }));

  // WebEOC import actions (inline)
  const weFromEmailBtn = document.getElementById('wl-intake-webeoc-from-email');
  const weToggleBtn    = document.getElementById('wl-intake-webeoc-toggle');
  const weParseBtn     = document.getElementById('wl-intake-webeoc-parse');

  weToggleBtn?.addEventListener('click', () => {
    pasteWrap.style.display = (pasteWrap.style.display === 'none' || !pasteWrap.style.display) ? '' : 'none';
    if (pasteWrap.style.display !== 'none') pasteArea.focus();
  });

  // Helpers for hydrating from parsed WebEOC payloads
  function setPriorityOption(select, value){
    if (!select) return;
    const norm = s => String(s||'').trim().toLowerCase().replace(/[^a-z]/g,'');
    const want = norm(value);
    for (const opt of Array.from(select.options)){
      const ov = norm(opt.value);
      const ot = norm(opt.textContent);
      if (want && (ov === want || ot === want)){ select.value = opt.value; return; }
    }
  }
  // Fill the intake UI within a given scope (inline dialog or global dialog)
  function hydrateIntakeInScope(scopeEl, parsed){
    if (!scopeEl || !parsed) return;
    const isGlobal = scopeEl.id === 'wlGlobalIntakeDialog';
    const apEl  = scopeEl.querySelector('#' + (isGlobal ? 'wl-g-airport' : 'wl-intake-airport'));
    const prEl  = scopeEl.querySelector('#' + (isGlobal ? 'wl-g-priority' : 'wl-intake-priority'));
    const rowsEl= scopeEl.querySelector('#' + (isGlobal ? 'wl-g-rows' : 'wl-intake-rows'));
    if (parsed.airport && apEl) apEl.value = canonAirport(parsed.airport);
    if (parsed.priority && prEl) setPriorityOption(prEl, parsed.priority);
    if (rowsEl){
      resetRows(rowsEl);
      const items = Array.isArray(parsed.items) ? parsed.items : [];
      if (items.length){
        for (const it of items){
          addRow(rowsEl, { name: it.name || '', value: it.weight_lb || it.weight || 0, unit: 'lb' });
        }
      } else {
        addRow(rowsEl);
      }
    }
    // Ensure the inline panel is visible if we're in the message modal
    if (!isGlobal && panel) panel.style.display = '';
  }

  weFromEmailBtn?.addEventListener('click', async () => {
    const msg = window.__wlCurrentMsg || {};
    if (!msg?.id) { alert('Open a message first.'); return; }
    try{
      const r = await fetch('/webeoc/import_from_email', {
        method:'POST',
        headers: xhrHeaders({'Content-Type':'application/json'}),
        body: JSON.stringify({ email_id: String(msg.id) })
      });
      const j = await r.json();
      if (!r.ok || !j?.ok) throw new Error(j?.error || 'Import failed');
      hydrateIntakeInScope(dlg, j.payload || j);
    } catch(e){ alert(e?.message || 'Failed to import from WebEOC.'); }
  });
  weParseBtn?.addEventListener('click', async () => {
    const txt = (pasteArea?.value || '').trim();
    if (!txt) { alert('Paste WebEOC content first.'); return; }
    try{
      const r = await fetch('/webeoc/import_from_text', {
        method:'POST',
        headers: xhrHeaders({'Content-Type':'application/json'}),
        body: JSON.stringify({ text: txt })
      });
      const j = await r.json();
      if (!r.ok || !j?.ok) throw new Error(j?.error || 'Parse failed');
      hydrateIntakeInScope(dlg, j.payload || j);
    } catch(e){ alert(e?.message || 'Failed to parse WebEOC text.'); }
  });

  // ───── Global (header) Cargo Intake modal wiring ─────
  const globalIntakeBtn = document.getElementById('wlOpenGlobalIntake');
  const gDlg = document.getElementById('wlGlobalIntakeDialog');
  const gClose = document.getElementById('wlGlobalClose');
  const gAirport = document.getElementById('wl-g-airport');
  const gRows = document.getElementById('wl-g-rows');
  const gPriority = document.getElementById('wl-g-priority');
  const gAddRow = document.getElementById('wl-g-add-row');
  const gSubmit = document.getElementById('wl-g-submit');
  const gStatus = document.getElementById('wl-g-status');
  const gPasteWrap = document.getElementById('wl-g-webeoc-paste-wrap');
  const gPasteArea = document.getElementById('wl-g-webeoc-text');
  const gToggleBtn = document.getElementById('wl-g-webeoc-toggle');
  const gParseBtn  = document.getElementById('wl-g-webeoc-parse');
  // Validate ICAO-ish on blur (global)
  gAirport?.addEventListener('blur', () => {
    const ap = canonAirport(gAirport.value||'');
    showIcaoHint(gDlg, isLikelyIcao4(ap));
  });

  globalIntakeBtn?.addEventListener('click', () => {
    resetRows(gRows); addRow(gRows); // start with one empty row
    gAirport.value = '';
    gPriority.value = 'Incident Stabilization';
    gStatus.style.display = 'none';
    if (gPasteWrap) gPasteWrap.style.display = 'none';
    // Center like the message modal and open
    centerDialogEl(gDlg);
    dlgOpen(gDlg);
  });
  gClose?.addEventListener('click', ()=> dlgClose(gDlg));
  gAddRow?.addEventListener('click', ()=> addRow(gRows));
  gSubmit?.addEventListener('click', ()=> submitIntake(gDlg));

  // Global: Paste WebEOC… toggle + parse
  gToggleBtn?.addEventListener('click', () => {
    if (!gPasteWrap) return;
    gPasteWrap.style.display = (gPasteWrap.style.display === 'none' || !gPasteWrap.style.display) ? '' : 'none';
    if (gPasteWrap.style.display !== 'none' && gPasteArea) gPasteArea.focus();
  });
  gParseBtn?.addEventListener('click', async () => {
    const txt = (gPasteArea?.value || '').trim();
    if (!txt) { alert('Paste WebEOC content first.'); return; }
    try{
      const r = await fetch('/webeoc/import_from_text', {
        method:'POST',
        headers: xhrHeaders({'Content-Type':'application/json'}),
        body: JSON.stringify({ text: txt })
      });
      const j = await r.json();
      if (!r.ok || !j?.ok) throw new Error(j?.error || 'Parse failed');
      hydrateIntakeInScope(gDlg, j.payload || j);
    } catch(e){ alert(e?.message || 'Failed to parse WebEOC text.'); }
  });

  // Make Global Intake dialog draggable using its header (parity with message modal)
  (function enableGlobalIntakeDrag(){
    if (!gDlg) return;
    const handle = gDlg.querySelector('.wg-modal-header');
    if (!handle) return;
    let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;
    handle.addEventListener('mousedown', (ev) => {
      const box = gDlg.getBoundingClientRect();
      // convert from centered transform to absolute px before dragging
      gDlg.style.left = box.left + 'px';
      gDlg.style.top  = box.top  + 'px';
      gDlg.style.transform = '';
      dragging = true;
      startLeft = box.left; startTop = box.top;
      startX = ev.clientX; startY = ev.clientY;
      ev.preventDefault();
    });
    window.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      gDlg.style.left = (startLeft + dx) + 'px';
      gDlg.style.top  = (startTop  + dy) + 'px';
    });
    window.addEventListener('mouseup', () => { dragging = false; });
  })();
});
</script>
{% endblock %}
