{% extends "base.html" %}
{% block title %}Setup – Aircraft Ops{% endblock %}

{% block content %}
{% if not wizard %}
  <div class="container">
    <h2>Set App Password</h2>
    <form method="POST" style="max-width: 420px; margin: 0 auto;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label for="pw">Password:</label>
      <input id="pw" type="password" name="password" required>
      <label for="pw2">Confirm:</label>
      <input id="pw2" type="password" name="confirm" required>
      <button type="submit">Save Password</button>
    </form>
  </div>
{% else %}
  <div class="container preferences">
    <h2>Setup Wizard</h2>
    <!-- IMPORTANT: id now matches CSS: #setup-wizard-form -->
    <form id="setup-wizard-form" method="POST" action="{{ url_for('auth.setup_wizard') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <h3>Defaults</h3>
      <label for="default-origin">Default Origin (required):</label>
      <input id="default-origin"
             name="default_origin"
             value="{{ default_origin }}"
             placeholder="e.g. KSEA or SEA" required
             oninput="this.value=this.value.toUpperCase()"
             style="text-transform:uppercase;">

      <label for="mission-number">Mission Number (optional):</label>
      <input id="mission-number"
             name="mission_number"
             value="{{ mission_number }}"
             placeholder="e.g. 24-ALPHA"
             oninput="this.value=this.value.toUpperCase()">

      <label for="cs">Your Callsign (optional):</label>
      <input id="cs"
             name="operator_call"
             value="{{ operator_call }}"
             oninput="this.value=this.value.toUpperCase()">

      <hr>
      <h3>Airport → WinLink Callsign Mappings (optional)</h3>

      <!-- This wrapper + class makes the section span both grid columns -->
      <div class="wizard-mapping-section">
        <div id="airport-mappings">
          {% for code, cs in airport_mappings %}
            <div class="mapping-row">
              <input name="airport_codes[]" class="map-airport"
                     value="{{ code }}" placeholder="Airport ICAO or FAA"
                     oninput="this.value=this.value.toUpperCase()">
              <input name="winlink_callsigns[]" class="map-callsign"
                     value="{{ cs }}" placeholder="WinLink Callsign"
                     oninput="this.value=this.value.toUpperCase()">
              <button type="button" class="remove-mapping" title="Remove row">−</button>
            </div>
          {% endfor %}
          {% if not airport_mappings %}
            <div class="mapping-row">
              <input name="airport_codes[]" class="map-airport"
                     placeholder="Airport ICAO or FAA"
                     oninput="this.value=this.value.toUpperCase()">
              <input name="winlink_callsigns[]" class="map-callsign"
                     placeholder="WinLink Callsign"
                     oninput="this.value=this.value.toUpperCase()">
              <button type="button" class="remove-mapping" title="Remove row">−</button>
            </div>
          {% endif %}
        </div>

        <!-- Button class matches CSS: .wizard-add-btn goes full width, below -->
        <button type="button" id="add-mapping" class="block-btn wizard-add-btn">＋ Add mapping</button>
      </div>

      <h3 style="margin-top:2em;">WinLink CC Addresses (optional)</h3>
      <div class="cc-row">
        {% for idx in [1,2,3] %}
          <input name="winlink_cc_{{ idx }}" class="map-cc"
                 value="{{ (winlink_cc_1,winlink_cc_2,winlink_cc_3)[idx-1] }}"
                 placeholder="CC Address #{{ idx }}"
                 oninput="this.value=this.value.toUpperCase()">
        {% endfor %}
      </div>
      <div class="cc-row" style="margin-top:.5rem;">
        <strong>Include CCs on AOCT messages:</strong>
      </div>
      <div class="cc-row" style="display:grid;grid-template-columns: minmax(150px,240px) minmax(70px,120px);gap:.5rem;align-items:center;">
        <label for="aoct_cc_query">• Cargo <em>Query</em> sends:</label>
        <select id="aoct_cc_query" name="aoct_cc_query">
          <option value="no"  {% if aoct_cc_query!='yes' %}selected{% endif %}>No</option>
          <option value="yes" {% if aoct_cc_query=='yes' %}selected{% endif %}>Yes</option>
        </select>
        <label for="aoct_cc_reply">• Cargo <em>Reply</em> sends:</label>
        <select id="aoct_cc_reply" name="aoct_cc_reply">
          <option value="no"  {% if aoct_cc_reply!='yes' %}selected{% endif %}>No</option>
          <option value="yes" {% if aoct_cc_reply=='yes' %}selected{% endif %}>Yes</option>
        </select>
        <label for="aoct_cc_broadcast">• Cargo <em>Broadcast</em> sends:</label>
        <select id="aoct_cc_broadcast" name="aoct_cc_broadcast">
          <option value="no"  {% if aoct_cc_broadcast!='yes' %}selected{% endif %}>No</option>
          <option value="yes" {% if aoct_cc_broadcast=='yes' %}selected{% endif %}>Yes</option>
        </select>
      </div>

      <button type="submit" class="save-mappings-btn" style="margin-top:12px;">✅ Save & Finish</button>
      <p style="margin-top:1rem;color:#666;">Further settings live in <strong>Admin Settings</strong> (unlock via passphrase).</p>
    </form>
  </div>

  <script>
  (function(){
    const addBtn    = document.getElementById('add-mapping');
    const container = document.getElementById('airport-mappings');
    if (!addBtn || !container) return;

    addBtn.addEventListener('click', () => {
      const template = container.querySelector('.mapping-row').cloneNode(true);
      template.querySelectorAll('input').forEach(i => i.value = '');
      container.appendChild(template);
    });

    container.addEventListener('click', (e) => {
      if (e.target.matches('.remove-mapping') && container.children.length > 1) {
        e.target.closest('.mapping-row').remove();
      }
    });
  })();
  </script>
{% endif %}
{% endblock %}
