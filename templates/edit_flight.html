{% extends "base.html" %}
{% block title %}Edit Flight {{ flight['id'] }} ‚Äì Aircraft Ops{% endblock %}

{% block content %}
  <button onclick="location.href='{{ url_for('core.dashboard') }}'" style="margin-bottom:1rem">
    ‚Üê Back to Dashboard
  </button>

  <h2>Edit Flight {{ flight['tail_number'] }}</h2>

  <!-- Action bar: Print Labels -->
  <div class="action-bar"
       style="display:flex; gap:.5rem; align-items:center; justify-content:flex-end; margin:.5rem 0 1rem;">
    <a href="/docs/labels/cargo?flight_id={{ flight['id'] }}&scope=all"
       class="btn-secondary"
       target="_blank" rel="noopener"
       title="Print cargo labels">üì¶ Print Labels</a>
  </div>

  <div class="ramp-form-container">
    <form method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      {% for field,label in [
            ('direction','Direction'),
            ('tail_number','Tail Number'),
            ('pilot_name','Pilot Name'),
            ('pax_count','PAX #'),
            ('airfield_takeoff','Origin'),
            ('takeoff_time','Departure HHMM'),
            ('airfield_landing','Destination'),
            ('eta','ETA / ARR HHMM'),
            ('cargo_type','Cargo Type'),
            ('cargo_weight','Cargo Weight'),
            ('remarks','Remarks')
        ] %}
        {# Direction switch uses radio-toggle, others are straight inputs #}
        {% if field=='direction' %}
          <label>{{ label }}</label>
          <div class="radio-toggle">
            <input type="radio" id="dir-out-{{flight.id}}" name="direction" value="outbound" {% if flight['direction']=='outbound' %}checked{% endif %}>
            <label for="dir-out-{{flight.id}}">Outbound</label>
            <input type="radio" id="dir-in-{{flight.id}}" name="direction" value="inbound" {% if flight['direction']=='inbound' %}checked{% endif %}>
            <label for="dir-in-{{flight.id}}">Inbound</label>
          </div>
        {% else %}
          <label for="{{ field }}">{{ label }}</label>
          <input id="{{ field }}" name="{{ field }}"
                 {% if field=='cargo_weight' %}style="min-width:12ch"{% endif %}
                 class="{% if field in ['tail_number','airfield_takeoff','airfield_landing'] %}force-upper{% endif %}"
                 value="{{ flight.get(field,'') }}">
        {% endif %}
      {% endfor %}

      <label><input type="checkbox" name="complete"
             {% if flight.get('complete') %}checked{% endif %}> Mark Complete</label>

      <button type="submit">Save Changes</button>
    </form>

    <form method="POST"
          action="{{ url_for('ramp.delete_flight', fid=flight['id']) }}"
          onsubmit="return confirm('Really delete flight {{flight.id}}?');"
          style="margin-top:1rem">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="danger">Delete Flight</button>
    </form>
  </div>

<script>
// Prev-max cargo hint (Edit Flight)
(function(){
  function findTailInput(){
    return document.querySelector('#tail_number')
        || document.querySelector('#tail')
        || document.querySelector('input[name="tail_number"]')
        || document.querySelector('input[name="tail"]');
  }
  function findCargoLabel(){
    let lab = document.querySelector('label[for="cargo_weight"]')
           || document.querySelector('label[for="cargo_weight_real"]');
    if (!lab) {
      const inp = document.querySelector('#cargo_weight')
               || document.querySelector('[name="cargo_weight"]')
               || document.querySelector('[name="cargo_weight_real"]');
      if (inp && inp.id) lab = document.querySelector(`label[for="${inp.id}"]`);
    }
    return lab;
  }
  function ensureHintNode(lab){
    let hint = document.getElementById('prev-max-cargo-hint');
    if (!hint) {
      hint = document.createElement('span');
      hint.id = 'prev-max-cargo-hint';
      hint.style.marginLeft = '.5rem';
      hint.style.fontSize = '.9em';
      hint.style.opacity = '0.8';
      lab.appendChild(hint);
    }
    return hint;
  }
  async function updatePrevMax(){
    const tailInp = findTailInput();
    const lab = findCargoLabel();
    if (!tailInp || !lab) return;
    const hint = ensureHintNode(lab);
    const tail = (tailInp.value || '').trim().toUpperCase();
    if (!tail) { hint.textContent = ''; return; }
    try {
      const res = await fetch(`/api/aircraft/prev_max_cargo?tail=${encodeURIComponent(tail)}`, {
        headers: {'X-Requested-With':'XMLHttpRequest'}
      });
      if (!res.ok) return;
      const j = await res.json();
      if (j && j.prev_max_lbs) {
        const lbs = Number(j.prev_max_lbs).toLocaleString();
        hint.textContent = `Prev max: ${lbs} lb`;
      } else {
        hint.textContent = '';
      }
    } catch (e) { /* no-op */ }
  }
  document.addEventListener('DOMContentLoaded', function(){
    const tail = findTailInput();
    if (!tail) return;
    tail.addEventListener('input',  updatePrevMax);
    tail.addEventListener('change', updatePrevMax);
    tail.addEventListener('blur', updatePrevMax);
    updatePrevMax();
  });
})();
</script>

{% endblock %}
