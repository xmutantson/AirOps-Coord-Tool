{% extends "base.html" %}
{% block title %}Dashboard â€“ Aircraft Ops{% endblock %}

{% block content %}
<div class="page-header-bar">
  <style>
    /* Turn overdue ETAs red on the dashboard only */
    .overdue-eta {
      color:#c00 !important; font-weight:700;
    }
  </style>
  <span class="page-title">
    <button type="button"
            class="print-button"
            onclick="window.print()"
            style="margin-right:1rem;">ğŸ–¨ï¸ Print</button>
    Aircraft Ops Dashboard
    (Hosted at: http://ops.lan â€” fallback http://192.168.8.2:5150)
  </span>
  <span id="clock" class="clock">00:00:00</span>

  <form id="filter-form"
        style="display:flex; gap:0.5rem; margin-top:0.5rem; width:100%;">
    <input
      id="tail-filter"
      name="tail_filter"
      class="force-upper"
      type="text"
      placeholder="Filter tail (comma-separated)â€¦"
      value="{{ tail_filter or '' }}"
      style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
      autocomplete="off"
    >
    <input
      id="airport-filter"
      name="airport_filter"
      class="force-upper"
      type="text"
      placeholder="Filter airport (comma-separated)â€¦"
      value="{{ airport_filter or '' }}"
      style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
      autocomplete="off"
    >
    <button
      type="submit"
      class="btn-secondary"
      style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;"
    >Apply filters</button>
    <button
      type="button"
      id="clear-filters"
      class="danger"
      style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;"
    >Clear filters</button>
  </form>
</div>

<div id="dashboard-container" class="{% if tail_filter or airport_filter %}filtered{% endif %}">
  {% if tail_filter or airport_filter %}
    <div id="filter-banner" class="filter-banner">
      <strong>âš ï¸ Filtered view:</strong>
      {% if tail_filter %}
        <span class="filter-tag">Tail: {{ tail_filter }}</span>
      {% endif %}
      {% if airport_filter %}
        <span class="filter-tag">Airport: {{ airport_filter }}</span>
      {% endif %}
    </div>
  {% endif %}

  <div id="dashboard-table"></div>
</div>

{% if show_checkin %}
<!-- â”€â”€ Shift Check-In Modal (first page after login) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="checkin-backdrop" class="modal" role="dialog" aria-modal="true" aria-labelledby="checkin-title">
  <!-- overlay sheet (styled by .modal .backdrop in style.css) -->
  <div class="backdrop" aria-hidden="true"></div>
  <!-- panel/card (styled by #checkin-modal + .card in style.css) -->
  <div id="checkin-modal" class="card">
    <h3 id="checkin-title">Shift Check-In</h3>
    <p class="muted">Welcome! Clock in so others know whoâ€™s on duty. You can skip if youâ€™re just looking around.</p>
    <form id="checkin-form" autocomplete="on">
      <label for="ci-name">Name</label>
      <input id="ci-name" name="name" class="force-upper" placeholder="e.g. JANE DOE"
             value="{{ (last_staff.name or '')|e }}">
      <label for="ci-role">Role</label>
      <input id="ci-role" name="role" placeholder="e.g. RADIO / RAMP / SUPERVISOR"
             value="{{ (last_staff.role or '')|e }}">
      <label for="ci-ew">EW#</label>
      <input id="ci-ew" name="ew_number" placeholder="Optional EW number"
             value="{{ (last_staff.ew or '')|e }}">
      <div class="actions">
        <button type="button" class="button secondary" id="checkin-skip">Skip</button>
        <button type="submit" class="button primary">Clock In</button>
      </div>
    </form>
  </div>
</div>
<script>
  (function(){
    // Embed a CSRF token for AJAX POSTs (Flask-WTF accepts X-CSRFToken / X-CSRF-Token)
    const CSRF = {{ csrf_token()|tojson }};
    const backdrop = document.getElementById('checkin-backdrop');
    const form     = document.getElementById('checkin-form');
    const btnSkip  = document.getElementById('checkin-skip');
    function openModal(){ backdrop.style.display = 'flex'; setTimeout(()=>document.getElementById('ci-name').focus(), 10); }
    function closeModal(){ backdrop.remove(); }
    openModal();

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = new URLSearchParams(new FormData(form));
      const r = await fetch('{{ url_for("staff.staff_quick_checkin") }}', {
        method: 'POST',
        headers: { 'X-CSRFToken': CSRF },
        body: data,
        credentials: 'same-origin'
      });
      if (r.ok) { closeModal(); window.showToast('Clocked in. Have a great shift!', 'success'); }
      else { window.showToast('Check-in failed. Please try again.', 'error'); }
    });
    btnSkip.addEventListener('click', async () => {
      const r = await fetch('{{ url_for("staff.staff_quick_checkin") }}', {
        method:'POST',
        headers: { 'X-CSRFToken': CSRF },
        body: new URLSearchParams({skip:'1'}),
        credentials: 'same-origin'
      });
      if (r.ok) { closeModal(); window.showToast('Okay â€” we wonâ€™t ask again for a while.', 'info'); }
    });
  })();
</script>
{% endif %}

<script>
  async function refreshDashboard(){
    try {
      const resp = await fetch(
        '{{ url_for("core.dashboard_table_partial") }}'
        + window.location.search
      );
      if (!resp.ok) throw new Error(resp.status);
      const html = await resp.text();
      const container = document.getElementById('dashboard-table');
      container.innerHTML = html;
      // After the table loads, (re)compute overdue ETA highlighting
      highlightOverdueETAs(container);
    } catch(err){
      console.error("Dashboard refresh failed:", err);
    }
  }
  // initial + every 30s
  refreshDashboard();
  setInterval(refreshDashboard, 30000);

  // â”€â”€ Overdue ETA highlighter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function findEtaColIndex(root){
    const ths = root.querySelectorAll('thead th');
    for (let i=0;i<ths.length;i++){
      const t = (ths[i].textContent || '').toUpperCase();
      if (t.includes('ETA')) return i;
    }
    return -1;
  }

  function parseEtaFromCell(td){
    // Skip arrivals and empties
    const raw = (td.textContent || '').trim();
    if (!raw || raw === '----' || /\bARR\b/i.test(raw)) return null;
    // Prefer explicit data attributes if present
    const iso = td.getAttribute('data-eta-iso')
               || td.getAttribute('data-eta-utc')
               || td.getAttribute('data-eta')
               || td.getAttribute('datetime');
    if (iso){
      const d = new Date(iso);
      if (!Number.isNaN(d.getTime())) return d; // honor TZ if supplied
    }
    // Parse HH:MM or HHMM from visible text (local clock)
    const m = raw.match(/\b(\d{1,2}):?(\d{2})\b/);
    if (!m) return null;
    const h = parseInt(m[1], 10);
    const min = parseInt(m[2], 10);
    if (Number.isNaN(h) || Number.isNaN(min) || h>23 || min>59) return null;
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, min, 0, 0);
    const yest  = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, h, min, 0, 0);
    const tomo  = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, h, min, 0, 0);
    const MAX_FUTURE_HOURS = 18; // tweak if your ETAs regularly exceed this
    const candidates = [yest, today, tomo];
    // Prefer the nearest future candidate within the window
    const future = candidates
      .map(d => ({ d, diffH: (d - now) / 3600000 }))
      .filter(x => x.diffH >= 0 && x.diffH <= MAX_FUTURE_HOURS)
      .sort((a,b) => a.diffH - b.diffH);
    if (future.length) return future[0].d;
    // Else pick the one closest to now (handles past â€œETAâ€ values)
    candidates.sort((a,b) => Math.abs(a - now) - Math.abs(b - now));
    return candidates[0];
  }

  // Locate the "Status" column by header text
  function findStatusColIndex(root){
    const ths = root.querySelectorAll('thead th');
    for (let i=0;i<ths.length;i++){
      const t = (ths[i].textContent || '').toUpperCase();
      if (t.includes('STATUS')) return i;
    }
    return -1;
  }

  // Determine if the row containing this ETA cell is explicitly "In Flight"
  function isInFlightForCell(td){
    const tr = td.closest('tr');
    if (!tr) return false;
    // 1) Prefer a data-status on the row or a descendant
    let s = (tr.getAttribute('data-status') || '').trim();
    if (!s){
      const ds = tr.querySelector('[data-status]');
      if (ds) s = (ds.getAttribute('data-status') || ds.textContent || '').trim();
    }
    // 2) A cell with a .status class
    if (!s){
      const st = tr.querySelector('td.status, span.status, div.status');
      if (st) s = (st.textContent || '').trim();
    }
    // 3) Fallback: use the column headed "Status"
    if (!s){
      const table = tr.closest('table'); if (!table) return false;
      const idx = findStatusColIndex(table);
      if (idx >= 0 && tr.children[idx]) s = (tr.children[idx].textContent || '').trim();
    }
    if (!s) return false;
    return /\bin[\s-]?flight\b/i.test(s);
  }

  function highlightOverdueETAs(root=document){
    const now = new Date();
    // First try explicit selectors if your row macro provides them
    let els = root.querySelectorAll('[data-eta],[data-eta-utc],[data-eta-iso],[data-col="eta"],td.eta,span.eta,div.eta,.eta-time');
    if (els.length){
      els.forEach(el => {
        const eta = parseEtaFromCell(el);
        // Only mark if the flight is currently in flight
        if (!isInFlightForCell(el) || !eta){
          el.classList.remove('overdue-eta');
          return;
        }
        const diffMin = (now - eta) / 60000;
        if (diffMin >= 30) el.classList.add('overdue-eta');
        else el.classList.remove('overdue-eta');
      });
      return;
    }
    // Fallback: find ETA column by header text and scan cells
    const table = root.querySelector('table.ops-flight-table');
    if (!table) return;
    const col = findEtaColIndex(table);
    if (col < 0) return;
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      const tds = tr.children;
      if (!tds || tds.length <= col) return;
      const td = tds[col];
      const eta = parseEtaFromCell(td);
      // Only mark if the flight is currently in flight
      if (!isInFlightForCell(td) || !eta){
        td.classList.remove('overdue-eta');
        return;
      }
      const diffMin = (now - eta) / 60000;
      if (diffMin >= 30) td.classList.add('overdue-eta');
      else td.classList.remove('overdue-eta');
    });
  }
  // Keep highlighting fresh as time passes even between refreshes
  setInterval(() => highlightOverdueETAs(document.getElementById('dashboard-table') || document), 60000);

  // only run if the banner is present
  const banner = document.getElementById('filter-banner');
  if (banner) {
    // every 10 seconds, give it a quick wiggle
    setInterval(() => {
      banner.classList.add('wiggle');
      // remove class after animation ends so it can retrigger next time
      setTimeout(() => banner.classList.remove('wiggle'), 500);
    }, 10000);
  }

  function updateClock(){
    const now = new Date();
    document.getElementById('clock').textContent =
      `${String(now.getHours()).padStart(2,'0')}:` +
      `${String(now.getMinutes()).padStart(2,'0')}:` +
      `${String(now.getSeconds()).padStart(2,'0')}`;
  }
  updateClock();
  setInterval(updateClock, 1000);

  // Apply / Clear filters
  document.getElementById('filter-form').addEventListener('submit', e => {
    e.preventDefault();
    const form = e.target;
    const qs   = new URLSearchParams(window.location.search);

    // normalize comma-separated, uppercase, no empties
    function norm(name) {
      return Array.from(
        form[name].value.split(',')
          .map(s => s.trim().toUpperCase())
          .filter(Boolean)
      ).join(',');
    }

    const tails = norm('tail_filter');
    if (tails) qs.set('tail_filter', tails);
    else      qs.delete('tail_filter');

    const aps = norm('airport_filter');
    if (aps) qs.set('airport_filter', aps);
    else     qs.delete('airport_filter');

    window.location.search = qs.toString();
  });

  document.getElementById('clear-filters').addEventListener('click', () => {
    document.getElementById('tail-filter').value    = '';
    document.getElementById('airport-filter').value = '';
    const qs = new URLSearchParams(window.location.search);
    qs.delete('tail_filter');
    qs.delete('airport_filter');
    window.location.search = qs.toString();
  });
</script>
{% endblock %}
