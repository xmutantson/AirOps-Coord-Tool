{% extends "base.html" %}
{% block title %}Dashboard ‚Äì Aircraft Ops{% endblock %}

{% block content %}
<div class="page-header-bar">
  <style>
    /* Turn overdue ETAs red on the dashboard only */
    .overdue-eta {
      color:#c00 !important; font-weight:700;
    }
  </style>
  <span class="page-title">
    <button type="button"
            class="print-button"
            onclick="window.print()"
            style="margin-right:1rem;">üñ®Ô∏è Print</button>
    Aircraft Ops Dashboard
    (Hosted at: http://ops.lan ‚Äî fallback http://192.168.8.2:5150)
  </span>
  <span id="clock" class="clock">00:00:00</span>

  <form id="filter-form"
        style="display:flex; gap:0.5rem; margin-top:0.5rem; width:100%;">
    <input
      id="tail-filter"
      name="tail_filter"
      class="force-upper"
      type="text"
      placeholder="Filter tail (comma-separated)‚Ä¶"
      value="{{ tail_filter or '' }}"
      style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
      autocomplete="off"
    >
    <input
      id="airport-filter"
      name="airport_filter"
      class="force-upper"
      type="text"
      placeholder="Filter airport (comma-separated)‚Ä¶"
      value="{{ airport_filter or '' }}"
      style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
      autocomplete="off"
    >
    <button
      type="submit"
      class="btn-secondary"
      style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;"
    >Apply filters</button>
    <button
      type="button"
      id="clear-filters"
      class="danger"
      style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;"
    >Clear filters</button>
  </form>
</div>

<div id="dashboard-container" class="{% if tail_filter or airport_filter %}filtered{% endif %}">
  {% if tail_filter or airport_filter %}
    <div id="filter-banner" class="filter-banner">
      <strong>‚ö†Ô∏è Filtered view:</strong>
      {% if tail_filter %}
        <span class="filter-tag">Tail: {{ tail_filter }}</span>
      {% endif %}
      {% if airport_filter %}
        <span class="filter-tag">Airport: {{ airport_filter }}</span>
      {% endif %}
    </div>
  {% endif %}

  <div id="dashboard-table"></div>
</div>

{% if show_checkin %}
<!-- ‚îÄ‚îÄ Shift Check-In Modal (first page after login) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div id="checkin-backdrop" class="modal" role="dialog" aria-modal="true" aria-labelledby="checkin-title">
  <!-- overlay sheet (styled by .modal .backdrop in style.css) -->
  <div class="backdrop" aria-hidden="true"></div>
  <!-- panel/card (styled by #checkin-modal + .card in style.css) -->
  <div id="checkin-modal" class="card">
    <h3 id="checkin-title">Shift Check-In</h3>
    <p class="muted">Welcome! Start with your name. If we already have you, we‚Äôll clock you right in.</p>
    <form id="checkin-form" autocomplete="on">
      <!-- Stage 1: Name only -->
      <div id="checkin-stage1">
        <label for="ci-name">Name</label>
        <input id="ci-name" name="name" class="force-upper" placeholder="e.g. JANE DOE"
               value="{{ (last_staff.name or '')|e }}">
        <div class="actions">
          <button type="button" class="button secondary" id="checkin-skip">Skip</button>
          <button type="submit" class="button primary">Continue</button>
        </div>
      </div>

      <!-- Stage 2: New person ‚Üí collect details -->
      <div id="checkin-stage2" style="display:none; margin-top:.75rem;">
        <div class="muted" style="margin-bottom:.5rem;">Looks like you‚Äôre new. Please add a few details:</div>
        <input type="hidden" name="ajax" value="1">
        <label for="ci2-name">Name</label>
        <input id="ci2-name" name="name" class="force-upper" placeholder="JANE DOE">
        <label for="ci2-organization">Organization</label>
        <input id="ci2-organization" name="organization" placeholder="Red Cross / EOC / WWDART‚Ä¶">
        <label for="ci2-emc">EMC (optional)</label>
        <input id="ci2-emc" name="emc" placeholder="EMC-1234">
        <label for="ci2-email">Email</label>
        <input id="ci2-email" name="email" type="email" placeholder="name@example.org">
        <label for="ci2-phone">Cell Phone</label>
        <input id="ci2-phone" name="phone" inputmode="tel" placeholder="(555) 555-5555">

        <style>
          .role-chooser {
            margin:.75rem 0; padding:.5rem; border:1px solid #8883; border-radius:.5rem;
          }
          .role-chooser legend { font-weight:700; padding:0 .25rem; }
          .radio-row {
            display:flex; align-items:center; gap:.6rem;
            padding:.35rem .5rem; border-radius:.4rem; cursor:pointer;
          }
          .radio-row:hover { background:rgba(127,127,127,.12); }
          .radio-row input { margin:0; }
          .radio-row input:checked + span { font-weight:700; text-decoration:underline; }
        </style>
        <fieldset class="role-chooser">
          <legend>Are you a Pilot or a Volunteer?</legend>
          <label class="radio-row">
            <input type="radio" name="affiliation" value="pilot">
            <span>Pilot</span>
          </label>
          <label class="radio-row">
            <input type="radio" name="affiliation" value="volunteer">
            <span>Volunteer</span>
          </label>
        </fieldset>

        <div class="actions">
          <button type="button" class="button secondary" id="checkin-back">Back</button>
          <button type="submit" class="button primary" id="checkin-create">Create & Continue</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script>
  (function(){
    // Embed a CSRF token for AJAX POSTs (Flask-WTF accepts X-CSRFToken / X-CSRF-Token)
    const CSRF = {{ csrf_token()|tojson }};
    const backdrop = document.getElementById('checkin-backdrop');
    const form     = document.getElementById('checkin-form');
    const btnSkip  = document.getElementById('checkin-skip');
    const st1      = document.getElementById('checkin-stage1');
    const st2      = document.getElementById('checkin-stage2');
    const btnBack  = document.getElementById('checkin-back');
    function openModal(){ backdrop.style.display = 'flex'; setTimeout(()=>document.getElementById('ci-name').focus(), 10); }
    function closeModal(){ backdrop.remove(); }
    openModal();

    // Inline choice UI to open the appropriate waiver in a new tab
    function openWaiverChoice(staffId, name, chooseUrl){
      // Prefer an inline mini-modal; fall back to the chooser page if construction fails.
      try{
        const wrap = document.createElement('div');
        wrap.className = 'modal';
        wrap.id = 'waiver-choice';
        wrap.innerHTML = `
          <div class="backdrop" aria-hidden="true"></div>
          <div class="card" role="dialog" aria-modal="true" aria-label="Choose Waiver">
            <h3 style="margin:0 0 .25rem 0;">Choose Waiver</h3>
            <p class="muted" style="margin:0 0 .75rem 0;">for <strong>${name || 'new staffer'}</strong></p>
            <div class="actions" style="justify-content:flex-start; gap:.5rem;">
              <a class="button" target="_blank" rel="noopener" href="/docs/waiver/pilot?staff_id=${encodeURIComponent(staffId)}">Pilot</a>
              <a class="button" target="_blank" rel="noopener" href="/docs/waiver/volunteer?staff_id=${encodeURIComponent(staffId)}">Volunteer</a>
              <button type="button" class="button secondary" id="wc-close">Done</button>
            </div>
          </div>`;
        document.body.appendChild(wrap);
        const closeBtn = wrap.querySelector('#wc-close');
        if (closeBtn) closeBtn.addEventListener('click', ()=> wrap.remove());
      }catch(_e){
        if (chooseUrl) window.location.href = chooseUrl;
      }
    }

    // Guard against accidental double-binding if this script is included twice
    if (window.__DASH_CHECKIN_BOUND__) return; window.__DASH_CHECKIN_BOUND__ = true;

    // ‚îÄ Single submit handler drives both stages (existing vs new profile) ‚îÄ
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      // Stage 2 path (new profile creation)
      if (st2.style.display !== 'none') {
        if (!fd.get('name')) {
          fd.set('name', (document.getElementById('ci2-name').value || document.getElementById('ci-name').value || '').trim());
        }
        fd.set('ajax', '1');
        try {
          const resp = await fetch('{{ url_for("staff.staff_new") }}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': CSRF,
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: fd,
            credentials: 'same-origin'
          });
          const ctype = resp.headers.get('content-type') || '';
          if (!resp.ok) throw new Error('bad status');
          if (ctype.includes('application/json')) {
            const data = await resp.json();
            if (data && data.ok && data.staff_id) {
              // Immediately clock them in after creating profile
              try {
                const r2 = await fetch('{{ url_for("staff.staff_quick_checkin") }}', {
                  method:'POST',
                  headers:{ 'X-CSRFToken': CSRF },
                  body:new URLSearchParams({ name: fd.get('name') || '' }),
                  credentials:'same-origin'
                });
                // ignore failures; profile was created
                if (r2.ok) { /* optional: read json */ }
              } catch(_) {}
              // Waiver: if they chose role here, prefer that; else show chooser
              const aff = (fd.get('affiliation') || '').toString();
              closeModal(); // always close modal after success
              window.showToast?.('Profile saved and clocked in. Thanks!', 'success');
              const sid = data.staff_id;
              const nm  = data.name || (fd.get('name') || '');
              if (aff === 'pilot') {
                openWaiverChoice(sid, nm, null);
                window.open(`/docs/waiver/pilot?staff_id=${encodeURIComponent(sid)}`, '_blank', 'noopener');
              } else if (aff === 'volunteer') {
                openWaiverChoice(sid, nm, null);
                window.open(`/docs/waiver/volunteer?staff_id=${encodeURIComponent(sid)}`, '_blank', 'noopener');
              } else {
                const choose = data.waiver_choose_url || (`/staff/waiver/choose?staff_id=${encodeURIComponent(sid)}`);
                openWaiverChoice(sid, nm, choose);
              }
              return;
            }
            // Fallback: modal/waiver fragments
            if (data.modal_html) {
              const wrap = document.createElement('div'); wrap.innerHTML = data.modal_html; document.body.appendChild(wrap);
            } else if (data.waiver_html) {
              const wrap = document.createElement('div'); wrap.innerHTML = data.waiver_html; document.body.appendChild(wrap);
            } else if (data.waiver_url) {
              openWaiverChoice(data.staff_id || null, fd.get('name') || '', data.waiver_url);
            } else {
              closeModal(); window.showToast?.('Profile saved.', 'success');
            }
            return;
          } else {
            // If backend returned HTML (often because it 302'd), fall back:
            // 1) stash the entered data, 2) close modal, 3) go to roster where
            //    a helper script will auto-fill & submit the "Add" form.
            const payload = {
              name:        (fd.get('name') || '').toString(),
              organization:(fd.get('organization') || '').toString(),
              emc:         (fd.get('emc') || '').toString(),
              email:       (fd.get('email') || '').toString(),
              phone:       (fd.get('phone') || '').toString(),
              affiliation: (fd.get('affiliation') || '').toString()
            };
            try { sessionStorage.setItem('pendingStaffProfile', JSON.stringify(payload)); } catch(_){}
            closeModal();
            window.location.href = "{{ url_for('staff.staff_list', window='all') }}";
          }
        } catch(_e) {
          window.showToast?.('Could not save profile. Please try again.', 'error');
        }
        return;
      }

      // Stage 1 path (name ‚Üí quick check-in; auto-toggle if exists; else expand)
      const nameVal = (fd.get('name') || '').toString().trim();
      if (!nameVal) { document.getElementById('ci-name').focus(); return; }
      try {
        const r = await fetch('{{ url_for("staff.staff_quick_checkin") }}', {
          method: 'POST',
          headers: { 'X-CSRFToken': CSRF },
          body: new URLSearchParams({ name: nameVal }),
          credentials: 'same-origin'
        });
        if (!r.ok) throw new Error('bad status');
        // robust parse (handles any stray text before JSON)
        const ctype = r.headers.get('content-type') || '';
        let rawText = await r.text();
        if (!ctype.includes('application/json')) {
          const brace = rawText.indexOf('{'); if (brace > 0) rawText = rawText.slice(brace);
        }
        let payload = {}; try { payload = JSON.parse(rawText); } catch { payload = {}; }
        console.debug('quick_checkin payload:', payload);

        if (payload && payload.ok) {
          if (payload.needs_profile) {
            // New person ‚Üí expand to Stage 2
            st1.style.display = 'none';
            st2.style.display = '';
            const n1 = document.getElementById('ci-name').value;
            document.getElementById('ci2-name').value = n1;
            setTimeout(()=>document.getElementById('ci2-organization').focus(), 10);
            return;
          }
          // Treat ok:true as success for existing/auto-created records
          closeModal();
          const t = String(payload.toggled || '').toLowerCase();
          const msg = (t === 'restarted') ? 'Shift restarted.' : 'Clocked in.';
          window.showToast?.(msg, 'success');
          if (payload.staff_id) {
            const choose = payload.waiver_choose_url || (`/staff/waiver/choose?staff_id=${encodeURIComponent(payload.staff_id)}`);
            openWaiverChoice(payload.staff_id, payload.name || '', choose);
          }
          return;
        }
        window.showToast?.('Could not check you in. Please try again.', 'error');
      } catch(_err) {
        window.showToast?.('Check-in failed. Please try again.', 'error');
      }
    });

    // Back to Stage 1
    btnBack?.addEventListener('click', () => {
      st2.style.display = 'none';
      st1.style.display = '';
      setTimeout(()=>document.getElementById('ci-name').focus(), 10);
    });
    // Skip for now
    btnSkip?.addEventListener('click', async () => {
      try{
        const r = await fetch('{{ url_for("staff.staff_quick_checkin") }}', {
          method:'POST',
          headers: { 'X-CSRFToken': CSRF },
          body: new URLSearchParams({skip:'1'}),
          credentials: 'same-origin'
        });
        if (r.ok) { closeModal(); window.showToast?.('Okay ‚Äî we won‚Äôt ask again for a while.', 'info'); }
      } catch(_) {}
    });
  })();
</script>
{% endif %}

<script>
  async function refreshDashboard(){
    try {
      const resp = await fetch(
        '{{ url_for("core.dashboard_table_partial") }}'
        + window.location.search
      );
      if (!resp.ok) throw new Error(resp.status);
      const html = await resp.text();
      const container = document.getElementById('dashboard-table');
      container.innerHTML = html;
      // After the table loads, (re)compute overdue ETA highlighting
      highlightOverdueETAs(container);
    } catch(err){
      console.error("Dashboard refresh failed:", err);
    }
  }
  // initial + every 30s
  refreshDashboard();
  setInterval(refreshDashboard, 30000);

  // ‚îÄ‚îÄ Overdue ETA highlighter ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function findEtaColIndex(root){
    const ths = root.querySelectorAll('thead th');
    for (let i=0;i<ths.length;i++){
      const t = (ths[i].textContent || '').toUpperCase();
      if (t.includes('ETA')) return i;
    }
    return -1;
  }

  function parseEtaFromCell(td){
    // Skip arrivals and empties
    const raw = (td.textContent || '').trim();
    if (!raw || raw === '----' || /\bARR\b/i.test(raw)) return null;
    // Prefer explicit data attributes if present
    const iso = td.getAttribute('data-eta-iso')
               || td.getAttribute('data-eta-utc')
               || td.getAttribute('data-eta')
               || td.getAttribute('datetime');
    if (iso){
      const d = new Date(iso);
      if (!Number.isNaN(d.getTime())) return d; // honor TZ if supplied
    }
    // Parse HH:MM or HHMM from visible text (local clock)
    const m = raw.match(/\b(\d{1,2}):?(\d{2})\b/);
    if (!m) return null;
    const h = parseInt(m[1], 10);
    const min = parseInt(m[2], 10);
    if (Number.isNaN(h) || Number.isNaN(min) || h>23 || min>59) return null;
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, min, 0, 0);
    const yest  = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1, h, min, 0, 0);
    const tomo  = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, h, min, 0, 0);
    const MAX_FUTURE_HOURS = 18; // tweak if your ETAs regularly exceed this
    const candidates = [yest, today, tomo];
    // Prefer the nearest future candidate within the window
    const future = candidates
      .map(d => ({ d, diffH: (d - now) / 3600000 }))
      .filter(x => x.diffH >= 0 && x.diffH <= MAX_FUTURE_HOURS)
      .sort((a,b) => a.diffH - b.diffH);
    if (future.length) return future[0].d;
    // Else pick the one closest to now (handles past ‚ÄúETA‚Äù values)
    candidates.sort((a,b) => Math.abs(a - now) - Math.abs(b - now));
    return candidates[0];
  }

  // Locate the "Status" column by header text
  function findStatusColIndex(root){
    const ths = root.querySelectorAll('thead th');
    for (let i=0;i<ths.length;i++){
      const t = (ths[i].textContent || '').toUpperCase();
      if (t.includes('STATUS')) return i;
    }
    return -1;
  }

  // Determine if the row containing this ETA cell is explicitly "In Flight"
  function isInFlightForCell(td){
    const tr = td.closest('tr');
    if (!tr) return false;
    // 1) Prefer a data-status on the row or a descendant
    let s = (tr.getAttribute('data-status') || '').trim();
    if (!s){
      const ds = tr.querySelector('[data-status]');
      if (ds) s = (ds.getAttribute('data-status') || ds.textContent || '').trim();
    }
    // 2) A cell with a .status class
    if (!s){
      const st = tr.querySelector('td.status, span.status, div.status');
      if (st) s = (st.textContent || '').trim();
    }
    // 3) Fallback: use the column headed "Status"
    if (!s){
      const table = tr.closest('table'); if (!table) return false;
      const idx = findStatusColIndex(table);
      if (idx >= 0 && tr.children[idx]) s = (tr.children[idx].textContent || '').trim();
    }
    if (!s) return false;
    return /\bin[\s-]?flight\b/i.test(s);
  }

  function highlightOverdueETAs(root=document){
    const now = new Date();
    // First try explicit selectors if your row macro provides them
    let els = root.querySelectorAll('[data-eta],[data-eta-utc],[data-eta-iso],[data-col="eta"],td.eta,span.eta,div.eta,.eta-time');
    if (els.length){
      els.forEach(el => {
        const eta = parseEtaFromCell(el);
        // Only mark if the flight is currently in flight
        if (!isInFlightForCell(el) || !eta){
          el.classList.remove('overdue-eta');
          return;
        }
        const diffMin = (now - eta) / 60000;
        if (diffMin >= 30) el.classList.add('overdue-eta');
        else el.classList.remove('overdue-eta');
      });
      return;
    }
    // Fallback: find ETA column by header text and scan cells
    const table = root.querySelector('table.ops-flight-table');
    if (!table) return;
    const col = findEtaColIndex(table);
    if (col < 0) return;
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      const tds = tr.children;
      if (!tds || tds.length <= col) return;
      const td = tds[col];
      const eta = parseEtaFromCell(td);
      // Only mark if the flight is currently in flight
      if (!isInFlightForCell(td) || !eta){
        td.classList.remove('overdue-eta');
        return;
      }
      const diffMin = (now - eta) / 60000;
      if (diffMin >= 30) td.classList.add('overdue-eta');
      else td.classList.remove('overdue-eta');
    });
  }
  // Keep highlighting fresh as time passes even between refreshes
  setInterval(() => highlightOverdueETAs(document.getElementById('dashboard-table') || document), 60000);

  // only run if the banner is present
  const banner = document.getElementById('filter-banner');
  if (banner) {
    // every 10 seconds, give it a quick wiggle
    setInterval(() => {
      banner.classList.add('wiggle');
      // remove class after animation ends so it can retrigger next time
      setTimeout(() => banner.classList.remove('wiggle'), 500);
    }, 10000);
  }

  function updateClock(){
    const now = new Date();
    document.getElementById('clock').textContent =
      `${String(now.getHours()).padStart(2,'0')}:` +
      `${String(now.getMinutes()).padStart(2,'0')}:` +
      `${String(now.getSeconds()).padStart(2,'0')}`;
  }
  updateClock();
  setInterval(updateClock, 1000);

  // Apply / Clear filters
  document.getElementById('filter-form').addEventListener('submit', e => {
    e.preventDefault();
    const form = e.target;
    const qs   = new URLSearchParams(window.location.search);

    // normalize comma-separated, uppercase, no empties
    function norm(name) {
      return Array.from(
        form[name].value.split(',')
          .map(s => s.trim().toUpperCase())
          .filter(Boolean)
      ).join(',');
    }

    const tails = norm('tail_filter');
    if (tails) qs.set('tail_filter', tails);
    else      qs.delete('tail_filter');

    const aps = norm('airport_filter');
    if (aps) qs.set('airport_filter', aps);
    else     qs.delete('airport_filter');

    window.location.search = qs.toString();
  });

  document.getElementById('clear-filters').addEventListener('click', () => {
    document.getElementById('tail-filter').value    = '';
    document.getElementById('airport-filter').value = '';
    const qs = new URLSearchParams(window.location.search);
    qs.delete('tail_filter');
    qs.delete('airport_filter');
    window.location.search = qs.toString();
  });
</script>
{% endblock %}
