{% extends "base.html" %}
{% block title %}Inventory Detail – Aircraft Ops{% endblock %}

{% block content %}
  <h2>Inventory Detail</h2>
  <button type="button"
          class="back-button"
          onclick="location.href='{{ url_for('inventory.inventory_overview') }}'">
    ← Back to Overview
  </button>

  <!-- two-column form, re-using the Ramp-Boss grid styles -->
  <div class="ramp-form-container">
    <form id="inventory-form"
          method="POST"
          action="{{ url_for('inventory.inventory_detail') }}"
          autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Direction toggle: sticky at top (values now ‘in’/‘out’ to satisfy DB CHECK) -->
      <label>Direction</label>
      <div class="radio-toggle">
        <input type="radio" id="dir-in"  name="direction" value="in"
               {% if session.get('inv_direction','in') != 'out' %}checked{% endif %}>
        <label for="dir-in">Inbound</label>

        <input type="radio" id="dir-out" name="direction" value="out"
               {% if session.get('inv_direction','in') == 'out' %}checked{% endif %}>
        <label for="dir-out">Outbound</label>
      </div>

      <!-- Category -->
      <label for="category">Category</label>
      <select id="category" name="category" required>
        <option value="" disabled
                {% if not request.form.get('category') %}selected{% endif %}>
          — choose category —
        </option>
        {% for c in categories %}
          <option value="{{ c.id }}"
                  {% if request.form.get('category') == c.id|string %}selected{% endif %}>
            {{ c.display_name }}
          </option>
        {% endfor %}
      </select>

      <!-- Item Name -->
      <label for="name">Item Name</label>
      <!-- inbound: free-text -->
      <input id="name" name="name" required
             value="{{ request.form.get('name','') }}">
      <!-- outbound: dropdown -->
      <select id="name-select" name="name" style="display:none;" required>
        {% if request.form.get('name') %}
          <option selected>{{ request.form.get('name') }}</option>
        {% endif %}
      </select>

      <!-- Weight per Unit -->
      <label for="weight">Wt/Unit</label>
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <!-- inbound: free-text -->
        <input id="weight" name="weight" type="number" step="any" min="0" required
               value="{{ request.form.get('weight','') }}"
               style="flex:1; min-width:16ch;">

        <!-- outbound: weight dropdown -->
        <select id="weight-select" name="weight" style="display:none;" required>
          {% if request.form.get('weight') %}
            <option value="{{ request.form.get('weight') }}" selected>
              {{ request.form.get('weight') }}
            </option>
          {% endif %}
        </select>

        <!-- unit toggle (inbound only), capped width -->
        <select id="weight_unit" name="weight_unit" style="max-width:10ch;">
          <option value="lbs"
                  {% if request.form.get('weight_unit')=='lbs' or inv_weight_unit=='lbs' %}
                    selected{% endif %}>
            lbs
          </option>
          <option value="kg"
                  {% if request.form.get('weight_unit')=='kg' or inv_weight_unit=='kg' %}
                    selected{% endif %}>
            kg
          </option>
        </select>
      </div>

      <!-- Quantity -->
      <label for="qty">Quantity</label>
      <input id="qty" name="qty" type="number" step="1" min="0" required
             value="{{ request.form.get('qty','') }}">

      <button type="submit" style="grid-column: span 2; margin-top: 1rem;">
        Save Entry
      </button>
    </form>
  </div>

  <div id="inventory-detail-table"><!-- AJAX detail table loads here --></div>

  <script>
    // Load the list of past entries via AJAX
    async function loadInventoryDetail() {
      try {
        const resp = await fetch("{{ url_for('inventory.inventory_detail_table') }}");
        document.getElementById("inventory-detail-table").innerHTML = await resp.text();
      } catch (_) {}
    }
    loadInventoryDetail();

    // --- Inventory Detail: dynamic UI tweaks ---
    document.addEventListener('DOMContentLoaded', () => {
      // Preloaded inventory data for outbound lookups
      const invData     = {{ advanced_data|tojson }};
      // Form controls
      const dirIn        = document.getElementById('dir-in');
      const dirOut       = document.getElementById('dir-out');
      const categoryEl   = document.getElementById('category');
      const nameTxt      = document.getElementById('name');
      const nameSel      = document.getElementById('name-select');
      const weightTxt    = document.getElementById('weight');
      const weightSel    = document.getElementById('weight-select');
      const weightUnitEl = document.getElementById('weight_unit');
      const qtyFld       = document.getElementById('qty');

      // Only preserve initial category on first render; clear on toggles
      let firstMode = true;

      // preserved on-error selections
      const allCats       = invData.all_categories;
      const stockCats     = invData.stock_categories;

      // remember what (if anything) was submitted last time:
      const selectedCat = "{{ request.form.get('category','') }}";

      // Show/hide the appropriate fields when direction changes
      function updateMode() {
        // decide whether to keep or reset the category placeholder
        const curCat = firstMode ? categoryEl.value : '';
        if (dirOut.checked) {
          // remember what was just selected
          // — Outbound mode —
          // rebuild category dropdown to only stocked categories,
          // placeholder selected only when curCat is empty
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            stockCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');

          // inbound‐input is hidden & disabled in Outbound
          nameTxt.style.display     = 'none';
          nameTxt.required          = false;
          nameTxt.disabled          = true;
          // outbound‐select is shown & enabled
          nameSel.style.display     = '';
          nameSel.required          = true;
          nameSel.disabled          = false;

          // Weight → dropdown
          // inbound weight‐input hidden & disabled
          weightTxt.style.display   = 'none';
          weightTxt.required        = false;
          weightTxt.disabled        = true;

          // outbound weight‐select shown & enabled
          weightSel.style.display   = '';
          weightSel.required        = true;
          weightSel.disabled        = false;
          // clear any stale size/options
          weightSel.innerHTML      = '<option value="">Size…</option>';

          // Clear any previous quantity
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');

          // Populate item dropdown for this category (dedupe names)
          const cid   = categoryEl.value;
          const items = Array.from(new Set(invData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');


          weightTxt.style.display    = 'none';
          weightTxt.required         = false;
          weightSel.style.display    = '';
          weightSel.required         = true;
          // unit‐toggle only for inbound
          weightUnitEl.style.display = 'none';
          weightUnitEl.required      = false;
          weightUnitEl.disabled      = true;

        } else {
          // inbound: show all categories,
          // rebuild full category list, placeholder if curCat empty
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            allCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');

          // clear any previous quantity
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');



          // inbound: show & enable free‐text
          nameTxt.style.display     = '';
          nameTxt.required          = true;
          nameTxt.disabled          = false;
          // disable outbound select
          nameSel.style.display     = 'none';
          nameSel.required          = false;
          nameSel.disabled          = true;

          // inbound weight‐input shown & enabled
          weightTxt.style.display    = '';
          weightTxt.required         = true;
          weightTxt.disabled         = false;
          // disable outbound weight‐select
          weightSel.style.display     = 'none';
          weightSel.required          = false;
          weightSel.disabled          = true;
          // unit toggle re‐enabled
          weightUnitEl.style.display  = '';
          weightUnitEl.required       = true;
          weightUnitEl.disabled       = false;

          qtyFld.removeAttribute('max');
        }
        firstMode = false;
      }

      categoryEl.addEventListener('change', e => {
        // if in outbound mode, rebuild item dropdown for the new category
        if (dirOut.checked) {
          const cid   = e.target.value;
          const items = Array.from(new Set(invData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');
        }
        // auto-insert "water" if Water category
        const label = e.target.selectedOptions[0].text;
        if (label === 'Water') {
          if (dirOut.checked) {
            nameSel.value = 'water';
            nameSel.dispatchEvent(new Event('change'));
          } else {
            nameTxt.value = 'water';
          }
        }
      });

      // Wire up the direction toggle
      [dirIn, dirOut].forEach(radio => {
        radio.addEventListener('change', updateMode);
      });
      updateMode();  // initialize on load

      // When an outbound item is picked, fill the weight-per-unit dropdown
      nameSel.addEventListener('change', () => {
        if (!dirOut.checked) return;
        const cid   = categoryEl.value;
        const item  = nameSel.value;
        const sizes = invData.sizes?.[cid]?.[item] || [];
        weightSel.innerHTML = '<option value="">Size…</option>' +
          sizes.map(sz => {
            const avail = invData.avail?.[cid]?.[item]?.[String(sz)] || 0;
            return `<option value="${sz}" data-avail="${avail}">` +
                     `${sz} lb (${avail} avail)` +
                   `</option>`;
          }).join('');
      });
    });
  </script>
{% endblock %}
