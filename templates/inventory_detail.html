{% extends "base.html" %}
{% block title %}Inventory Detail – Aircraft Ops{% endblock %}

{% block content %}
  <h2>Inventory Detail</h2>
  <button type="button"
          class="back-button"
          onclick="location.href='{{ url_for('inventory.inventory_overview') }}'">
    ← Back to Overview
  </button>

  <!-- Direction (ALWAYS visible; lives above scanner; submits with inventory-form via form=) -->
  <div class="ramp-form-container" id="scan-dir-wrap">
    <div>
      <label style="display:block; font-weight:600; margin:0 0 .25rem 0;">Direction</label>
      <div class="radio-toggle">
        <input type="radio"
               id="dir-in"
               name="direction"
               value="in"
               form="inventory-form"
               {% if session.get('inv_direction','in') != 'out' %}checked{% endif %}>
        <label for="dir-in">Inbound</label>
        <input type="radio"
               id="dir-out"
               name="direction"
               value="out"
               form="inventory-form"
               {% if session.get('inv_direction','in') == 'out' %}checked{% endif %}>
        <label for="dir-out">Outbound</label>
      </div>
    </div>
  </div>

  <!-- Inline scanner controls (USB-first; camera-deferred) -->
  <div class="ramp-form-container">
  <div id="scan-app"
       data-url-lookup="{{ url_for('inventory.api_lookup_barcode_post') }}"
       data-url-scan-post="{{ url_for('inventory.api_scan_barcode') }}"
       data-url-save-map="{{ url_for('inventory.api_save_barcode_mapping') }}"
       data-url-categories="{{ url_for('inventory.api_inventory_categories') }}"
       data-zxing-url="{{ url_for('static', filename='js/zxing.min.js') }}"
       class="ramp-form-container"
       style="margin: 0 0 1rem 0;">
    <div class="row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
      <strong>Barcode tools:</strong>
      <span id="scan-status" class="badge">idle</span>
      <button id="scan-photo-btn" type="button">Scan with camera (photo)</button>
      <input id="scan-photo-input"
             type="file"
             accept="image/*"
             capture="environment"
             style="display:none;">
    </div>
    <div class="lookup-row scan-row" style="margin-top:8px;">
      <input id="scan-kbd" type="text" placeholder="Focus here and scan (Enter)…">
      <button id="scan-kbd-submit" type="button" class="scan-lookup">Lookup</button>
    </div>
    <small>Scans pre-fill this form. Unknown barcodes can be added inline.</small>
    <div id="scan-result" style="display:grid;gap:10px;margin-top:12px;"></div>
    <!-- Unknown mapping form (same as in scan page) -->
    <div id="scan-create" class="card" hidden
         style="border:1px solid #ffd39b;background:#fff7ea;border-radius:10px;padding:12px;max-width:720px;margin-top:8px;">
      <h3>Add item for scanned barcode</h3>
      <div class="stack" style="display:grid;gap:8px;">
        <label>Barcode <input id="u_barcode" type="text" readonly style="padding:8px;width:100%;background:#f7f7f7;"></label>
        <label>Category
          <select id="u_cat" required style="padding:8px;width:100%;">
            <option value="" disabled selected>— choose category —</option>
          </select>
        </label>
        <label>Item name <input id="u_name" type="text" required style="padding:8px;width:100%;" placeholder="e.g. water"></label>
        <label>Unit size
          <div class="lookup-row" style="gap:8px;">
            <input id="u_wpu" type="number" step="any" min="0" required placeholder="e.g. 12">
            <select id="u_unit" required style="max-width:8ch;">
              <option value="" disabled selected>unit</option>
              <option value="lbs">lb</option>
              <option value="oz">oz</option>
            </select>
          </div>
        </label>
        <div class="row" style="display:flex;gap:8px;"><button id="u_save" type="button">Save & Prefill</button><button id="u_cancel" type="button">Cancel</button></div>
      </div>
    </div>
  </div><!-- /#scan-app -->
  </div><!-- /.ramp-form-container -->

  <!-- two-column form, reusing the Ramp-Boss grid styles -->
  <div class="ramp-form-container">
    <form id="inventory-form"
          method="POST"
          action="{{ url_for('inventory.inventory_detail') }}"
          autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Category -->
      <label for="category">Category</label>
      <select id="category" name="category" required>
        <option value="" disabled
                {% if not request.form.get('category') %}selected{% endif %}>
          — choose category —
        </option>
        {% for c in categories %}
          <option value="{{ c.id }}"
                  {% if request.form.get('category') == c.id|string %}selected{% endif %}>
            {{ c.display_name }}
          </option>
        {% endfor %}
      </select>

      <!-- Item Name -->
      <label for="name">Item Name</label>
      <!-- inbound: free-text -->
      <input id="name" name="name" required
             value="{{ request.form.get('name','') }}">
      <!-- outbound: dropdown -->
      <select id="name-select" name="name" style="display:none;" required>
        {% if request.form.get('name') %}
          <option selected>{{ request.form.get('name') }}</option>
        {% endif %}
      </select>

      <!-- Weight per Unit -->
      <label for="weight">Wt/Unit</label>
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <!-- inbound: free-text -->
        <input id="weight" name="weight" type="number" step="any" min="0" required
               value="{{ request.form.get('weight','') }}"
               style="flex:1; min-width:16ch;">

        <!-- outbound: weight dropdown -->
        <select id="weight-select" name="weight" style="display:none;" required>
          {% if request.form.get('weight') %}
            <option value="{{ request.form.get('weight') }}" selected>
              {{ request.form.get('weight') }}
            </option>
          {% endif %}
        </select>

        <!-- unit toggle (inbound only), capped width -->
        <select id="weight_unit" name="weight_unit" tabindex="-1" style="max-width:10ch;">
          <option value="lbs"
                  {% if request.form.get('weight_unit')=='lbs' or inv_weight_unit=='lbs' %}
                    selected{% endif %}>
            lbs
          </option>
          <option value="kg"
                  {% if request.form.get('weight_unit')=='kg' or inv_weight_unit=='kg' %}
                    selected{% endif %}>
            kg
          </option>
        </select>
      </div>

      <!-- Quantity -->
      <label for="qty">Quantity</label>
      <input id="qty" name="qty" type="number" step="1" min="0" required
             value="{{ request.form.get('qty','') }}">

      <button type="submit" style="grid-column: span 2; margin-top: 1rem;">
        Save Entry
      </button>
    </form>
  </div>

  <div id="inventory-detail-table"><!-- AJAX detail table loads here --></div>

  <script>
    // Load the list of past entries via AJAX
    async function loadInventoryDetail() {
      try {
        const resp = await fetch("{{ url_for('inventory.inventory_detail_table') }}");
        document.getElementById("inventory-detail-table").innerHTML = await resp.text();
      } catch (_) {}
    }
    loadInventoryDetail();

    document.addEventListener('DOMContentLoaded', () => {
      // Dynamic inventory data for outbound lookups
      let inventoryAdvancedData = {{ advanced_data|tojson }};
      const inventoryUrl = "{{ url_for('inventory.inventory_advance_data') }}";
      const lookupUrl    = "{{ url_for('inventory.api_lookup_barcode_post') }}";
      async function fetchInventory() {
        try {
          const fresh = await fetch(inventoryUrl + "?_=" + Date.now()).then(r => r.json());
          inventoryAdvancedData.stock_categories = fresh.categories;
          inventoryAdvancedData.items            = fresh.items;
          inventoryAdvancedData.sizes            = fresh.sizes;
          inventoryAdvancedData.avail            = fresh.avail;
        } catch (e) {}
      }
      // Form controls
      const dirIn        = document.getElementById('dir-in');
      const dirOut       = document.getElementById('dir-out');
      const categoryEl   = document.getElementById('category');
      const nameTxt      = document.getElementById('name');
      const nameSel      = document.getElementById('name-select');
      const weightTxt    = document.getElementById('weight');
      const weightSel    = document.getElementById('weight-select');
      const weightUnitEl = document.getElementById('weight_unit');
      const qtyFld       = document.getElementById('qty');

      let firstMode = true;
      // preserved on-error selections
      const allCats   = inventoryAdvancedData.all_categories;
      const stockCats = inventoryAdvancedData.stock_categories;
      const selectedCat = "{{ request.form.get('category','') }}";

      function updateMode() {
        const curCat = firstMode ? categoryEl.value : '';
        if (dirOut.checked) {
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            stockCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');
          nameTxt.style.display     = 'none';
          nameTxt.required          = false;
          nameTxt.disabled          = true;
          nameSel.style.display     = '';
          nameSel.required          = true;
          nameSel.disabled          = false;
          weightTxt.style.display   = 'none';
          weightTxt.required        = false;
          weightTxt.disabled        = true;
          weightSel.style.display   = '';
          weightSel.required        = true;
          weightSel.disabled        = false;
          weightSel.innerHTML       = '<option value="">Size…</option>';
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');
          const cid   = categoryEl.value;
          const items = Array.from(new Set(inventoryAdvancedData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');
          weightTxt.style.display    = 'none';
          weightTxt.required         = false;
          weightSel.style.display    = '';
          weightSel.required         = true;
          weightUnitEl.style.display = 'none';
          weightUnitEl.required      = false;
          weightUnitEl.disabled      = true;
        } else {
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            allCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');
          nameTxt.style.display     = '';
          nameTxt.required          = true;
          nameTxt.disabled          = false;
          nameSel.style.display     = 'none';
          nameSel.required          = false;
          nameSel.disabled          = true;
          weightTxt.style.display   = '';
          weightTxt.required        = true;
          weightTxt.disabled        = false;
          weightSel.style.display   = 'none';
          weightSel.required        = false;
          weightSel.disabled        = true;
          weightUnitEl.style.display  = '';
          weightUnitEl.required       = true;
          weightUnitEl.disabled       = false;
          qtyFld.removeAttribute('max');
        }
        firstMode = false;
      }
      categoryEl.addEventListener('change', e => {
        if (dirOut.checked) {
          const cid   = e.target.value;
          const items = Array.from(new Set(inventoryAdvancedData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');
        }
        const label = e.target.selectedOptions[0].text;
        if (label === 'Water') {
          if (dirOut.checked) {
            nameSel.value = 'water';
            nameSel.dispatchEvent(new Event('change'));
          } else {
            nameTxt.value = 'water';
          }
        }
      });
      [dirIn, dirOut].forEach(radio => {
        radio.addEventListener('change', updateMode);
      });
      updateMode();
      nameSel.addEventListener('change', () => {
        if (!dirOut.checked) return;
        const cid   = categoryEl.value;
        const item  = nameSel.value;
        const sizes = inventoryAdvancedData.sizes?.[cid]?.[item] || [];
        // Grab unit preference (from cookie, or default to 'lbs')
        const massPref = (document.cookie.match(/(?:^|;\s*)mass_unit=([^;]*)/) || [,'lbs'])[1];

        weightSel.innerHTML = '<option value="">Size…</option>' +
          sizes.map(sz => {
            const avail = inventoryAdvancedData.avail?.[cid]?.[item]?.[String(sz)] || 0;
            let dispSz = sz, dispAvail = avail, labelUnit = 'lb';
            if (massPref === 'kg') {
              dispSz = (parseFloat(sz) / 2.20462).toFixed(2).replace(/\.00$/,'');
              dispAvail = avail ? (parseFloat(avail) / 2.20462).toFixed(2).replace(/\.00$/,'') : avail;
              labelUnit = 'kg';
            }
            return `<option value="${sz}" data-avail="${avail}">` +
                     `${dispSz} ${labelUnit} (${dispAvail} avail)` +
                   `</option>`;
          }).join('');
      });

      const invForm = document.getElementById('inventory-form');
      function fixFieldEnabling() {
        if (dirOut.checked) {
          nameTxt.disabled    = true;
          nameSel.disabled    = false;
          weightTxt.disabled  = true;
          weightSel.disabled  = false;
        } else {
          nameTxt.disabled    = false;
          nameSel.disabled    = true;
          weightTxt.disabled  = false;
          weightSel.disabled  = true;
        }
      }
      invForm.addEventListener('submit', async e => {
        e.preventDefault();
        fixFieldEnabling();
        // Preserve direction state after reset (sticky)
        const prevDir = dirOut.checked ? 'out' : 'in';
        const form = e.target;
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form)
        });
        if (resp.ok) {
          showToast('Entry saved', 'success');
          form.reset();
          if (prevDir === 'out') dirOut.checked = true;
          else dirIn.checked = true;
          await fetchInventory();      // fetch new inventory after save
          updateMode();
          fixFieldEnabling();
          await loadInventoryDetail();
          // after saving, return focus to the first input
          if (prevDir === 'in') nameTxt.focus(); else qtyFld.focus();

        } else {
          let err = { message: 'Save failed' };
          try { err = await resp.json(); } catch (_) {}
          showToast(err.message || 'Error', 'error');
        }
      });
      [dirIn, dirOut].forEach(radio => {
        radio.addEventListener('change', () => {
          updateMode();
          fixFieldEnabling();
        });
      });
      fixFieldEnabling();
    });

  </script>

  <!-- CSRF for JSON + shared scanner JS -->
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <script defer src="{{ url_for('static', filename='js/barcode_scan.js') }}"></script>
  <audio id="beep"><source src="data:audio/mpeg;base64,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" type="audio/wav"></audio>
{% endblock %}
