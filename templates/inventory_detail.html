{% extends "base.html" %}
{% block title %}Inventory Detail – Aircraft Ops{% endblock %}

{% block content %}
  <h2>Inventory Detail</h2>
  <button type="button"
          class="back-button"
          onclick="location.href='{{ url_for('inventory.inventory_overview') }}'">
    ← Back to Overview
  </button>

  <!-- two-column form, reusing the Ramp-Boss grid styles -->
  <div class="ramp-form-container">
    <form id="inventory-form"
          method="POST"
          action="{{ url_for('inventory.inventory_detail') }}"
          autocomplete="off">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- Direction toggle: sticky at top (values now ‘in’/‘out’ to satisfy DB CHECK) -->
      <label>Direction</label>
      <div class="radio-toggle">
        <input type="radio" id="dir-in"  name="direction" value="in" {% if session.get('inv_direction','in') != 'out' %}checked{% endif %}>
        <label for="dir-in">Inbound</label>
        <input type="radio" id="dir-out" name="direction" value="out" {% if session.get('inv_direction','in') == 'out' %}checked{% endif %}>
        <label for="dir-out">Outbound</label>
      </div>

      <!-- Category -->
      <label for="category">Category</label>
      <select id="category" name="category" required>
        <option value="" disabled
                {% if not request.form.get('category') %}selected{% endif %}>
          — choose category —
        </option>
        {% for c in categories %}
          <option value="{{ c.id }}"
                  {% if request.form.get('category') == c.id|string %}selected{% endif %}>
            {{ c.display_name }}
          </option>
        {% endfor %}
      </select>

      <!-- Item Name -->
      <label for="name">Item Name</label>
      <!-- inbound: free-text -->
      <input id="name" name="name" required
             value="{{ request.form.get('name','') }}">
      <!-- outbound: dropdown -->
      <select id="name-select" name="name" style="display:none;" required>
        {% if request.form.get('name') %}
          <option selected>{{ request.form.get('name') }}</option>
        {% endif %}
      </select>

      <!-- Weight per Unit -->
      <label for="weight">Wt/Unit</label>
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <!-- inbound: free-text -->
        <input id="weight" name="weight" type="number" step="any" min="0" required
               value="{{ request.form.get('weight','') }}"
               style="flex:1; min-width:16ch;">

        <!-- outbound: weight dropdown -->
        <select id="weight-select" name="weight" style="display:none;" required>
          {% if request.form.get('weight') %}
            <option value="{{ request.form.get('weight') }}" selected>
              {{ request.form.get('weight') }}
            </option>
          {% endif %}
        </select>

        <!-- unit toggle (inbound only), capped width -->
        <select id="weight_unit" name="weight_unit" tabindex="-1" style="max-width:10ch;">
          <option value="lbs"
                  {% if request.form.get('weight_unit')=='lbs' or inv_weight_unit=='lbs' %}
                    selected{% endif %}>
            lbs
          </option>
          <option value="kg"
                  {% if request.form.get('weight_unit')=='kg' or inv_weight_unit=='kg' %}
                    selected{% endif %}>
            kg
          </option>
        </select>
      </div>

      <!-- Quantity -->
      <label for="qty">Quantity</label>
      <input id="qty" name="qty" type="number" step="1" min="0" required
             value="{{ request.form.get('qty','') }}">

      <button type="submit" style="grid-column: span 2; margin-top: 1rem;">
        Save Entry
      </button>
    </form>
  </div>

  <div id="inventory-detail-table"><!-- AJAX detail table loads here --></div>

  <script>
    // Load the list of past entries via AJAX
    async function loadInventoryDetail() {
      try {
        const resp = await fetch("{{ url_for('inventory.inventory_detail_table') }}");
        document.getElementById("inventory-detail-table").innerHTML = await resp.text();
      } catch (_) {}
    }
    loadInventoryDetail();

    document.addEventListener('DOMContentLoaded', () => {
      // Dynamic inventory data for outbound lookups
      let inventoryAdvancedData = {{ advanced_data|tojson }};
      const inventoryUrl = "{{ url_for('inventory.inventory_advance_data') }}";
      async function fetchInventory() {
        try {
          const fresh = await fetch(inventoryUrl + "?_=" + Date.now()).then(r => r.json());
          inventoryAdvancedData.stock_categories = fresh.categories;
          inventoryAdvancedData.items            = fresh.items;
          inventoryAdvancedData.sizes            = fresh.sizes;
          inventoryAdvancedData.avail            = fresh.avail;
        } catch (e) {}
      }
      // Form controls
      const dirIn        = document.getElementById('dir-in');
      const dirOut       = document.getElementById('dir-out');
      const categoryEl   = document.getElementById('category');
      const nameTxt      = document.getElementById('name');
      const nameSel      = document.getElementById('name-select');
      const weightTxt    = document.getElementById('weight');
      const weightSel    = document.getElementById('weight-select');
      const weightUnitEl = document.getElementById('weight_unit');
      const qtyFld       = document.getElementById('qty');

      let firstMode = true;
      // preserved on-error selections
      const allCats   = inventoryAdvancedData.all_categories;
      const stockCats = inventoryAdvancedData.stock_categories;
      const selectedCat = "{{ request.form.get('category','') }}";

      function updateMode() {
        const curCat = firstMode ? categoryEl.value : '';
        if (dirOut.checked) {
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            stockCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');
          nameTxt.style.display     = 'none';
          nameTxt.required          = false;
          nameTxt.disabled          = true;
          nameSel.style.display     = '';
          nameSel.required          = true;
          nameSel.disabled          = false;
          weightTxt.style.display   = 'none';
          weightTxt.required        = false;
          weightTxt.disabled        = true;
          weightSel.style.display   = '';
          weightSel.required        = true;
          weightSel.disabled        = false;
          weightSel.innerHTML       = '<option value="">Size…</option>';
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');
          const cid   = categoryEl.value;
          const items = Array.from(new Set(inventoryAdvancedData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');
          weightTxt.style.display    = 'none';
          weightTxt.required         = false;
          weightSel.style.display    = '';
          weightSel.required         = true;
          weightUnitEl.style.display = 'none';
          weightUnitEl.required      = false;
          weightUnitEl.disabled      = true;
        } else {
          categoryEl.innerHTML =
            '<option value="" disabled' + (curCat === '' ? ' selected' : '') + '>— choose category —</option>' +
            allCats.map(c =>
              `<option value="${c.id}"${c.id===curCat?' selected':''}>${c.display_name}</option>`
            ).join('');
          qtyFld.value              = '';
          qtyFld.removeAttribute('max');
          nameTxt.style.display     = '';
          nameTxt.required          = true;
          nameTxt.disabled          = false;
          nameSel.style.display     = 'none';
          nameSel.required          = false;
          nameSel.disabled          = true;
          weightTxt.style.display   = '';
          weightTxt.required        = true;
          weightTxt.disabled        = false;
          weightSel.style.display   = 'none';
          weightSel.required        = false;
          weightSel.disabled        = true;
          weightUnitEl.style.display  = '';
          weightUnitEl.required       = true;
          weightUnitEl.disabled       = false;
          qtyFld.removeAttribute('max');
        }
        firstMode = false;
      }
      categoryEl.addEventListener('change', e => {
        if (dirOut.checked) {
          const cid   = e.target.value;
          const items = Array.from(new Set(inventoryAdvancedData.items[cid] || []));
          nameSel.innerHTML = '<option value="">Item…</option>' +
            items.map(i => `<option>${i}</option>`).join('');
        }
        const label = e.target.selectedOptions[0].text;
        if (label === 'Water') {
          if (dirOut.checked) {
            nameSel.value = 'water';
            nameSel.dispatchEvent(new Event('change'));
          } else {
            nameTxt.value = 'water';
          }
        }
      });
      [dirIn, dirOut].forEach(radio => {
        radio.addEventListener('change', updateMode);
      });
      updateMode();
      nameSel.addEventListener('change', () => {
        if (!dirOut.checked) return;
        const cid   = categoryEl.value;
        const item  = nameSel.value;
        const sizes = inventoryAdvancedData.sizes?.[cid]?.[item] || [];
        // Grab unit preference (from cookie, or default to 'lbs')
        const massPref = (document.cookie.match(/(?:^|;\s*)mass_unit=([^;]*)/) || [,'lbs'])[1];

        weightSel.innerHTML = '<option value="">Size…</option>' +
          sizes.map(sz => {
            const avail = inventoryAdvancedData.avail?.[cid]?.[item]?.[String(sz)] || 0;
            let dispSz = sz, dispAvail = avail, labelUnit = 'lb';
            if (massPref === 'kg') {
              dispSz = (parseFloat(sz) / 2.20462).toFixed(2).replace(/\.00$/,'');
              dispAvail = avail ? (parseFloat(avail) / 2.20462).toFixed(2).replace(/\.00$/,'') : avail;
              labelUnit = 'kg';
            }
            return `<option value="${sz}" data-avail="${avail}">` +
                     `${dispSz} ${labelUnit} (${dispAvail} avail)` +
                   `</option>`;
          }).join('');
      });

      const invForm = document.getElementById('inventory-form');
      function fixFieldEnabling() {
        if (dirOut.checked) {
          nameTxt.disabled    = true;
          nameSel.disabled    = false;
          weightTxt.disabled  = true;
          weightSel.disabled  = false;
        } else {
          nameTxt.disabled    = false;
          nameSel.disabled    = true;
          weightTxt.disabled  = false;
          weightSel.disabled  = true;
        }
      }
      invForm.addEventListener('submit', async e => {
        e.preventDefault();
        fixFieldEnabling();
        // Preserve direction state after reset (sticky)
        const prevDir = dirOut.checked ? 'out' : 'in';
        const form = e.target;
        const resp = await fetch(form.action, {
          method: 'POST',
          headers: { 'X-Requested-With': 'XMLHttpRequest' },
          body: new FormData(form)
        });
        if (resp.ok) {
          showToast('Entry saved', 'success');
          form.reset();
          if (prevDir === 'out') dirOut.checked = true;
          else dirIn.checked = true;
          await fetchInventory();      // fetch new inventory after save
          updateMode();
          fixFieldEnabling();
          await loadInventoryDetail();
          // after saving, return focus to the first input
          if (prevDir === 'in') nameTxt.focus(); else qtyFld.focus();

        } else {
          let err = { message: 'Save failed' };
          try { err = await resp.json(); } catch (_) {}
          showToast(err.message || 'Error', 'error');
        }
      });
      [dirIn, dirOut].forEach(radio => {
        radio.addEventListener('change', () => {
          updateMode();
          fixFieldEnabling();
        });
      });
      fixFieldEnabling();
    });
  </script>
{% endblock %}
