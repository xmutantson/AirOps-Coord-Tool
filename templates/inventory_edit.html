{% extends "base.html" %}
{% block title %}Edit Inventory Entry – Aircraft Ops{% endblock %}

{% block content %}
  <h2>Edit Inventory Entry</h2>
  <button type="button"
          class="back-button"
          onclick="location.href='{{ url_for('inventory.inventory_detail') }}'">
    ← Back to Detail
  </button>

  <div class="ramp-form-container">
    <form method="POST"
          action="{{ url_for('inventory.inventory_edit', entry_id=entry.id) }}"
          data-original-cat="{{ entry.category_id }}"
          data-original-name="{{ entry.sanitized_name }}"
          data-original-wpu-lbs="{{ '%.6f' % (entry.weight_per_unit or 0) }}"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <label for="category">Category</label>
      <select id="category" name="category" required>
        {% for c in categories %}
          <option value="{{ c.id }}"
            {% if c.id==entry.category_id %}selected{% endif %}>
            {{ c.display_name }}
          </option>
        {% endfor %}
      </select>

      <label for="name">Item Name</label>
      <input id="name" name="name" required value="{{ entry.raw_name }}">

      <label for="weight">Wt/Unit</label>
      <div style="display:flex;align-items:center;gap:0.5rem;">
        <input id="weight"
               name="weight"
               type="number" step="any" min="0" required
               style="flex:1;min-width:16ch"
               value="{{
                  (entry.weight_per_unit if inv_weight_unit=='lbs'
                  else (entry.weight_per_unit/2.20462)|round(1))
               }}">
        <select id="weight_unit" name="weight_unit">
          <option value="lbs"
            {% if inv_weight_unit=='lbs' %}selected{% endif %}>lbs</option>
          <option value="kg"
            {% if inv_weight_unit=='kg' %}selected{% endif %}>kg</option>
          <option value="oz"
            {% if inv_weight_unit=='oz' %}selected{% endif %}>oz</option>
        </select>
      </div>

      <label for="qty">Quantity</label>
      <input id="qty" name="qty" type="number" step="1" min="0" required
             value="{{ entry.quantity }}">

      <label for="direction">Direction</label>
      <select id="direction" name="direction">
        <option value="in"
          {% if entry.direction=='in' %}selected{% endif %}>
          Incoming
        </option>
        <option value="out"
          {% if entry.direction=='out' %}selected{% endif %}>
          Outgoing
        </option>
      </select>

      <button type="submit" style="grid-column:span 2; margin-top:1rem;">
        Save Changes
      </button>
    </form>
  </div>
<script defer src="{{ url_for('static', filename='js/propagate.js') }}"></script>
<script>
(function(){
  const form = document.querySelector('form[action*="/inventory/edit/"]');
  if (!form) return;
  let submitting = false;
  function sanitize(s){
    return String(s||'')
      .toLowerCase()
      .replace(/[^a-z0-9\s]/g,' ')
      .replace(/\s+/g,' ')
      .trim();
  }
  function toLbs(val, unit){
    const v = parseFloat(val||'0')||0;
    if (!unit) return v;
    switch(String(unit).toLowerCase()){
      case 'kg': return v * 2.20462;
      case 'oz': return v / 16.0;
      default:   return v;
    }
  }
  form.addEventListener('submit', async (e)=>{
    if (submitting) return; // allow natural submit second time
    e.preventDefault();
    const origCat  = parseInt(form.dataset.originalCat||'0',10) || 0;
    const origName = (form.dataset.originalName||'').trim();
    const origWpu  = parseFloat(form.dataset.originalWpuLbs||'0')||0;

    const newCat   = parseInt(document.getElementById('category').value||'0',10) || 0;
    const newName  = sanitize(document.getElementById('name').value);
    const newUnit  = (document.getElementById('weight_unit').value||'lbs');
    const newWpu   = toLbs(document.getElementById('weight').value, newUnit);

    // Queue up propagation offers in order: category → name → weight
    try {
      if (window.Propagate) {
        if (origCat && newCat && newCat !== origCat && origName) {
          await window.Propagate.previewBulk('category', [origName], {new_category_id: newCat}, null);
        }
        if (origName && newName && newName !== origName) {
          await window.Propagate.previewBulk('name', [origName], {new_name: newName}, null);
        }
        if (origWpu && newWpu && Math.abs(origWpu - newWpu) > 1e-9 && origName) {
          await window.Propagate.previewBulk('weight',
            [origName],
            {new_weight_per_unit: newWpu},
            origWpu
          );
        }
      }
    } catch(_) {}

    submitting = true;
    form.submit();
  });
})();
</script>
{% endblock %}
