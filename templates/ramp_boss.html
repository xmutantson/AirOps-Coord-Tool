{% extends "base.html" %}
{% block title %}Ramp Boss Intake – Aircraft Ops{% endblock %}

{% block content %}
  <div class="ramp-form-container">
    <form id="rb-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <!-- these hidden fields power the Advanced panel -->
      <input type="hidden" id="advanced-mode" name="advanced" value="0">
      <input type="hidden" id="manifest-id"  name="manifest_id" value="">

      <!-- direction -->
      <label for="dir-out">Aircraft Direction*</label>
      <div class="radio-toggle">
        <input type="radio" id="dir-out" name="direction" value="outbound" required checked>
        <label for="dir-out">Outbound</label>
        <input type="radio" id="dir-in"  name="direction" value="inbound">
        <label for="dir-in">Inbound</label>
      </div>

      <!-- tail number + lookup -->
      <label for="tail">Tail Number*</label>
      <div class="lookup-row">
        <input id="tail" name="tail_number" required style="min-width:10ch">
        <button type="button" id="lookup">Lookup Tail</button>
      </div>

      <label for="pilot">Pilot Name</label>
      <input id="pilot" name="pilot_name" style="min-width:10ch">

      <label for="pax">PAX #</label>
      <input id="pax" name="pax_count" placeholder="e.g. 3" style="min-width:10ch">

      <label for="origin">Origin* (ALW or KALW)</label>
      <input id="origin" name="origin" required style="min-width:10ch">

      <label id="time-label" for="dep_time">Departure Time (HHMM)*</label>
      <input id="dep_time" name="dep_time" required style="min-width:10ch">

      <label for="destination">Destination* (BFI or KBFI)</label>
      <input id="destination" name="destination" required style="min-width:10ch">

      <div id="eta_block">
        <label for="eta_input">ETA (HHMM)</label>
        <input id="eta_input" name="eta" style="min-width:10ch">
      </div>

      <label for="cargo_type">Cargo Type</label>
      <input id="cargo_type" name="cargo_type" style="min-width:10ch">

      <label for="cargo_weight">Cargo Weight</label>
      <div class="lookup-row">
        <input id="cargo_weight"
               name="cargo_weight"
               placeholder="e.g. 300"
               style="flex:1; min-width:10ch">
        <select name="weight_unit" style="min-width:10ch">
          <option value="lbs" selected>lbs</option>
          <option value="kg">kg</option>
        </select>
      </div>

      <!-- Cargo Weight Tools Toggle Buttons -->
      <div class="cargo-tools-toggle">
        <button type="button" id="open-cw-tools" title="Cargo Weight Tools">
          Running Total
        </button>
        <button type="button" id="open-adv" title="Advanced Cargo Entry">
          Adv. Cargo Entry
        </button>
      </div>

      <label for="remarks">Remarks</label>
      <input id="remarks" name="remarks" style="min-width:10ch">

      <button type="submit">Save Flight</button>
    </form>

    <!-- Cargo Weight Tools Panel -->
    <div
      id="cargo-tools-panel"
      class="cargo-tools-panel"
      style="position:relative; margin-bottom:1rem; text-align:center;"
    >
      <button
        type="button"
        id="cw-back"
        style="position:absolute; left:1rem; background:none; border:none; font-size:1em; cursor:pointer;"
      >
        ← Back
      </button>
      <h4 style="margin:0; font-size:2em;">Running Cargo Total</h4>

      <div id="cw-history"></div>
      <div id="cw-total">Total: 0 lbs</div>

      <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
        <button type="button" class="cw-button cw-minus" id="cw-minus" disabled>−</button>
        <input type="number" id="cw-change" placeholder="e.g. 20" step="any" min="0" style="min-width:10ch">
        <button type="button" class="cw-button cw-plus"  id="cw-plus">+</button>
      </div>

      <button type="button" id="cw-apply" style="margin-top:0.75rem;">
        Copy to Cargo Weight
      </button>
    </div>

    <!-- Advanced Inventory Take‑over Panel -->
    <div
      id="adv-panel"
      class="cargo-tools-panel"
      style="display:none; position:relative; margin-bottom:1rem; text-align:left;"
    >
      <button
        type="button"
        id="adv-back"
        class="back-button"
        style="position:absolute; left:1rem; background:none; border:none; font-size:1em; cursor:pointer;"
      >
        ← Back
      </button>
      <h4 style="margin-top:2rem; margin-bottom:0.5rem;">Advanced Inventory Entry</h4>

      <div id="adv-line-form" style="display:flex; gap:0.5rem; align-items:center;">
        <select id="adv-category" style="min-width:10ch;">
          <option value="">Category…</option>
        </select>
        <select id="adv-item" disabled style="min-width:10ch;">
          <option value="">Item…</option>
        </select>
        <select id="adv-size" disabled style="min-width:10ch;">
          <option value="">Size…</option>
        </select>
        <input id="adv-qty"
               type="number"
               min="1"
               disabled
               placeholder="Qty"
               style="min-width:10ch;">
        <button type="button" id="adv-add-line" disabled>Add</button>
      </div>

      <div id="adv-lines" style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
        <!-- chips appear here -->
      </div>
      <button type="button" id="adv-done" disabled style="margin-top:1rem;">
        Done
      </button>
    </div>

    <div id="rb-feedback-container"></div>
  </div>

  <!-- ───────────────── Ramp‑Boss main JS (validation, lookup, CW‑tools) ───────────────── -->
  <script>
    // Ramp‑Boss form validation
    function validateRampBoss () {
      document.querySelectorAll('#rb-form .form-error').forEach(el => el.remove());
      const invalid = Array.from(document.querySelectorAll('#rb-form [required]'))
                            .filter(f => !f.value.trim());
      if (invalid.length) {
        invalid.forEach(f => f.classList.add('error'));
        const submitBtn = document.querySelector('#rb-form button[type="submit"]');
        const msg = document.createElement('div');
        msg.className = 'form-error';
        msg.textContent = 'Please fill in all required fields.';
        submitBtn.parentNode.insertBefore(msg, submitBtn.nextSibling);
        invalid[0].focus();
        return false;
      }
      return true;
    }
    document.querySelectorAll('#rb-form [required]')
            .forEach(f => f.addEventListener('input', () => f.classList.remove('error')));

    // shortcuts to DOM nodes
    const form          = document.getElementById('rb-form');
    const feedbackBox   = document.getElementById('rb-feedback-container');
    const defaultOrigin = "{{ default_origin }}";
    const depField      = document.getElementById('dep_time');
    const originField   = document.getElementById('origin');
    const destField     = document.getElementById('destination');
    const dirRadios     = [...document.querySelectorAll('input[name="direction"]')];
    const labelTime     = document.getElementById('time-label');
    const etaBlock      = document.getElementById('eta_block');
    const etaInput      = document.getElementById('eta_input');

    function applyDirUI () {
      const dir = dirRadios.find(r => r.checked).value;
      const now = new Date(),
            hh  = now.getHours().toString().padStart(2,'0'),
            mm  = now.getMinutes().toString().padStart(2,'0');

      if (dir === 'outbound') {
        labelTime.textContent  = 'Departure Time (HHMM)*';
        depField.value         = hh + mm;
        etaBlock.style.display = '';
        etaInput.value         = '';
        if (!originField.value && defaultOrigin) originField.value = defaultOrigin;
        destField.value = '';
      } else {
        labelTime.textContent  = 'Arrival Time (HHMM)*';
        depField.value         = hh + mm;
        etaBlock.style.display = 'none';
        etaInput.value         = '';
        if (!destField.value && defaultOrigin) destField.value = defaultOrigin;
        originField.value = '';
      }
    }
    dirRadios.forEach(r => r.addEventListener('change', applyDirUI));
    applyDirUI();

    // Tail‑lookup
    document.getElementById('lookup').addEventListener('click', async () => {
      const tail = form.tail_number.value.trim().toUpperCase();
      if (!tail) return showToast('Enter tail number first!', 'error');

      const res = await fetch(`/api/lookup_tail/${encodeURIComponent(tail)}`);
      if (!res.ok) return showToast('Lookup failed', 'error');

      const d = await res.json();
      if (!Object.keys(d).length)
        return showToast('No prior record for that tail.', 'error');

      if (d.airfield_takeoff) form.origin.value       = d.airfield_takeoff;
      if (d.airfield_landing) form.destination.value  = d.airfield_landing;
      if (d.pilot_name)       form.pilot_name.value   = d.pilot_name;
      if (d.pax_count)        form.pax_count.value    = d.pax_count;
      if (d.cargo_type)       form.cargo_type.value   = d.cargo_type;
      if (d.cargo_weight)     form.cargo_weight.value = d.cargo_weight;
    });

    // form submit (AJAX)
    form.addEventListener('submit', async e => {
      e.preventDefault();
      if (!validateRampBoss()) return;

      // HHMM sanity
      const t = depField.value.trim();
      if (t.length < 3 || t.length > 4 || isNaN(t)) {
        depField.classList.add('error');
        return showToast('Time must be 3–4 digits', 'error');
      }
      depField.classList.remove('error');

      const resp = await fetch(window.location.href, {
        method:  'POST',
        headers: { 'X-Requested-With':'XMLHttpRequest' },
        body:    new FormData(form)
      });
      if (!resp.ok) return showToast('Save failed', 'error');
      const f = await resp.json();

      // feedback table
      const allBlank = ['tail_number','airfield_takeoff','airfield_landing',
                        'takeoff_time','eta','cargo_type','cargo_weight','remarks']
                       .every(k => !f[k] || f[k] === 'TBD');
      const rowClass = allBlank
        ? 'red-border'
        : (f.action === 'updated' ? 'blue-border' : 'green-border');

      feedbackBox.innerHTML = `
        <table class="full-bleed">
          <thead>
            <tr>
              <th>#</th><th>Dir</th><th>Tail #</th><th>Pilot</th><th>PAX #</th>
              <th>Origin</th><th>${f.direction==='outbound'?'Dep':'Arr'} HHMM</th>
              <th>Dest</th><th>ETA</th><th>Cargo Type</th><th>Cargo Wt</th><th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            <tr class="${rowClass}">
              <td>${f.id}</td>
              <td>${f.direction}</td>
              <td>${f.tail_number}</td>
              <td>${f.pilot_name||'TBD'}</td>
              <td>${f.pax_count||'TBD'}</td>
              <td>${f.airfield_takeoff||'TBD'}</td>
              <td>${f.takeoff_time||''}</td>
              <td>${f.airfield_landing||'TBD'}</td>
              <td>${f.eta||'TBD'}</td>
              <td>${f.cargo_type||'TBD'}</td>
              <td>${f.cargo_weight||'TBD'}</td>
              <td>${f.remarks||''}</td>
            </tr>
          </tbody>
        </table>
      `;

      form.reset();
      applyDirUI();

      // reset running total
      totalCargo = 0;
      cwHistory.innerHTML = '';
      cwTotalEl.textContent = 'Total: 0 lbs';
      cwMinus.disabled = true;
    });

    /* ───────────────── Cargo‑Weight mini‑panel ───────────────── */
    const cwPanel   = document.getElementById('cargo-tools-panel');
    const openCwBtn = document.getElementById('open-cw-tools');
    const cwBack    = document.getElementById('cw-back');
    const cwMinus   = document.getElementById('cw-minus');
    const cwPlus    = document.getElementById('cw-plus');
    const cwChange  = document.getElementById('cw-change');
    const cwHistory = document.getElementById('cw-history');
    const cwTotalEl = document.getElementById('cw-total');
    const cwApply   = document.getElementById('cw-apply');
    let   totalCargo = 0;

    function recordHistory (entry) {
      const div = document.createElement('div');
      div.textContent = entry;
      cwHistory.appendChild(div);
      cwHistory.scrollTop = cwHistory.scrollHeight;
    }

    openCwBtn.addEventListener('click', () => {
      document.body.classList.toggle('cw-active');
      cwMinus.disabled = (totalCargo === 0);
    });
    cwBack.addEventListener('click',   () => document.body.classList.remove('cw-active'));
    cwApply.addEventListener('click',  () => {
      document.getElementById('cargo_weight').value = totalCargo;
      document.body.classList.remove('cw-active');
    });
    cwPlus.addEventListener('click', () => {
      const val = parseFloat(cwChange.value);
      if (isNaN(val)) return showToast('Enter a valid number', 'error');
      const change = Math.ceil(val);
      if (totalCargo === 0) {
        totalCargo = change;
        recordHistory(`Initial: ${change} lbs`);
      } else {
        const prev = totalCargo;
        totalCargo += change;
        recordHistory(`${prev} + ${change} = ${totalCargo}`);
      }
      cwTotalEl.textContent = `Total: ${totalCargo} lbs`;
      cwMinus.disabled = false;
      cwChange.value = '';
    });
    cwMinus.addEventListener('click', () => {
      const val = parseFloat(cwChange.value);
      if (isNaN(val)) return showToast('Enter a valid number', 'error');
      const change = Math.ceil(val);
      const prev = totalCargo;
      totalCargo = Math.max(0, totalCargo - change);
      recordHistory(`${prev} - ${change} = ${totalCargo}`);
      cwTotalEl.textContent = `Total: ${totalCargo} lbs`;
      cwChange.value = '';
      if (totalCargo === 0) cwMinus.disabled = true;
    });
  </script>

  <!-- initial stock snapshot for Advanced panel -->
  <script>
    let inventoryAdvancedData = {{ advanced_data|safe }};
  </script>

  <!-- ───────────────── Advanced‑panel JS (fixed & complete) ───────────────── -->
  <script>
    /* DOM helpers */
    const advBtn      = document.getElementById('open-adv');
    const advPanel    = document.getElementById('adv-panel');
    const advBack     = document.getElementById('adv-back');
    const advCat      = document.getElementById('adv-category');
    const advItem     = document.getElementById('adv-item');
    const advSize     = document.getElementById('adv-size');
    const advQty      = document.getElementById('adv-qty');
    const advAdd      = document.getElementById('adv-add-line');
    const advLines    = document.getElementById('adv-lines');
    const advDone     = document.getElementById('adv-done');
    const advMode     = document.getElementById('advanced-mode');
    const manifestId  = document.getElementById('manifest-id');
    const rbForm      = document.getElementById('rb-form');
    let   pendingIds  = [];

    const showError = msg => showToast(msg, 'error');

    /* keep stock fresh */
    setInterval(() => {
      fetch("{{ url_for('inventory.inventory_advance_data') }}")
        .then(r => r.json())
        .then(d => inventoryAdvancedData = d)
        .catch(() => {});
    }, 15_000);

    /* open panel */
    function startAdvanced () {
      const mid = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,
        c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));

      manifestId.value   = mid;
      advMode.value      = '1';
      pendingIds         = [];
      advLines.innerHTML = '';
      advDone.disabled   = true;

      if (inventoryAdvancedData?.categories) {
        advCat.innerHTML = '<option value="">Category…</option>' +
          inventoryAdvancedData.categories
            .map(c => `<option value="${c.id}">${c.display_name}</option>`)
            .join('');
      } else {
        return showError('Inventory data not loaded. Please wait and try again.');
      }

      [advItem, advSize, advQty, advAdd].forEach(el => el.disabled = true);

      rbForm.style.display = 'none';
      advPanel.style.display = 'block';
    }
    advBtn.addEventListener('click', startAdvanced);

    /* cancel panel */
    advBack.addEventListener('click', async () => {
      for (const eid of pendingIds) {
        try {
          await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
            method:'POST',
            body: new URLSearchParams({
              action:      'delete',
              manifest_id: manifestId.value,
              entry_id:    eid
            })
          });
        } catch {/* ignore */ }
      }
      advPanel.style.display = 'none';
      rbForm.style.display   = '';
    });

    /* cascaded selects */
    advCat.addEventListener('change', () => {
      const cid = advCat.value;
      advItem.disabled = false;
      advItem.innerHTML = '<option value="">Item…</option>' +
        (inventoryAdvancedData.items?.[cid] || [])
          .map(i => `<option>${i}</option>`).join('');
      [advSize, advQty, advAdd].forEach(el => el.disabled = true);
    });

    advItem.addEventListener('change', () => {
      const cid = advCat.value, it = advItem.value;
      advSize.disabled = false;
      advSize.innerHTML = '<option value="">Size…</option>' +
        (inventoryAdvancedData.sizes?.[cid]?.[it] || [])
          .map(s => `<option value="${s}">${s} lb (${(inventoryAdvancedData.avail?.[cid]?.[it]?.[s] ?? 0)} avail)</option>`)
          .join('');
      advQty.disabled = advAdd.disabled = true;
    });

    advSize.addEventListener('change', () => {
      advQty.disabled = false;
      advAdd.disabled = true;
    });
    advQty.addEventListener('input', () => {
      advAdd.disabled = (+advQty.value < 1);
    });

    /* add line */
    advAdd.addEventListener('click', async () => {
      const params = new URLSearchParams({
        action:      'add',
        manifest_id: manifestId.value,
        direction:   document.querySelector('input[name="direction"]:checked').value,
        category:    advCat.value,
        item:        advItem.value,
        size:        advSize.value,
        qty:         advQty.value
      });
      let resp;
      try {
        resp = await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
          method:'POST',
          body: params
        });
      } catch { return showError('Network error.'); }

      const j = await resp.json();
      if (!resp.ok) return showError(j.message || 'Error adding line');

      pendingIds.push(j.entry_id);

      const chip = document.createElement('div');
      chip.style.cssText = 'padding:0.25em 0.5em; background:#eee; border-radius:4px;';
      chip.textContent   = `${j.sanitized} ${j.wpu} lb×${j.qty}`;
      const rm = document.createElement('button');
      rm.textContent = '×';
      rm.style.marginLeft = '0.25em';
      rm.addEventListener('click', async () => {
        try {
          await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
            method:'POST',
            body: new URLSearchParams({
              action:      'delete',
              manifest_id: manifestId.value,
              entry_id:    j.entry_id
            })
          });
        } catch {/* ignore */ }
        chip.remove();
        pendingIds = pendingIds.filter(x => x !== j.entry_id);
        advDone.disabled = !pendingIds.length;
      });
      chip.append(rm);
      advLines.append(chip);

      /* update main form */
      const cw  = document.getElementById('cargo_weight');
      const rmf = document.getElementById('remarks');
      cw.value   = (+cw.value || 0) + j.total;
      rmf.value += `${j.sanitized} ${j.wpu} lb×${j.qty}; `;

      advDone.disabled = false;
    });

    /* commit */
    advDone.addEventListener('click', async () => {
      try {
        await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
          method:'POST',
          body: new URLSearchParams({
            action:      'commit',
            manifest_id: manifestId.value
          })
        });
      } catch { return showError('Network error committing manifest.'); }
      advPanel.style.display = 'none';
      rbForm.style.display   = '';
    });
  </script>
{% endblock %}
