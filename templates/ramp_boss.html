{% extends "base.html" %}
{% block title %}Ramp Boss Intake – Aircraft Ops{% endblock %}

{% block content %}
  <div class="ramp-form-container">
    <form id="rb-form" method="POST">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <!-- these hidden fields power the Advanced panel -->
      <input type="hidden" id="advanced-mode" name="advanced" value="0">
      <input type="hidden" id="manifest-id"  name="manifest_id" value="">

      {# ---------------- Prefill helper ---------------- #}
      {% set d = draft if draft else {} %}
      {% set dir_prefill = d.get('direction','outbound') %}

      <!-- direction -->
      <label for="dir-out">Aircraft Direction*</label>
      <div class="radio-toggle">
        <input type="radio" id="dir-out" name="direction" value="outbound" required
               {% if dir_prefill == 'outbound' %}checked{% endif %}>
        <label for="dir-out">Outbound</label>
        <input type="radio" id="dir-in"  name="direction" value="inbound"
               {% if dir_prefill == 'inbound' %}checked{% endif %}>
        <label for="dir-in">Inbound</label>
      </div>

      <!-- tail number + lookup -->
      <label for="tail">Tail Number*</label>
      <div class="lookup-row">
      <input id="tail" name="tail_number" required style="min-width:10ch" class="force-upper"
             value="{{ d.get('tail_number','') }}">
        <button type="button" id="lookup">Lookup Tail</button>
      </div>

      <label for="pilot">Pilot Name</label>
      <input id="pilot" name="pilot_name" style="min-width:10ch"
             value="{{ d.get('pilot_name','') }}">

      <label for="pax">PAX #</label>
      <input id="pax" name="pax_count" placeholder="e.g. 3" style="min-width:10ch"
             value="{{ d.get('pax_count','') }}">

      <!-- Origin – hidden when OUTBOUND -->
      <label id="label-origin" for="origin">Origin* (ALW or KALW)</label>
      <input id="origin" name="origin" required style="min-width:10ch" class="force-upper"
             value="{{ d.get('airfield_takeoff','') }}">

      <!-- hidden departure time – server sets this when the record is posted -->
      <input type="hidden" id="dep_time" name="dep_time">

      <!-- Travel-time (outbound only) – single instance -->
      <label id="travel_label" for="travel_h">Travel Time&nbsp;(HH&nbsp;:&nbsp;MM)*</label>
      <div id="travel_row" class="travel-time-row">
      {% set t_h = d.get('travel_time','')[:2] %}
      {% set t_m = d.get('travel_time','')[2:] %}
      <input id="travel_h" name="travel_h" maxlength="2"
             value="{{ t_h }}"
             placeholder="hh" pattern="[0-9]{1,2}" inputmode="numeric">
        <span>:</span>
      <input id="travel_m" name="travel_m" maxlength="2"
             value="{{ t_m }}"
             placeholder="mm" pattern="[0-9]{1,2}" inputmode="numeric">
      </div>

      <!-- Destination – hidden when INBOUND -->
      <label id="label-destination" for="destination">Destination* (BFI or KBFI)</label>
      <input id="destination" name="destination" required style="min-width:10ch" class="force-upper"
             value="{{ d.get('airfield_landing','') }}">

      <label for="cargo_type">Cargo Type</label>
      <input id="cargo_type" name="cargo_type" style="min-width:10ch"
             value="{{ d.get('cargo_type','') }}">

      <label for="cargo_weight">Cargo Weight</label>
      <div class="lookup-row">
      <input id="cargo_weight"
             name="cargo_weight"
             placeholder="e.g. 300"
             style="flex:1; min-width:10ch"
             value="{{ d.get('cargo_weight','') }}">
        <select name="weight_unit" <select name="weight_unit" tabindex="-1" style="min-width:10ch">  style="min-width:10ch">
          <option value="lbs" selected>lbs</option>
          <option value="kg">kg</option>
        </select>
      </div>

      <!-- Cargo / Manifest buttons -->
      {% if draft %}
        <div class="cargo-tools-toggle">
          <button type="button" id="edit-manifest" style="width:100%">
            ✏️ Edit Cargo Manifest
          </button>
        </div>
      {% else %}
        <div class="cargo-tools-toggle">
          <button type="button" id="open-cw-tools" title="Cargo Weight Tools">
            Running Total
          </button>
          <button type="button" id="open-adv" title="Advanced Cargo Entry">
            Adv. Cargo Entry
          </button>
        </div>
      {% endif %}

      <label for="remarks">Remarks</label>
      <input id="remarks" name="remarks" style="min-width:10ch"
             value="{{ d.get('remarks','') }}">

      <div class="form-buttons" style="margin-top:1rem; display:flex; gap:0.5rem;">
        {% if draft %}
          {# ── edit-draft mode (OUTBOUND-only) ── #}
          <button id="sendBtn" type="submit"
                  class="btn-primary"
                  name="action" value="send"
                  formaction="{{ url_for('send_queued_flight', qid=d.id) }}">
            SEND NOW
          </button>
          <button id="queueBtn" type="submit"
                  class="btn-secondary"
                  name="action" value="queue"
                  formaction="{{ url_for('edit_queued_flight', qid=d.id) }}">
            SAVE TO QUEUE
          </button>
        {% else %}
          {# ── brand-new Ramp-Boss entry ── #}
          <button id="sendBtn" type="submit"
                  class="btn-primary"
                  name="action" value="send"
                  formaction="{{ url_for('ramp_boss') }}">
            SEND NOW
          </button>
          <button id="queueBtn" type="submit"
                  class="btn-secondary"
                  name="action" value="queue"
                  formaction="{{ url_for('queue_flight') }}">
            Add To Queue
          </button>
        {% endif %}
      </div>
    </form>

    <!-- Cargo Weight Tools Panel -->
    <div
      id="cargo-tools-panel"
      class="cargo-tools-panel"
      style="position:relative; margin-bottom:1rem; text-align:center;"
    >
      <button
        type="button"
        id="cw-back"
        style="position:absolute; left:1rem; background:none; border:none; font-size:1em; cursor:pointer;"
      >
        ← Back
      </button>
      <h4 style="margin:0; font-size:2em;">Running Cargo Total</h4>

      <div id="cw-history"></div>
      <div id="cw-total">Total: 0 lbs</div>

      <div style="display:flex; align-items:center; gap:0.5rem; margin-top:0.5rem;">
        <button type="button" class="cw-button cw-minus" id="cw-minus" disabled>−</button>
        <input type="number" id="cw-change" placeholder="e.g. 20" step="any" min="0" style="min-width:10ch">
        <button type="button" class="cw-button cw-plus"  id="cw-plus">+</button>
      </div>

      <button type="button" id="cw-apply" style="margin-top:0.75rem;">
        Copy to Cargo Weight
      </button>
    </div>

    <!-- Advanced Inventory Take‑over Panel -->
    <div
      id="adv-panel"
      style="display:none; position:relative; text-align:left;"
    >

      <button
        type="button"
        id="adv-back"
        class="back-button"
        style="position:absolute; left:1rem; background:none; border:none; font-size:1em; cursor:pointer;"
      >
        ← Back
      </button>
      <h4 style="margin-top:2rem; margin-bottom:0.5rem;">Advanced Inventory Entry</h4>

      <!-- local Inbound / Outbound toggle (mirrors the main one) -->
      <div class="radio-toggle adv-dir-toggle" style="margin-bottom:0.5rem;">
        <input type="radio" id="adv-dir-out" name="adv_direction" value="outbound">
        <label for="adv-dir-out">Outbound</label>
        <input type="radio" id="adv-dir-in"  name="adv_direction" value="inbound">
        <label for="adv-dir-in">Inbound</label>
      </div>

      <div id="adv-line-form" style="display:flex; gap:0.5rem; align-items:center;">
        <select id="adv-category" style="min-width:10ch;">
          <option value="">Category…</option>
        </select>
        <!-- OUTBOUND widgets (pick from stock) -->
        <select id="adv-item"  class="adv-out" disabled style="min-width:10ch;">
          <option value="">Item…</option>
        </select>
        <select id="adv-size"  class="adv-out" disabled style="min-width:10ch;">
          <option value="">Size…</option>
        </select>

        <!-- INBOUND widgets (free entry) -->
        <input  id="adv-name"   class="adv-in"  placeholder="Item name…" style="min-width:10ch; display:none;">
        <input  id="adv-weight" class="adv-in"  type="number" min="0" step="any"
                placeholder="Wt/unit"            style="min-width:10ch; display:none;">
        <select id="adv-wunit"  class="adv-in"  style="min-width:8ch;  display:none;">
          <option value="lbs" selected>lbs</option>
          <option value="kg">kg</option>
        </select>
        <input id="adv-qty"
               type="number"
               min="1"
               disabled
               placeholder="Qty"
               style="min-width:10ch;">
        <button type="button" id="adv-add-line">Add</button>
      </div>

      <div id="adv-lines" style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
        <!-- chips appear here -->
      </div>
      <button type="button" id="adv-done" disabled style="margin-top:1rem;">
        Done
      </button>
    </div>

    <div id="rb-feedback-container"></div>
  </div>

  <!-- ───────────────── Ramp‑Boss main JS (validation, lookup, CW‑tools) ───────────────── -->
  <script>
    /* ───────────────── Prefill when editing a queued-flight draft ───────────────── */
    {% if draft %}
    /* server pushed a queued-flight draft ⇒ convert form into edit-mode */
    const draft = {{ draft|tojson }};
    document.addEventListener('DOMContentLoaded',()=> {

      /* populate fields */
      const setVal = (id,val)=>{ if(val) document.getElementById(id).value = val; };
      setVal('tail',       draft.tail_number);
      setVal('pilot',      draft.pilot_name);
      setVal('pax',        draft.pax_count);
      setVal('origin',     draft.airfield_takeoff);
      setVal('destination',draft.airfield_landing);
      setVal('cargo_type', draft.cargo_type);
      setVal('cargo_weight',draft.cargo_weight);
      setVal('remarks',    draft.remarks);
      if(draft.travel_time){
        setVal('travel_h', draft.travel_time.slice(0,2));
        setVal('travel_m', draft.travel_time.slice(2,4));
      }
      /* fix direction-toggle & resulting UI */
      document.querySelector(
        `input[name="direction"][value="${draft.direction}"]`
      ).checked = true;
      applyDirUI();
    });
    {% endif %}


    // Ramp-Boss form validation
    /* ───────── Local-time helpers (client-side; always browser TZ) ───────── */
    function nowHHMM () {
      const d = new Date();
      return d.getHours().toString().padStart(2,'0') +
             d.getMinutes().toString().padStart(2,'0');
    }
    /* addHHMM("1425","0135") → "1600"  (wraps at 24 h) */
    function addHHMM (startHHMM, deltaHHMM) {
      const sh = parseInt(startHHMM.slice(0,2),10);
      const sm = parseInt(startHHMM.slice(2),10);
      const dh = parseInt(deltaHHMM.slice(0,2),10);
      const dm = parseInt(deltaHHMM.slice(2),10);
      const total = (sh*60 + sm + dh*60 + dm) % 1440;
      return (Math.floor(total/60)).toString().padStart(2,'0') +
             (total % 60).toString().padStart(2,'0');
    }
    function validateRampBoss () {
      document.querySelectorAll('#rb-form .form-error').forEach(el => el.remove());
      const invalid = Array.from(document.querySelectorAll('#rb-form [required]'))
                            .filter(f => !f.value.trim());
      if (invalid.length) {
        invalid.forEach(f => f.classList.add('error'));
        const submitBtn = document.querySelector('#rb-form button[type="submit"]');
        const msg = document.createElement('div');
        msg.className = 'form-error';
        msg.textContent = 'Please fill in all required fields.';
        submitBtn.parentNode.insertBefore(msg, submitBtn.nextSibling);
        invalid[0].focus();
        return false;
      }
      return true;
    }
    document.querySelectorAll('#rb-form [required]')
            .forEach(f => f.addEventListener('input', () => f.classList.remove('error')));

    // shortcuts to DOM nodes
    const form          = document.getElementById('rb-form');
    /* Is this page editing an existing draft? (server injects null or ID) */
    const draftId       = {{ draft.id if draft else 'null' }};
    const feedbackBox   = document.getElementById('rb-feedback-container');
    const isEditDraft   = !!draftId;
    const defaultOrigin = "{{ default_origin }}";
    const depField    = document.getElementById('dep_time');   // hidden
    const isDraft     = {{ 'true' if draft else 'false' }};
    const travelHInp  = document.getElementById('travel_h');
    const travelMInp  = document.getElementById('travel_m');
    const travelRow   = document.getElementById('travel_row');
    const travelLabel = document.getElementById('travel_label');
    const originField = document.getElementById('origin');
    const destField   = document.getElementById('destination');
    const dirRadios   = [...document.querySelectorAll('input[name="direction"]')];
    const queueBtn    = document.getElementById('queueBtn');
    const sendBtn     = document.getElementById('sendBtn');

    function applyDirUI () {
      const dir = dirRadios.find(r => r.checked).value;
      /* make travel-time inputs required only when outbound */
      travelHInp.required = travelMInp.required = (dir === 'outbound');
      const hhmm = nowHHMM();

      /* ── show / hide Origin & Destination depending on dir ───────── */
      const labOrigin = document.getElementById('label-origin');
      const labDest   = document.getElementById('label-destination');

      if (dir === 'outbound') {          // Origin never changes for Outbound – hide it
        originField.style.display = labOrigin.style.display = 'none';
        destField.style.display   = labDest.style.display   = '';
        depField.value       = hhmm;
        travelRow.style.display   = '';
        travelLabel.style.display = '';
        if (!isDraft) travelHInp.value = travelMInp.value = '';
        if (!originField.value && defaultOrigin) originField.value = defaultOrigin;
        if (!isDraft) destField.value = '';
      } else {
        originField.style.display = labOrigin.style.display = '';
        destField.style.display   = labDest.style.display   = 'none';
        depField.value       = hhmm;
        travelRow.style.display   = 'none';
        travelLabel.style.display = 'none';
        if (!isDraft) travelHInp.value = travelMInp.value = '';
        if (!destField.value && defaultOrigin) destField.value = defaultOrigin;
        if (!isDraft) originField.value = '';
      }

      /* queue button only for outbound */
      const outbound = (dir === 'outbound');
      /* drafts are *always* outbound, but keep logic symmetrical */
      queueBtn.style.display = outbound ? '' : 'none';
      sendBtn.textContent    = outbound ? 'SEND NOW' : 'LOG ARRIVAL';

    }
    dirRadios.forEach(r => r.addEventListener('change', applyDirUI));
    applyDirUI();

    /* ───────────────── Manifest editing helpers ────────────────────────── */
    async function loadExistingManifest () {
      // pass the current session so we can merge in any newly-committed lines
      const mid = manifestId.value;
      const url = `/api/queued_manifest/${draftId}` + 
                  (mid ? `?manifest_id=${encodeURIComponent(mid)}` : '');
      const resp  = await fetch(url);
      if (!resp.ok) return;
      const rows  = await resp.json();
      rows.forEach(r => {
        // build a committed chip (NOT pending)
        const chip = document.createElement('div');
        chip.className = 'adv-chip';
        chip.dataset.pending = "0";          // ← committed snapshot row
        chip.dataset.total     = r.total;
        chip.dataset.wpu       = r.wpu;
        chip.dataset.qty       = r.qty;
        chip.dataset.sanitized = r.sanitized;
        chip.dataset.cat       = r.category_name;
        chip.innerHTML = `
          <span class="chip-content">${r.sanitized}</span>
          <button class="chip-remove" title="Remove">❌</button><br>
          <span class="chip-wpu">${r.wpu} lb</span> <span class="chip-qty">×${r.qty}</span><br>
          <span class="chip-total">= ${r.total} lb</span>
        `;
        chip.querySelector('.chip-remove').addEventListener('click', async () => {
          /* call helper that
           *  1) compensates inventory
           *  2) drops the snapshot row
           */
          let delResp;
          try {
            delResp = await fetch(`/delete_flight_cargo/${r.entry_id}`, {
              method:'POST',
              body:  new URLSearchParams({
                        csrf_token : csrfToken,
                        manifest_id: manifestId.value      // ↼ tell server the session
                     })
            });
          } catch(_) {}

          /* remember compensator so “Back” can remove it */
          try {
            const dj = await delResp.json();
            if (dj && dj.comp_id) removedIds.push(dj.comp_id);
          } catch(_){}

          /* ► mark manifest dirty & enable Done */
          chip.remove();               /* already gone visually */
          advDirty        = true;
          advDone.disabled = false;


          /* outbound stock may have changed – refresh dropdowns */
          if (document.body.dataset.advDir === 'outbound') {
            await fetchInventory();
            updateSizeOptions(advCat.value, advItem.value);
          }
        });
        advLines.appendChild(chip);
      });
      refreshFromDOM();
      // snapshot chips are real → user should be able to press “Done”
      if (advLines.childElementCount) advDone.disabled = false;
    }

    if (isEditDraft){
      const editManifestBtn = document.getElementById('edit-manifest');
      if (editManifestBtn) editManifestBtn.addEventListener('click', async () => {
        // 1️⃣ show the Advanced panel
        startAdvanced();

        // 2️⃣ remove only the _previously loaded_ (snapshot) chips—
        //    leave your pending adds/deletes intact
        advLines
          .querySelectorAll('.adv-chip[data-pending="0"]')
          .forEach(chip => chip.remove());

        // 3️⃣ now load exactly one chip per row in flight_cargo
        await loadExistingManifest();
      });
    }
    else {
      // no-op if not editing

    }

    // Tail-lookup
    document.getElementById('lookup').addEventListener('click', async () => {
      const tail = form.tail_number.value.trim().toUpperCase();
      if (!tail) return showToast('Enter tail number first!', 'error');

      const res = await fetch(`/api/lookup_tail/${encodeURIComponent(tail)}`);
      if (!res.ok) return showToast('Lookup failed', 'error');

      const d = await res.json();
      if (!Object.keys(d).length)
        return showToast('No prior record for that tail.', 'error');

      if (d.airfield_takeoff) form.origin.value       = d.airfield_takeoff;
      if (d.airfield_landing) form.destination.value  = d.airfield_landing;
      if (d.pilot_name)       form.pilot_name.value   = d.pilot_name;
      if (d.pax_count)        form.pax_count.value    = d.pax_count;
      if (d.cargo_type)       form.cargo_type.value   = d.cargo_type;
      if (d.cargo_weight)     form.cargo_weight.value = d.cargo_weight;
    });

   // ────────────────────────────────────────────────────────────────
   //  FORM SUBMIT (SEND NOW  *or*  ADD TO QUEUE)
   // ────────────────────────────────────────────────────────────────

    form.addEventListener('submit', async e => {
      e.preventDefault();
      // basic required‐field check
      if (!validateRampBoss()) return;

      /* compute where this form will POST _before_ we touch it anywhere else */
      const targetURL =
            e.submitter?.getAttribute('formaction') || form.action;

      // ── Warn if Destination not in our airport database ──
      const destVal = destField.value.trim().toUpperCase();
      if (destVal) {
        try {
          const apiResp = await fetch(
            `/api/airport_exists/${encodeURIComponent(destVal)}`
          );
          if (apiResp.ok) {
            const { exists } = await apiResp.json();
            if (!exists &&
                !confirm(`"${destVal}" is not a known airport code. Continue anyway?`)) {
              destField.focus();
              return;
            }
          }
        } catch (err) {
          console.warn('Airport lookup failed', err);
          // network or server error → still proceed
        }
      }

      // now proceed with the existing departure‐time check + POST

      const t = depField.value.trim();
      if (t.length < 3 || t.length > 4 || isNaN(t)) {
        depField.classList.add('error');
        return showToast('Time must be 3–4 digits', 'error');
      }
      depField.classList.remove('error');

      /* ── Time-field / ETA handling ─────────────────────────────────────── */
      const dir     = document.querySelector('input[name="direction"]:checked').value;
      const isQueue = (e.submitter?.value === 'queue');

      if (dir === 'outbound') {
        /* stamp *current* browser time for take-off, *right now* */
        depField.value = nowHHMM();

        /* ── when we’re inside EDIT-DRAFT mode and targeting
         *    /send_queued_flight/<id>, also send it as `takeoff_time`
         *    so the backend sees local-time immediately              ── */
        if (targetURL.includes('/send_queued_flight')) {
          let tf = form.querySelector('input[name="takeoff_time"]');
          if (!tf) {
            tf = document.createElement('input');
            tf.type  = 'hidden';
            tf.name  = 'takeoff_time';
            form.appendChild(tf);
          }
          tf.value = depField.value;
        }

        /* normalise HH/MM for maths & validation */
        travelHInp.value = travelHInp.value.padStart(2,'0');
        travelMInp.value = travelMInp.value.padStart(2,'0');

        if (isQueue) {                      /* Add to Queue → send travel_time */
        /* ensure hidden <input name="travel_time"> exists *and* is current */
        const tt = `${travelHInp.value}${travelMInp.value}`;
        let hid = form.querySelector('input[name="travel_time"]');
        if (!hid){
          hid = Object.assign(document.createElement('input'),{
            type:'hidden', name:'travel_time'
          });
          form.appendChild(hid);
        }
        hid.value = tt;
        } else {                                  /* Send Now → compute ETA   */
          const etaVal = addHHMM(depField.value,
                                 `${travelHInp.value}${travelMInp.value}`);
          let etaField = form.querySelector('input[name="eta"]');
          if (!etaField) {
            etaField = document.createElement('input');
            etaField.type = 'hidden';
            etaField.name = 'eta';
            form.appendChild(etaField);
          }
          etaField.value = etaVal;
          /* strip any travel_time hidden field so backend never sees it */
          form.querySelectorAll('input[name="travel_time"]').forEach(el => el.remove());
        }

        /* hide visible HH/MM boxes from WTForms */
        travelHInp.disabled = true;
        travelMInp.disabled = true;

      } else {                                          /* inbound – Log Arrival */
        let etaField = form.querySelector('input[name="eta"]');
        if (!etaField) {
          etaField = document.createElement('input');
          etaField.type = 'hidden';
          etaField.name = 'eta';
          form.appendChild(etaField);
        }
        etaField.value = nowHHMM();

        travelHInp.disabled = true;
        travelMInp.disabled = true;
      }

      // 2)  finish the manifest (pending → 0)
      await commitManifest();


      // 3)  post the flight (destination URL depends on which button)

      const resp = await fetch(targetURL, {
        method:  'POST',
        headers: { 'X-Requested-With':'XMLHttpRequest' },
        body:    new FormData(form)
      });
      // ── always re-enable, even if server replied 400/500 ─────────────
      travelHInp.disabled = false;
      travelMInp.disabled = false;
      if (!resp.ok) return showToast('Save failed', 'error');
      /* endpoints now return JSON for XHR; fall back gracefully */
      let j=null;
      if (resp.headers.get('content-type')?.includes('json')){
          j = await resp.json();
      }

      /* ── If back-end told us where to go, honour it and bail ───────────── */
      if (j?.redirect){
          window.location = j.redirect;
          return;
      }

      /* legacy / non-JSON branch below */
      let f = j;   /* keep old var-name for existing table logic */

      /* ── QUEUE branch: simple toast + hard reset ─────────────────── */
      if (e.submitter?.value === 'queue' && !isEditDraft){
          showToast('Flight added to queue','success');
          form.reset(); applyDirUI();
          travelHInp.value = travelMInp.value = '';
          return;                     /* skip the outbound “success row” build */
      }

      const allBlank = ['tail_number','airfield_takeoff','airfield_landing',
                        'takeoff_time','eta','cargo_type','cargo_weight','remarks']
                       .every(k => !f[k] || f[k] === 'TBD');
      const rowClass = allBlank
        ? 'red-border'
        : (f.action === 'updated' ? 'blue-border' : 'green-border');

      feedbackBox.innerHTML = `
        <table class="full-bleed">
          <thead>
            <tr>
              <th>#</th><th>Dir</th><th>Tail #</th><th>Pilot</th><th>PAX #</th>
              <th>Origin</th><th>${f.direction==='outbound'?'Dep':'Arr'} HHMM</th>
              <th>Dest</th><th>ETA</th><th>Cargo Type</th><th>Cargo Wt</th><th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            <tr class="${rowClass}">
              <td>${f.id}</td>
              <td>${f.direction}</td>
              <td>${f.tail_number}</td>
              <td>${f.pilot_name||'TBD'}</td>
              <td>${f.pax_count||'TBD'}</td>
              <td>${f.airfield_takeoff||'TBD'}</td>
              <td>${f.takeoff_time||''}</td>
              <td>${f.airfield_landing||'TBD'}</td>
              <td>${f.eta||'TBD'}</td>
              <td>${f.cargo_type||'TBD'}</td>
              <td>${f.cargo_weight||'TBD'}</td>
              <td>${f.remarks||''}</td>
            </tr>
          </tbody>
        </table>
      `;

      showToast('Flight sent','success');

      // auto‑clear success after 5s so it doesn’t stick around
      setTimeout(() => { feedbackBox.innerHTML = ''; }, 5000);

      form.reset();
      applyDirUI();

      // reset running total
      totalCargo = 0;
      cwHistory.innerHTML = '';
      cwTotalEl.textContent = 'Total: 0 lbs';
      cwMinus.disabled = true;

      // chips/manifest cleared – ready for a fresh flight
      advLines.innerHTML = '';
      manifestId.value   = '';
    });



    /* ───────────────── Cargo‑Weight mini‑panel ───────────────── */
    const cwPanel   = document.getElementById('cargo-tools-panel');
    const openCwBtn = document.getElementById('open-cw-tools');
    const cwBack    = document.getElementById('cw-back');
    const cwMinus   = document.getElementById('cw-minus');
    const cwPlus    = document.getElementById('cw-plus');
    const cwChange  = document.getElementById('cw-change');
    const cwHistory = document.getElementById('cw-history');
    const cwTotalEl = document.getElementById('cw-total');
    const cwApply   = document.getElementById('cw-apply');
    let   totalCargo = 0;

    function recordHistory (entry) {
      const div = document.createElement('div');
      div.textContent = entry;
      cwHistory.appendChild(div);
      cwHistory.scrollTop = cwHistory.scrollHeight;
    }

    if (openCwBtn) openCwBtn.addEventListener('click', () => {
      document.body.classList.toggle('cw-active');
      cwMinus.disabled = (totalCargo === 0);
    });
    if (cwBack)   cwBack.addEventListener('click',   () => document.body.classList.remove('cw-active'));
    if (cwApply)  cwApply.addEventListener('click',  () => {
      document.getElementById('cargo_weight').value = totalCargo;
      document.body.classList.remove('cw-active');
    });
    if (cwPlus)   cwPlus.addEventListener('click', () => {
      const val = parseFloat(cwChange.value);
      if (isNaN(val)) return showToast('Enter a valid number', 'error');
      const change = Math.ceil(val);
      if (totalCargo === 0) {
        totalCargo = change;
        recordHistory(`Initial: ${change} lbs`);
      } else {
        const prev = totalCargo;
        totalCargo += change;
        recordHistory(`${prev} + ${change} = ${totalCargo}`);
      }
      cwTotalEl.textContent = `Total: ${totalCargo} lbs`;
      cwMinus.disabled = false;
      cwChange.value = '';
    });
    if (cwMinus)  cwMinus.addEventListener('click', () => {
      const val = parseFloat(cwChange.value);
      if (isNaN(val)) return showToast('Enter a valid number', 'error');
      const change = Math.ceil(val);
      const prev = totalCargo;
      totalCargo = Math.max(0, totalCargo - change);
      recordHistory(`${prev} - ${change} = ${totalCargo}`);
      cwTotalEl.textContent = `Total: ${totalCargo} lbs`;
      cwChange.value = '';
      if (totalCargo === 0) cwMinus.disabled = true;
    });
  </script>

  <!-- initial stock snapshot for Advanced panel -->
  <script>
    let inventoryAdvancedData = {{ advanced_data|tojson }};
  </script>

<!-- ───────────────── Advanced‑panel JS (poll only while open) ───────────────── -->
<script>
  /* Wire the launcher only after the DOM is ready, so the node is
     definitely present even when this script executes very early. */
  document.addEventListener('DOMContentLoaded', () => {
    const advBtn = document.getElementById('open-adv');
    if (advBtn) advBtn.addEventListener('click', startAdvanced);
  });
  const advPanel   = document.getElementById('adv-panel');
  const advBack    = document.getElementById('adv-back');
  const advCat     = document.getElementById('adv-category');
  const advItem    = document.getElementById('adv-item');
  const advSize    = document.getElementById('adv-size');
  const advDirOut  = document.getElementById('adv-dir-out');
  const advDirIn   = document.getElementById('adv-dir-in');
  const advName    = document.getElementById('adv-name');
  const advWeight  = document.getElementById('adv-weight');
  const advWunit   = document.getElementById('adv-wunit');
  const advQty     = document.getElementById('adv-qty');
  const advAdd     = document.getElementById('adv-add-line');
  const advLines   = document.getElementById('adv-lines');
  const advDone    = document.getElementById('adv-done');
  const manifestId = document.getElementById('manifest-id');
  const advMode    = document.getElementById('advanced-mode');
  const rbForm     = document.getElementById('rb-form');
  let   pendingIds = [];
  let   removedIds = [];      /* ids of compensating rows created by deletes */
  let   snapshot   = null;    /* chip HTML + header fields on panel-open    */
  let   advDirty   = false;   /* ⇢ NEW: true as soon as user changes chips  */

  const csrfToken = document.querySelector('input[name="csrf_token"]').value;
  const showError = msg => showToast(msg, 'error');

  const inventoryUrl = "{{ url_for('inventory.inventory_advance_data') }}";
  let invPollTimer = null;

  function updateSizeOptions(cid, itemName) {
    advSize.disabled = false;
    advSize.innerHTML = '<option value="">Size…</option>' +
      (inventoryAdvancedData.sizes?.[cid]?.[itemName] || [])
        .map(sz => {
          const avail = inventoryAdvancedData.avail?.[cid]?.[itemName]?.[String(sz)] || 0;
          return `<option value="${sz}">${sz} lb (${avail} avail)</option>`;
        })
        .join('');
    advQty.value = '';
    advQty.disabled = true;
  }

  async function fetchInventory() {
    try {
      const fresh = await fetch(inventoryUrl + "?_=" + Date.now()).then(r => r.json());
      // Keep BOTH names so whichever the UI asks for is present
      inventoryAdvancedData.categories       = fresh.categories;   // new
      inventoryAdvancedData.stock_categories = fresh.categories;   // unchanged
      inventoryAdvancedData.items            = fresh.items;
      inventoryAdvancedData.sizes            = fresh.sizes;
      inventoryAdvancedData.avail            = fresh.avail;
      if (
        document.body.dataset.advDir === 'outbound' &&
        advCat.value && advItem.value && !advSize.value
      ) {
        updateSizeOptions(advCat.value, advItem.value);
      }
    } catch {}
  }

  function startPolling() {
    if (invPollTimer) return;
    fetchInventory();
    invPollTimer = setInterval(fetchInventory, 15000);
  }
  function stopPolling() {
    if (!invPollTimer) return;
    clearInterval(invPollTimer);
    invPollTimer = null;
  }

  function applyAdvDirUI(dir) {
    const out = dir === 'outbound';
    document.body.dataset.advDir = dir;
    document.querySelectorAll('.adv-out').forEach(el => el.style.display = out ? '' : 'none');
    document.querySelectorAll('.adv-in' ).forEach(el => el.style.display = out ? 'none' : '');
    if (out) {
      [advItem, advSize, advQty].forEach(el => el.disabled = true);
      advQty.value = '';
    } else {
      [advName, advWeight, advWunit, advQty].forEach(el => el.disabled = false);
      advName.value = '';
      advWeight.value = '';
      advQty.value = '';
    }
  }

  /* Main entry-point – now async so we can fetch inventory once if needed */
  async function startAdvanced() {
    const dir = document.querySelector('input[name="direction"]:checked').value;
    // ── 1) Re-use the session id if we already generated one earlier ──
    if (!manifestId.value) {
      manifestId.value = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,
                       c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c/4)
                         .toString(16));
      /* first open ⇒ brand-new session ⇒ clear local trackers */
      pendingIds.length  = 0;
      removedIds.length  = 0;
    }

    advDirty = false;                 // always reset the dirty flag

    /* Take a snapshot so “Back” can restore */
    snapshot = {
      cargo_type   : document.getElementById('cargo_type').value,
      cargo_weight : document.getElementById('cargo_weight').value,
      remarks      : document.getElementById('remarks').value,
      chipsHTML    : advLines.innerHTML
    };
    /* panel just opened → nothing changed yet, so keep “Done” off         */
    advDone.disabled = true;
    // use the categories payload from advanced_data; stock_categories may be undefined
    /* Accept either .categories (old) or .all_categories (new) */
    let catList = inventoryAdvancedData.categories ||
                  inventoryAdvancedData.all_categories ||
                  inventoryAdvancedData.stock_categories;   // new fallback

    /* First visit after a cold page-load?  Grab a fresh snapshot once. */
    if (!catList) {
      await fetchInventory();   // populates inventoryAdvancedData in-place
      catList =
        inventoryAdvancedData.categories || inventoryAdvancedData.all_categories;
      if (!catList) {
        return showError('Inventory data not yet loaded.');
      }
    }
    const useList = (dir === 'inbound')
      ? catList
      : (inventoryAdvancedData.stock_categories || catList);
    advCat.innerHTML = '<option value="">Category…</option>' +
      useList.map(c => `<option value="${c.id}">${c.display_name}</option>`).join('');
    /* clear “last category” helper at the start of every new manifest */
    window._lastCatName = '';
    advDirOut.checked = (dir === 'outbound');
    advDirIn.checked  = (dir === 'inbound');
    applyAdvDirUI(dir);
    rbForm.style.display   = 'none';
    advPanel.style.display = 'block';
    startPolling();
  }

  advBack.addEventListener('click', async () => {
    /* ── undo *all* provisional DB rows (adds & deletes) ── */
    /* Back = silent rollback (no compensators) */
    for (const eid of [...pendingIds, ...removedIds]) {
      try {
        await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
          method: 'POST',
          body: new URLSearchParams({
            csrf_token:  csrfToken,
            action:      'delete',
            manifest_id: manifestId.value,
            entry_id:    eid,
            purge:       '1'      /* ← also a hard delete */
          })
        });
      } catch {}
    }
    pendingIds.length = 0;
    removedIds.length = 0;

    /* all chips are now committed, so clear the pending flag */
    advLines.querySelectorAll('.adv-chip[data-pending="1"]')
            .forEach(c => c.dataset.pending = "0");

    /* restore snapshot of header fields + chips */
    if (snapshot){
      document.getElementById('cargo_type').value   = snapshot.cargo_type;
      document.getElementById('cargo_weight').value = snapshot.cargo_weight;
      document.getElementById('remarks').value      = snapshot.remarks;
      advLines.innerHTML = snapshot.chipsHTML;
      refreshFromDOM();
      window.updateAdvTotal(0);
      snapshot = null;
    }
    advMode.value = '0';
    advDirty      = false;
    advDone.disabled = true;          /* clean slate again                  */
    advPanel.style.display = '';
    rbForm.style.display   = '';
    stopPolling();
    fetchInventory();
  });

  function syncFromAdvToggle() {
    const dir = advDirOut.checked ? 'outbound' : 'inbound';
    document.querySelector(`input[name="direction"][value="${dir}"]`).checked = true;
    applyDirUI();
    applyAdvDirUI(dir);
    const useList = (dir === 'inbound')
      ? (inventoryAdvancedData.categories ||
         inventoryAdvancedData.all_categories ||
         inventoryAdvancedData.stock_categories)                     // fallback added
      : (inventoryAdvancedData.stock_categories ||
         inventoryAdvancedData.categories       ||
         inventoryAdvancedData.all_categories);
    advCat.innerHTML = '<option value="">Category…</option>' +
      useList.map(c => `<option value="${c.id}">${c.display_name}</option>`).join('');
    /* clear “last category” helper at the start of every new manifest */
    window._lastCatName = '';
  }
  advDirOut.addEventListener('change', syncFromAdvToggle);
  advDirIn .addEventListener('change', syncFromAdvToggle);
  document.querySelectorAll('input[name="direction"]').forEach(radio =>
    radio.addEventListener('change', () => {
      if (advPanel.style.display === 'block') syncFromAdvToggle();
    })
  );

  advCat.addEventListener('change', () => {
    /* remember the pretty label so the next chip can store it */
    window._lastCatName =
      advCat.options[advCat.selectedIndex]?.textContent || '';
    const cid = advCat.value;
    if (document.body.dataset.advDir === 'outbound') {
      advItem.disabled = false;
      advItem.innerHTML = '<option value="">Item…</option>' +
        (inventoryAdvancedData.items?.[cid]||[]).map(i => `<option>${i}</option>`).join('');
      [advSize, advQty].forEach(el => { el.disabled = true; el.value = ''; });
    }
  });

  advItem.addEventListener('change', () => {
    if (document.body.dataset.advDir !== 'outbound') return;
    const item = advItem.value;
    if (!item) {
      advSize.disabled = true;
      advSize.innerHTML = '<option value="">Size…</option>';
      advQty.disabled   = true;
      return;
    }
    updateSizeOptions(advCat.value, item);
  });

  advSize.addEventListener('change', () => {
    if (document.body.dataset.advDir === 'outbound') {
      advQty.disabled = false;
    }
  });

  // ← send each “Add” click up to the server with CSRF
  advAdd.addEventListener('click', async () => {
    const dirNow = advDirOut.checked ? 'outbound' : 'inbound';
    const params = new URLSearchParams({
      csrf_token:  csrfToken,
      action:      'add',
      manifest_id: manifestId.value,
      direction:   dirNow,
      category:    advCat.value,
      item:        dirNow === 'outbound' ? advItem.value   : '',
      size:        dirNow === 'outbound' ? advSize.value   : '',
      name:        dirNow === 'inbound'  ? advName.value   : '',
      weight:      dirNow === 'inbound'  ? advWeight.value : '',
      wunit:       dirNow === 'inbound'  ? advWunit.value  : '',
      qty:         advQty.value
    });

    let resp;
    try {
      resp = await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
        method: 'POST',
        body:   params
      });
    } catch {
      return showError('Network error.');
    }
    const j = await resp.json();
    if (!resp.ok) return showError(j.message || 'Error adding line');

    // ─── build the old “chip” with delete button ─────────────────────────
    pendingIds.push(j.entry_id);
    const chip = document.createElement('div');
    chip.className = 'adv-chip';
    chip.dataset.pending = "1";              // ← provisional (pending) row
    chip.setAttribute('data-total',     j.total);
    chip.setAttribute('data-wpu',       j.wpu);
    chip.setAttribute('data-qty',       j.qty);
    chip.setAttribute('data-sanitized', j.sanitized);
    chip.setAttribute('data-cat',       (window._lastCatName||''));
    chip.innerHTML = `
      <span class="chip-content">${j.sanitized}</span>
      <button class="chip-remove" title="Remove">❌</button><br>
      <span class="chip-wpu">${j.wpu} lb</span> <span class="chip-qty">×${j.qty}</span><br>
      <span class="chip-total">= ${j.total} lb</span>
    `;

    chip.querySelector('.chip-remove').addEventListener('click', async () => {
      const isPending = chip.dataset.pending === '1';
      let respDel, dj=null;
      try {
        const params = new URLSearchParams({
          csrf_token : csrfToken,
          action     : 'delete',
          manifest_id: manifestId.value,
          entry_id   : j.entry_id
        });
        if (isPending) params.set('purge', '1');   // hard-delete only for provisional rows
        respDel = await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
          method: 'POST',
          body  : params
        });
      } catch (_) {}

      /* if this was a soft-delete the backend returns {comp_id:…} */
      try {
        dj = await respDel.json();
        if (dj && dj.comp_id) removedIds.push(dj.comp_id);
      } catch(_) {}

      chip.remove();
      pendingIds = pendingIds.filter(id => id !== j.entry_id);
      advDone.disabled = !(pendingIds.length || removedIds.length || advDirty);

      // refresh outbound stock & sizes
      if (document.body.dataset.advDir === 'outbound') {
        await fetchInventory();
        updateSizeOptions(advCat.value, advItem.value);
      }

      // subtract from main form totals
      const cw  = document.getElementById('cargo_weight');
      const rmf = document.getElementById('remarks');
      cw.value  = Math.max(0, (+cw.value || 0) - j.total);
      rmf.value = rmf.value.replace(`${j.sanitized} ${j.wpu} lb×${j.qty}; `, '');
    });

    advLines.append(chip);

    /* ► any add = dirty, so allow Done */
    advDirty        = true;
    advDone.disabled = false;


    // ─── IMMEDIATELY refresh stock & rebuild size dropdown ─────────────────
    if (dirNow === 'outbound') {
      // if you want to debug, uncomment: console.log('advAdd: rebuilding sizes');
      await fetchInventory();
      updateSizeOptions(advCat.value, advItem.value);
    }

    advDone.disabled = false;

    // ─── update main form fields ───────────────────────────────────────
    const cw  = document.getElementById('cargo_weight');
    const rmf = document.getElementById('remarks');
    cw.value = (+cw.value || 0) + j.total;
    rmf.value += `${j.sanitized} ${j.wpu} lb×${j.qty}; `;

    // auto‑fill Cargo Type
    const catName = (inventoryAdvancedData.all_categories
                     || inventoryAdvancedData.categories
                     || [])
      .find(c => String(c.id) === advCat.value)
      ?.display_name || advCat.value;
    window._rbCategories = window._rbCategories || new Set();
    window._rbCategories.add(catName);
    document.getElementById('cargo_type').value =
      window._rbCategories.size === 1 ? catName : 'Mixed';

    advQty.value = '';
  });

  // “Done” simply hides the panel – leave rows pending until Send/Queue
  advDone.addEventListener('click', async () => {
    /* 1️⃣ promote any newly-added rows from pending→committed */
    if (pendingIds.length){
      await fetch("{{ url_for('inventory.inventory_advance_line') }}",{
        method:'POST',
        body: new URLSearchParams({
          csrf_token : csrfToken,
          action     : 'commit',
          manifest_id: manifestId.value
        })
      });
      pendingIds.length = 0;

      /* after we promote rows, every chip in the DOM is now committed */
      advLines.querySelectorAll('.adv-chip[data-pending="1"]')
              .forEach(chip => chip.dataset.pending = "0");
    }

    /* 1 b️⃣  commit all *compensating* delete rows we generated */
    if (removedIds.length){
      await fetch("{{ url_for('inventory.inventory_advance_line') }}",{
        method:'POST',
        body: new URLSearchParams({
          csrf_token : csrfToken,
          action     : 'commit',
          manifest_id: manifestId.value
        })
      });
    }
    removedIds.length = 0;

    /* 2️⃣ rebuild header fields (remarks / cargo_type / weight) */
    const chips = [...advLines.querySelectorAll('.adv-chip')];
    const total = chips.reduce((s,c)=> s + (+c.dataset.total||0), 0);

    document.getElementById('cargo_weight').value = total;

    const cats  = new Set(chips.map(c=> c.dataset.cat || ''));
    const cargoTypeField = document.getElementById('cargo_type');
    const remarksField   = document.getElementById('remarks');

    if (chips.length) {
      /* ── at least one chip remains ── */
      cargoTypeField.value =
        (cats.size === 1 ? [...cats][0] : 'Mixed');

      remarksField.value =
        chips.map(c =>
          `${c.dataset.sanitized} ${c.dataset.wpu} lb×${c.dataset.qty}`)
             .join('; ') + ';';
    } else {
      /* ── manifest now empty ── */
      cargoTypeField.value = '';
      remarksField.value   = '';
    }

    /* 3️⃣ hide panel */
    snapshot   = null;
    advDirty   = false;
    /* Done has actually saved changes, so disable only if NOTHING left */
    advDone.disabled = !(pendingIds.length || removedIds.length);
    advPanel.style.display = '';
    rbForm.style.display   = '';
    stopPolling();
  });

  /* helper: commit all pending rows for this manifest */
  async function commitManifest() {
    if (!pendingIds.length && !removedIds.length) return; /* nothing to do */
    try {
      await fetch("{{ url_for('inventory.inventory_advance_line') }}", {
        method:'POST',
        body: new URLSearchParams({
          csrf_token:  csrfToken,
          action:      'commit',
          manifest_id: manifestId.value
        })
      });
      pendingIds.length = 0;
      removedIds.length = 0;
      advDirty          = false;
    } catch {
      showToast('Network error committing manifest.', 'error');
      throw new Error('commit-failed');
    }
  }
</script>

<style>
  .travel-time-row{display:flex;gap:4px;align-items:center}
  .travel-time-row input{flex:1 1 0;min-width:3ch;text-align:center}
  .travel-time-row span{font-weight:bold}
</style>

  {{ super() }}
  <style>
    /* Subtle pill that sits next to the Advanced “Done” control */
    .adv-total-pill{
      display:inline-flex; align-items:center; gap:.25rem;
      font-weight:600; font-size:0.95rem;
      padding:.25rem .6rem; white-space:nowrap;
      border:1px solid #e5e7eb; border-radius:9999px;
      background:#f8fafc; margin-left:.5rem;
    }
    @media (prefers-color-scheme: dark){
      .adv-total-pill{ background:#111827; border-color:#374151; }
    }
  </style>
  <script>
  (function(){
    function ensurePill(){
      var pill = document.getElementById('adv-total-pill');
      if (pill) return pill;
      pill = document.createElement('span');
      pill.id = 'adv-total-pill';
      pill.className = 'adv-total-pill';
      pill.title = 'Sum of all Advanced chips for this manifest';
      pill.innerHTML = 'Total: <span class="val">0</span> lbs';
      // Try to place it right after the Advanced “Done” control.
      // include your real #adv-done and panel #adv-panel
      var doneBtn = document.querySelector(
        '#adv-done, ' +
        '#advanced-cargo #adv-done, ' +
        '[data-role="adv-done"], ' +
        '#advanced-cargo button.adv-done'
      );
      if (doneBtn && doneBtn.parentNode) {
        doneBtn.parentNode.insertBefore(pill, doneBtn.nextSibling);
      } else {
        var panel = document.querySelector('#adv-panel') ||
                    document.querySelector('#advanced-cargo, .advanced-panel') ||
                    document.body;
        panel.appendChild(pill);
      }
      return pill;
    }
    function setTotal(val){
      var pill = ensurePill();
      var n = Math.round((+val)||0);
      var slot = pill.querySelector('.val');
      if (slot) slot.textContent = n;
    }
    function sumFromDOM(){
      // Prefer explicit data-total values on chips if present…
      var root = document.querySelector('#adv-lines, #adv-chips, #adv-selected, .adv-chips, .manifest-chips');
      if (!root) return 0;
      var sum = 0;
      root.querySelectorAll('[data-total]').forEach(function(n){
        sum += parseFloat(n.getAttribute('data-total')) || 0;
      });
      if (sum > 0) return sum;
      // …fallback: parse "25 lb×3" / "25 lbs x 3" patterns from text.
      root.querySelectorAll('*').forEach(function(n){
        var t = (n.textContent || '').toLowerCase();
        var m = t.match(/(\d+(?:\.\d+)?)\s*lb[s]?\s*[×x]\s*(\d+)/i);
        if (m) sum += (parseFloat(m[1]) * parseInt(m[2],10));
      });
      return sum;
    }
    function refreshFromDOM(){ setTotal(sumFromDOM()); }

    // Observe Advanced chip list for changes to keep total in sync.
    document.addEventListener('DOMContentLoaded', function(){
      ensurePill();
      refreshFromDOM();
      var root = document.querySelector('#adv-lines, #adv-chips, #adv-selected, .adv-chips, .manifest-chips');
      if (root) {
        var mo = new MutationObserver(function(){ refreshFromDOM(); });
        mo.observe(root, {childList:true, subtree:true, characterData:true});
      }
    });

    // Intercept calls to the Advanced line endpoint to use server-provided totals.
    (function hookFetch(){
      if (!window.fetch) return;
      var orig = window.fetch;
      window.fetch = function(resource, init){
        var isAdv = (typeof resource === 'string' && resource.indexOf('/_advance_line') !== -1);
        return orig.apply(this, arguments).then(function(resp){
          if (isAdv) {
            try {
              resp.clone().json().then(function(data){
                if (data && typeof data.manifest_total !== 'undefined') setTotal(data.manifest_total);
                else refreshFromDOM();
              }).catch(refreshFromDOM);
            } catch(_) {}
          }
          return resp;
        });
      };
    })();
    (function hookJQ(){
      if (!window.jQuery || !jQuery.post) return;
      var orig = jQuery.post;
      jQuery.post = function(url, data, success, dataType){
        var isAdv = (typeof url === 'string' && url.indexOf('/_advance_line') !== -1);
        var cb = function(resp){
          if (isAdv && resp && typeof resp.manifest_total !== 'undefined') setTotal(resp.manifest_total);
          else refreshFromDOM();
          if (typeof success === 'function') success(resp);
        };
        return orig.call(this, url, data, cb, dataType);
      };
    })();

    // Optional global in case other scripts want to push an update explicitly.
    window.updateAdvTotal = setTotal;
    // expose for use in loadExistingManifest()
    window.refreshFromDOM = refreshFromDOM;
  })();
  </script>

{% endblock %}
