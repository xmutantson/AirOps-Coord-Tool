{% extends "base.html" %}
{% block title %}Wargame — Inventory{% endblock %}

{% block content %}
<main class="container">
  <h1>Wargame — Inventory Specialist</h1>

  <section>
    <h2>Incoming deliveries</h2>
    {% if incoming_deliveries and incoming_deliveries|length > 0 %}
      {% for b in incoming_deliveries %}
        <article class="wg-card">
          <div class="wg-card-head">
            <strong>Created:</strong> {{ b.created_at }}
          </div>
          {% if b.lines and b.lines|length > 0 %}
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Size</th>
                  <th>Req</th>
                  <th>Done</th>
                </tr>
              </thead>
              <tbody>
                {% for ln in b.lines %}
                  <tr class="{% if ln.qty_done >= ln.qty_required %}done{% endif %}">
                    <td>{{ ln.name }}</td>
                    <td>{{ ln.size_lb }} lb</td>
                    <td>{{ ln.qty_required }}</td>
                    <td>{{ ln.qty_done }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <pre class="muted" style="white-space:pre-wrap;">{{ b.manifest }}</pre>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No incoming deliveries are waiting.</p>
    {% endif %}
  </section>

  <section style="margin-top:1.5rem;">
    <h2>Outgoing requests</h2>
    {% if outgoing_requests and outgoing_requests|length > 0 %}
      {% for b in outgoing_requests %}
        <article class="wg-card">
          <div class="wg-card-head">
            <strong>Created:</strong> {{ b.created_at }}
          </div>
          {% if b.lines and b.lines|length > 0 %}
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Size</th>
                  <th>Req</th>
                  <th>Done</th>
                </tr>
              </thead>
              <tbody>
                {% for ln in b.lines %}
                  <tr class="{% if ln.qty_done >= ln.qty_required %}done{% endif %}">
                    <td>{{ ln.name }}</td>
                    <td>{{ ln.size_lb }} lb</td>
                    <td>{{ ln.qty_required }}</td>
                    <td>{{ ln.qty_done }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <pre class="muted" style="white-space:pre-wrap;">{{ b.manifest }}</pre>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No outgoing requests are waiting.</p>
    {% endif %}
  </section>

  <!-- Exit role -->
  <form class="wg-exit-form" action="{{ url_for('wargame_exit_role') }}" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow"
            onclick="return confirm('Exit your role and choose a new one?');">
      Exit role
    </button>
  </form>
</main>

<!-- Visibility-aware SSE: connect only while visible; clean up when hidden/unloading -->
<script>
(function(){
  const URL = "{{ url_for('inventory_events') }}";
  let es = null;
  let reconnectTimer = null;
  let reloading = false;

  function debounceReload() {
    if (reloading) return;
    reloading = true;
    setTimeout(() => { window.location.reload(); }, 200);
  }

  function connect() {
    if (es || document.hidden) return;
    try {
      es = new EventSource(URL);
      es.addEventListener('inv_commit', debounceReload);
      es.onerror = () => {
        cleanup();
        scheduleReconnect();
      };
    } catch (e) {
      cleanup();
      scheduleReconnect();
    }
  }

  function cleanup() {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
    if (es) {
      try { es.close(); } catch (_) {}
      es = null;
    }
  }

  function scheduleReconnect() {
    if (document.hidden) return;            // reconnect only if visible
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(() => { reconnectTimer = null; connect(); }, 4000);
  }

  // Connect only when the tab is visible; tear down when hidden.
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) cleanup();
    else connect();
  });

  // Clean up when navigating away / closing.
  window.addEventListener('beforeunload', cleanup);

  // Initial connect if visible.
  if (!document.hidden) connect();
})();
</script>
{% endblock %}
