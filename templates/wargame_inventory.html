{% extends "base.html" %}
{% block title %}Wargame — Inventory{% endblock %}

{% block content %}
<main class="container wg-inventory">
  <h1>Wargame — Inventory Specialist</h1>

  <section>
    <h2>Incoming deliveries</h2>
    {% if incoming_deliveries and incoming_deliveries|length > 0 %}
      {% for b in incoming_deliveries %}
        <article class="wg-card">
          <div class="wg-card-head">
            <strong>Created:</strong> {{ b.created_at }}
          </div>
          {% if b.lines and b.lines|length > 0 %}
            <ul class="lines">
              {% for ln in b.lines %}
                <li class="{% if ln.qty_done >= ln.qty_required %}done{% endif %}">
                  <span class="name">{{ ln.name }} <small>{{ ln.size_lb }} lb</small></span>
                  <span class="meta">{{ ln.qty_done }} / {{ ln.qty_required }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <pre class="muted" style="white-space:pre-wrap;">{{ b.manifest }}</pre>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No incoming deliveries are waiting.</p>
    {% endif %}
  </section>

  <section style="margin-top:1.5rem;">
    <h2>Outgoing requests</h2>
    {% if outgoing_requests and outgoing_requests|length > 0 %}
      {% for b in outgoing_requests %}
        <article class="wg-card">
          <div class="wg-card-head">
            <strong>Created:</strong> {{ b.created_at }}
          </div>
          {% if b.lines and b.lines|length > 0 %}
            <ul class="lines">
              {% for ln in b.lines %}
                <li class="{% if ln.qty_done >= ln.qty_required %}done{% endif %}">
                  <span class="name">{{ ln.name }} <small>{{ ln.size_lb }} lb</small></span>
                  <span class="meta">{{ ln.qty_done }} / {{ ln.qty_required }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <pre class="muted" style="white-space:pre-wrap;">{{ b.manifest }}</pre>
          {% endif %}
        </article>
      {% endfor %}
    {% else %}
      <p class="muted">No outgoing requests are waiting.</p>
    {% endif %}
  </section>

  <!-- Exit role -->
  <form class="wg-exit-form" action="{{ url_for('wargame_exit_role') }}" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow"
            onclick="return confirm('Exit your role and choose a new one?');">
      Exit role
    </button>
  </form>
</main>

<!-- Visibility-aware SSE: connect only while visible; clean up when hidden/unloading -->
<script>
(function(){
  const URL = "{{ url_for('inventory_events') }}";
  let es = null;
  let reconnectTimer = null;
  let reloading = false;

  function cleanup() {
    if (reconnectTimer) { clearTimeout(reconnectTimer); reconnectTimer = null; }
    if (es) { try { es.close(); } catch(_) {} es = null; }
  }

  function debounceReload() {
    if (reloading) return;
    reloading = true;
    cleanup();
    setTimeout(() => { window.location.reload(); }, 50);
  }

  function connect() {
    if (es || document.hidden) return;
    try {
      es = new EventSource(URL);
      es.addEventListener('inv_commit', debounceReload);
      es.onerror = () => { cleanup(); scheduleReconnect(); };
    } catch (e) { cleanup(); scheduleReconnect(); }
  }

  function scheduleReconnect() {
    if (document.hidden) return;
    if (reconnectTimer) return;
    reconnectTimer = setTimeout(() => { reconnectTimer = null; connect(); }, 4000);
  }

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) cleanup();
    else connect();
  });

  window.addEventListener('beforeunload', cleanup);
  if (!document.hidden) connect();
})();
</script>
{% endblock %}
