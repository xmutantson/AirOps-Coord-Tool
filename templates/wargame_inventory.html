{% extends "base.html" %}
{% block title %}Wargame · Inventory{% endblock %}
{% block content %}
  <h1>Wargame — Inventory Specialist</h1>

  {% if incoming_deliveries %}
    <h2>Incoming Deliveries</h2>
    <div class="card-container">
      {% for b in incoming_deliveries %}
        <div class="card">
          <p><strong>Created (UTC):</strong> {{ b.created_at }}</p>
          <p><strong>Manifest:</strong></p>
          <ul class="tight">
            {% for line in b.lines %}
              {% set done = (line.qty_done >= line.qty_required) %}
              <li{% if done %} class="done"{% endif %}>
                {{ line.name }} {{ line.size_lb|int }} lb × {{ line.qty_required }}
                {% if line.qty_done %} — {{ line.qty_done }}/{{ line.qty_required }} done{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p><em>No inbound deliveries at the moment.</em></p>
  {% endif %}

  <hr class="separator" />

  {% if outgoing_requests %}
    <h2>Outbound Requests</h2>
    <div class="card-container">
      {% for b in outgoing_requests %}
        <div class="card">
          <p><strong>Created (UTC):</strong> {{ b.created_at }}</p>
          <p><strong>Manifest:</strong></p>
          <ul class="tight">
            {% for line in b.lines %}
              {% set done = (line.qty_done >= line.qty_required) %}
              <li{% if done %} class="done"{% endif %}>
                {{ line.name }} {{ line.size_lb|int }} lb × {{ line.qty_required }}
                {% if line.qty_done %} — {{ line.qty_done }}/{{ line.qty_required }} done{% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p><em>No outbound requests at the moment.</em></p>
  {% endif %}

  <form id="wg-exit-form"
        class="wg-exit"
        method="post"
        action="{{ url_for('wargame_exit_role') }}"
        onsubmit="return confirm('Exit your Wargame role and choose a new one?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow">Exit Role</button>
  </form>

  <script>
  // Subscribe to Inventory SSE and refresh on change.
  document.addEventListener('DOMContentLoaded', function () {
    if (window.__invSseInit) return;
    window.__invSseInit = true;
    try {
    const es = new EventSource('{{ url_for("inventory_sse") }}');
      let pending = false;
      es.onmessage = function () {
        // If tab is hidden, defer; otherwise refresh immediately.
        if (document.visibilityState === 'hidden') { pending = true; return; }
        location.reload();
      };
      document.addEventListener('visibilitychange', function () {
        if (document.visibilityState === 'visible' && pending) {
          pending = false;
          location.reload();
        }
      });
      es.onerror = function () { /* browser will retry automatically */ };
    } catch (e) { /* no-op */ }
  });
  </script>
{% endblock %}
