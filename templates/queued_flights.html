{% extends "base.html" %}
{% block title %}Queued Flights – Aircraft Ops{% endblock %}

{% block content %}
  <div class="page-header-bar">
    <span class="page-title">Queued Flights</span>
    <!-- Quick Add: tail required, pilot optional (default outbound on server) -->
    <form id="quick-add-form"
          style="display:flex; gap:0.5rem; margin-top:0.5rem; align-items:center; flex-wrap:nowrap;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input name="tail_number" class="force-upper" type="text"
             placeholder="Tail"
             style="flex:0 0 auto; width:12ch; min-width:8ch; padding:0.35em 0.5em; border-radius:4px; border:1px solid #ccc;"
             autocomplete="off" required>
      <input name="pilot_name" type="text"
             placeholder="Pilot (optional)"
             style="flex:0 0 auto; width:20ch; min-width:12ch; padding:0.35em 0.5em; border-radius:4px; border:1px solid #ccc;"
             autocomplete="off">
      <button type="submit" class="btn-primary" style="flex:0 0 auto; padding:0.45em 0.9em;">
        Quick Add
      </button>
    </form>
    <script>
      document.getElementById('quick-add-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        try {
          const resp = await fetch('{{ url_for("ramp.queue_quick_add") }}', { method:'POST', body: fd, headers:{ 'X-Requested-With':'XMLHttpRequest' }});
          if (!resp.ok) { const {message} = await resp.json().catch(() => ({})); alert(message || 'Quick Add failed'); return; }
          e.target.reset();
          refreshQueued();
        } catch (err) { console.error(err); alert('Network error while adding draft'); }
      });
    </script>
    <form id="filter-form"
          style="display:flex; gap:0.5rem; margin-top:0.5rem; width:100%;">
      <input
        id="tail-filter"
        name="tail_filter"
        class="force-upper"
        type="text"
        placeholder="Filter tail (comma-separated)…"
        value="{{ tail_filter or '' }}"
        style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
        autocomplete="off">
      <input
        id="airport-filter"
        name="airport_filter"
        class="force-upper"
        type="text"
        placeholder="Filter destination (comma-separated… accepts ICAO/IATA/FAA)"
        value="{{ airport_filter or '' }}"
        style="flex:1; padding:0.4em; border-radius:4px; border:1px solid #ccc;"
        autocomplete="off">
      <button type="submit"
              class="btn-secondary"
              style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;">
        Apply filters
      </button>
      <button type="button"
              id="clear-filters"
              class="danger"
              style="flex:0 0 auto; padding:0.5em 1em; align-self:stretch;">
        Clear filters
      </button>
    </form>
  </div>

  <div id="queued-container" class="{% if tail_filter or airport_filter %}filtered{% endif %}">
    {% if tail_filter or airport_filter %}
      <div id="filter-banner" class="filter-banner">
        <strong>⚠️ Filtered view:</strong>
        {% if tail_filter %}
          <span class="filter-tag">Tail: {{ tail_filter }}</span>
        {% endif %}
        {% if airport_filter %}
          <span class="filter-tag">Airport: {{ airport_filter }}</span>
        {% endif %}
      </div>
    {% endif %}
    <div id="queued-table"></div>
  </div>

  <script>
    // ---------- helpers (same math used in Ramp-Boss) ----------
    function nowHHMM () {
      const d = new Date();
      return d.getHours().toString().padStart(2,'0') +
             d.getMinutes().toString().padStart(2,'0');
    }
    function addHHMM (start, delta) {  // “1425” + “0135” => “1600”
      const sh = +start.slice(0, 2), sm = +start.slice(2);
      const dh = +delta.slice(0, 2), dm = +delta.slice(2);
      const tot = (sh * 60 + sm + dh * 60 + dm) % 1440;
      return String(Math.floor(tot / 60)).padStart(2, '0') +
             String(tot % 60).padStart(2, '0');
    }

    // Re-attach send-form handlers after each refresh
    function attachSendFormHandlers(root) {
      (root || document).querySelectorAll('form.q-send-form').forEach(f => {
        // Avoid stacking multiple listeners across refreshes
        if (f._aoctBound) return;
        f._aoctBound = true;
        f.addEventListener('submit', () => {
          const dep = nowHHMM();
          const tt  = f.dataset.tt || '';
          const eta = tt.length === 4 ? addHHMM(dep, tt) : '';
          [['takeoff_time', dep], ['eta', eta]].forEach(([n, v]) => {
            if (!v) return;
            const inp = document.createElement('input');
            inp.type = 'hidden'; inp.name = n; inp.value = v;
            f.appendChild(inp);
          });
        });
      });
    }

    async function refreshQueued() {
      try {
        const resp = await fetch(
          '{{ url_for("ramp.queued_flights_table_partial") }}' + window.location.search
        );
        if (!resp.ok) throw new Error(resp.status);
        const html = await resp.text();
        const container = document.getElementById('queued-table');
        container.innerHTML = html;
        attachSendFormHandlers(container);
      } catch (err) {
        console.error('Queued refresh failed:', err);
      }
    }

    // initial + periodic refresh
    refreshQueued();
    setInterval(refreshQueued, 30000);

    // Filter form behavior (dashboard-style normalization)
    document.getElementById('filter-form').addEventListener('submit', e => {
      e.preventDefault();
      const form = e.target;
      const qs = new URLSearchParams(window.location.search);
      const norm = name => Array.from(
        form[name].value.split(',')
          .map(s => s.trim().toUpperCase())
          .filter(Boolean)
      ).join(',');
      const tails = norm('tail_filter');
      if (tails) qs.set('tail_filter', tails); else qs.delete('tail_filter');
      const aps = norm('airport_filter');
      if (aps) qs.set('airport_filter', aps); else qs.delete('airport_filter');
      window.location.search = qs.toString();
    });

    document.getElementById('clear-filters').addEventListener('click', () => {
      document.getElementById('tail-filter').value = '';
      document.getElementById('airport-filter').value = '';
      const qs = new URLSearchParams(window.location.search);
      qs.delete('tail_filter');
      qs.delete('airport_filter');
      window.location.search = qs.toString();
    });

    // Optional: wiggle banner like dashboard
    const banner = document.getElementById('filter-banner');
    if (banner) {
      setInterval(() => {
        banner.classList.add('wiggle');
        setTimeout(() => banner.classList.remove('wiggle'), 500);
      }, 10000);
    }
  </script>
{% endblock %}
