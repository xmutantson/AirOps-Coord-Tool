{% extends "base.html" %}
{% block title %}Send Flight {{ flight['flight_code'] or flight['tail_number'] }} ‚Äì Aircraft Ops{% endblock %}
{% block content %}
  <div style="margin-bottom:20px">
    <button onclick="location.href='{{ url_for('radio.radio') }}'">‚Ü©Ô∏è Out-box</button>
    <button onclick="location.href='{{ url_for('core.dashboard') }}'">Dashboard</button>
  </div>

<h2>Flight {{ flight['tail_number'] }} ‚Äî Code {{ flight['flight_code'] or 'TBD' }}</h2>

<h3>Subject</h3>
<div class="radio-content-box">
  <pre id="subj">{{ subject_text }}</pre>
</div>
<button type="button" onclick="copyText('subj','feedback-subj')">
  Copy Subject
</button>
<span id="feedback-subj" class="copy-feedback"></span>

<h3>Body</h3>
<div class="radio-content-box">
  <pre id="body">{{ body_text }}</pre>
</div>
<button type="button" onclick="copyText('body','feedback-body')">
  Copy Body
</button>
<span id="feedback-body" class="copy-feedback"></span>

{# ‚Äî Send via WinLink ‚Äî #}
{% if winlink_configured %}
  {% if winlink_job_active %}
    <form method="POST"
          action="{{ url_for('winlink.winlink_send', flight_id=flight['id']) }}"
          style="display:inline;margin-left:1em;"
          onsubmit="return lockSubmit(this)">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-primary" data-single-submit>
        üìù Send via WinLink
      </button>
    </form>
  {% else %}
    <button
      type="button"
      class="btn btn-secondary"
      style="display:inline;margin-left:1em;"
      onclick="alert('You must start WinLink polling before sending.')"
      title="Enable WinLink polling first">
      üìù Send via WinLink
    </button>
  {% endif %}
{% endif %}

<form method="POST" action="{{ url_for('radio.mark_sent', fid=flight['id']) }}" onsubmit="return lockSubmit(this)">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <button type="submit" onclick="return confirm('Mark this message as SENT?')" data-single-submit>
    ‚úÖ Mark Sent
  </button>
</form>

<script>
function copyText(srcId, feedbackId) {
  const txt = document.getElementById(srcId).innerText;
  const fb  = document.getElementById(feedbackId);

  const showCheck = () => {
    fb.textContent = '‚úî Copied!';
    fb.classList.add('visible');
    setTimeout(() => fb.classList.remove('visible'), 2000);
  };

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(txt)
      .then(showCheck)
      .catch(() => fallbackCopy(txt, showCheck));
  } else {
    fallbackCopy(txt, showCheck);
  }
}

function fallbackCopy(text, cb) {
  const ta = document.createElement('textarea');
  ta.value = text;
  document.body.appendChild(ta);
  ta.select();
  try { document.execCommand('copy'); }
  catch (err) { /* swallow */ }
  document.body.removeChild(ta);
  cb();
}
</script>

<script>
// Prevent accidental double-submits on both forms
function lockSubmit(formEl) {
  // only lock if the confirm (if any) passed and we're actually submitting
  const btn = formEl.querySelector('button[type="submit"][data-single-submit]');
  if (btn && !btn.disabled) {
    btn.disabled = true;
    btn.dataset.originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Working‚Ä¶';
  }
  return true; // allow the submit to proceed
}
</script>

{% endblock %}
