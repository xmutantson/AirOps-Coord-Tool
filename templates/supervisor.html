{% extends "base.html" %}
{% block title %}Supervisor – Aircraft Ops{% endblock %}
{% block content %}
<div class="supervisor-dashboard" style="margin-top:1rem; height: calc(100vh - 6rem);">
  <div id="supervisor-counts" class="supervisor-panel">
    <!-- small tool links bar (top-left tile) -->
    <div class="panel-toolbar" style="display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; margin-bottom:.5rem;">
      <a href="{{ url_for('staff.staff_list', window='all') }}" class="button small" style="padding:.25rem .5rem; border:1px solid #ccc; border-radius:.4rem; text-decoration:none; font-size:.9rem;">
        Duty Roster
      </a>
      <a href="{{ url_for('comms.comms_index', window='all') }}" class="button small" style="padding:.25rem .5rem; border:1px solid #ccc; border-radius:.4rem; text-decoration:none; font-size:.9rem;">
        Communications Log
      </a>
      <button id="btn-locate-flight" type="button" class="button small"
              style="padding:.25rem .5rem; border:1px solid #2b6; color:#084; background:#eaf9f1; border-radius:.4rem; font-size:.9rem; cursor:pointer;">
        Locate Flight
      </button>
    </div>
    <!-- Recent locate requests (quick access) -->
    <div id="supervisor-locates-card"><!-- loads via AJAX --></div>
    <div id="supervisor-counts-body"><!-- counts load here --></div>
  </div>
  <div id="supervisor-map" class="supervisor-panel">
    {% if embedded_url %}
      <iframe src="{{ embedded_url }}"
              style="width:100%; height:100%; border:1px solid #ccc;"></iframe>
    {% else %}
      <div class="muted" style="padding:1rem; text-align:center;">
        No ADS-B map configured
      </div>
    {% endif %}
  </div>
  <div id="inventory-table" class="supervisor-panel"><!-- inventory overview --></div>
  <div id="supervisor-recent-flights" class="supervisor-panel">
    <h3 style="text-align:center; margin-top:0; margin-bottom:1rem;">Priority Flights</h3>
    <!-- recent flights table will be injected here -->
  </div>
</div>

  <!-- Locate Flight Modal -->
  <div id="locate-modal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:5000;">
    <div class="modal-card" style="max-width:680px; margin:6vh auto; background:#fff; border-radius:.5rem; box-shadow:0 12px 40px rgba(0,0,0,.2); overflow:hidden;">
      <div style="padding:.75rem 1rem; border-bottom:1px solid #eee; font-weight:600;">Initiate Locate</div>
      <form id="locate-form" style="padding:1rem;">
        <!-- Step 1: collect tail -->
        <div id="locate-step1">
          <label for="locate-tail" style="display:block; font-size:.9rem; color:#333; margin-bottom:.35rem;">Tail number (e.g., N428K7)</label>
          <input id="locate-tail" name="tail" type="text" placeholder="N123AB" autocomplete="off"
                 style="width:100%; padding:.5rem .6rem; border:1px solid #ccc; border-radius:.35rem; font-size:1rem; letter-spacing:.5px; text-transform:uppercase;" />
          <div id="locate-hint" class="muted" style="margin-top:.5rem; font-size:.85rem;">
            Builds an <em>AOCT flight query</em> you can copy/paste if offline,
            or send via PAT Winlink now if online.
          </div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
            <button type="button" id="locate-cancel" class="button" style="padding:.4rem .7rem; border:1px solid #ccc; background:#fafafa; border-radius:.35rem; cursor:pointer;">Cancel</button>
            <button type="submit" id="locate-preview" class="button" style="padding:.4rem .7rem; border:1px solid #2b6; background:#25d366; color:#073; border-radius:.35rem; cursor:pointer;">Continue</button>
          </div>
        </div>

        <!-- Step 2: offline-friendly confirmation screen -->
        <div id="locate-step2" style="display:none;">
          <div class="muted" style="font-size:.9rem; margin-bottom:.5rem;">
            <strong>Confirmation:</strong> Copy the subject/body below to send manually if the internet is down.
            When you’re back online, you can also send via PAT Winlink from here.
          </div>
          <div style="display:grid; grid-template-columns: 130px 1fr; gap:.5rem 1rem; align-items:center;">
            <label style="font-weight:600;">Tail</label>
            <div id="locate-confirm-tail" style="font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;"></div>

            <label style="font-weight:600;">Subject</label>
            <div style="display:flex; gap:.5rem; align-items:center;">
              <input id="locate-confirm-subject" readonly
                     style="flex:1; padding:.5rem .6rem; border:1px solid #ccc; border-radius:.35rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;">
              <button type="button" id="copy-subject" class="button"
                      style="padding:.35rem .55rem; border:1px solid #ccc; background:#fafafa; border-radius:.35rem; cursor:pointer;">Copy subject</button>
              <span id="copy-subject-fb" class="copy-feedback">✓ Copied</span>
            </div>

            <label style="font-weight:600; align-self:start;">Body</label>
            <div>
              <textarea id="locate-confirm-body" readonly
                        style="width:100%; min-height:14rem; padding:.6rem; border:1px solid #ccc; border-radius:.35rem; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; white-space:pre;"></textarea>
              <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:.5rem;">
                <button type="button" id="copy-body" class="button"
                        style="padding:.35rem .55rem; border:1px solid #ccc; background:#fafafa; border-radius:.35rem; cursor:pointer;">Copy body</button>
                <span id="copy-body-fb" class="copy-feedback">✓ Copied</span>
              </div>
            </div>
          </div>

          <details style="margin-top:.5rem;">
            <summary class="muted">Recipients info</summary>
            <div id="locate-recipient-summary" class="muted" style="margin-top:.25rem;"></div>
            <div id="locate-recipients" class="muted" style="margin-top:.25rem; max-height:8rem; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;"></div>
          </details>

          <div id="locate-result" style="display:none; margin-top:.75rem; font-size:.9rem;"></div>
          <div style="display:flex; gap:.5rem; justify-content:flex-end; margin-top:1rem;">
            <button type="button" id="locate-back" class="button" style="padding:.4rem .7rem; border:1px solid #ccc; background:#fafafa; border-radius:.35rem; cursor:pointer;">Back</button>
            <button type="button" id="locate-send-online" class="button" style="padding:.4rem .7rem; border:1px solid #2b6; background:#25d366; color:#073; border-radius:.35rem; cursor:pointer;">Send via PAT now</button>
            <button type="button" id="locate-close" class="button" style="padding:.4rem .7rem; border:1px solid #ccc; background:#fafafa; border-radius:.35rem; cursor:pointer;">Close</button>
          </div>
        </div>
      </form>
    </div>
  </div>

<script>
  async function loadSupervisorCounts(){
    const resp = await fetch("{{ url_for('supervisor.supervisor_counts_partial') }}");
    document.getElementById("supervisor-counts-body").innerHTML = await resp.text();
  }
  async function loadSupervisorRecent(){
    const resp = await fetch("{{ url_for('supervisor.supervisor_recent_flights_partial') }}");
    document.getElementById("supervisor-recent-flights").innerHTML = await resp.text();
  }
  async function loadInventoryOverview(){
    const resp = await fetch("{{ url_for('inventory.inventory_overview_table') }}");
    document.getElementById("inventory-table").innerHTML = await resp.text();
  }
  // initial + auto-refresh
  loadSupervisorCounts();
  loadSupervisorRecent();
  loadInventoryOverview();
  async function loadSupervisorLocates(){
    const resp = await fetch("{{ url_for('supervisor.supervisor_recent_locates_partial') }}");
    document.getElementById("supervisor-locates-card").innerHTML = await resp.text();
  }
  loadSupervisorLocates();
  setInterval(loadSupervisorCounts, 30000);
  setInterval(loadSupervisorRecent, 30000);
  setInterval(loadInventoryOverview, 60000);
  setInterval(loadSupervisorLocates, 30000);

  // ───── Locate Flight modal wiring ────────────────────────────────────────
  (function(){
    const modal    = document.getElementById('locate-modal');
    const openBtn  = document.getElementById('btn-locate-flight');
    const cancel   = document.getElementById('locate-cancel');
    const form     = document.getElementById('locate-form');
    const input    = document.getElementById('locate-tail');
    const result   = document.getElementById('locate-result');
    const hint     = document.getElementById('locate-hint');

    // Step containers
    const step1    = document.getElementById('locate-step1');
    const step2    = document.getElementById('locate-step2');
    // Step 2 fields & controls
    const confTail   = document.getElementById('locate-confirm-tail');
    const confSubj   = document.getElementById('locate-confirm-subject');
    const confBody   = document.getElementById('locate-confirm-body');
    const copySubj   = document.getElementById('copy-subject');
    const copyBody   = document.getElementById('copy-body');
    const backBtn    = document.getElementById('locate-back');
    const closeBtn   = document.getElementById('locate-close');
    const sendOnline = document.getElementById('locate-send-online');
    const rcptSummary= document.getElementById('locate-recipient-summary');
    const rcptList   = document.getElementById('locate-recipients');

    function showModal(){
      result.style.display = 'none';
      result.textContent = '';
      input.value = '';
      modal.style.display = 'block';
      setTimeout(()=>input.focus(), 50);
      // Reset steps
      step1.style.display = 'block';
      step2.style.display = 'none';
    }
    function hideModal(){ modal.style.display = 'none'; }
    openBtn?.addEventListener('click', showModal);
    cancel?.addEventListener('click', hideModal);
    modal?.addEventListener('click', (e)=>{ if(e.target === modal) hideModal(); });

    // Step 1 → Step 2 (build preview; no network send required)
    form?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const tail = (input.value || '').trim().toUpperCase();
      if(!tail){
        input.focus();
        return;
      }
      hint.textContent = 'Preparing preview…';
      try{
        const resp = await fetch("{{ url_for('supervisor.locates_preview') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token() }}'
          },
          body: new URLSearchParams({ tail })
        });
        const data = await resp.json().catch(()=>({ok:false, message:'Unexpected response'}));
        if(!resp.ok || !data.ok){
          window.showToast?.(data.message || 'Failed to build preview','error',3000);
          return;
        }
        // Fill confirmation fields
        confTail.textContent = tail;
        confSubj.value = data.subject || '';
        confBody.value = data.body || '';
        // recipients
        const mapped = Number(data.mapped_count || 0);
        const cc     = Number(data.cc_count || 0);
        const total  = Number(data.recipient_count || data.queued || (data.recipients?.length || (mapped + cc)));
        rcptSummary.textContent = `Mapped: ${mapped} · CC: ${cc} · Total: ${total}`;
        rcptList.textContent = (data.recipients || []).join(', ');
        // Refresh the Recent locate requests card so the new row appears
        try { await loadSupervisorLocates(); } catch(_){}
        // Switch to step 2
        step1.style.display = 'none';
        step2.style.display = 'block';
      } catch(err){
        window.showToast?.('Error preparing preview','error',3000);
      } finally {
        hint.textContent = 'Builds an AOCT flight query you can copy/paste if offline, or send via PAT Winlink now if online.';
      }
    });

    // Copy helpers
    function flashButton(btn, label='Copied'){
      const orig = btn.textContent;
      btn.textContent = `✔ ${label}`;
      setTimeout(()=>{ btn.textContent = orig; }, 900);
    }
    copySubj?.addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(confSubj.value || '');
        flashButton(copySubj, 'Copied');
        const fb = document.getElementById('copy-subject-fb');
        if (fb) { fb.classList.add('visible'); setTimeout(()=>fb.classList.remove('visible'), 1000); }
        window.showToast?.('Subject copied','success',900);
      } catch(e){}
    });
    copyBody?.addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(confBody.value || '');
        flashButton(copyBody, 'Copied');
        const fb = document.getElementById('copy-body-fb');
        if (fb) { fb.classList.add('visible'); setTimeout(()=>fb.classList.remove('visible'), 1000); }
        window.showToast?.('Body copied','success',900);
      } catch(e){}
    });

    // Back to step 1
    backBtn?.addEventListener('click', ()=>{
      step2.style.display = 'none';
      step1.style.display = 'block';
      setTimeout(()=>input.focus(), 50);
    });
    // Close modal from step 2
    closeBtn?.addEventListener('click', hideModal);

    // Send via Winlink now (online path)
    sendOnline?.addEventListener('click', async ()=>{
      const tail = (input.value || '').trim().toUpperCase();
      if(!tail){ return; }
      // Client-side guard: at most 3 visible
      const visCount = document.querySelectorAll('.locates-card tbody tr[data-locate-id]').length;
      if (visCount >= 3) {
        result.style.display = 'block';
        result.style.color = '#a11';
        result.textContent = 'You already have 3 locate requests visible. Delete one before sending another.';
        return;
      }
      result.style.display = 'block';
      result.style.color = '#333';
      result.textContent = 'Sending…';
      try{
        const resp = await fetch("{{ url_for('supervisor.locates_start') }}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token() }}'
          },
          body: new URLSearchParams({ tail })
        });
        if (resp.status === 409) {
          const j = await resp.json().catch(()=>({}));
          result.style.color = '#a11';
          result.textContent = j.message || 'Limit reached (max 3).';
          return;
        }
        const data = await resp.json().catch(()=>({ok:false}));
        if(data.ok){
          result.style.color = '#075e36';
          const mapUrl = "{{ url_for('supervisor.locates_index') }}?tail=" + encodeURIComponent(tail);
          const count = (
            (typeof data.recipient_count === 'number' ? data.recipient_count : null) ??
            (typeof data.queued === 'number'          ? data.queued          : null) ??
            (typeof data.mapped_count === 'number'    ? data.mapped_count    : null) ??
            (Array.isArray(data.recipients)           ? data.recipients.length : null) ??
            0
          );
          result.innerHTML =
            `Locate queued for <b>${tail}</b> → <b>${count}</b> recipient${count===1?'':'s'}. ` +
            `<div style="margin-top:.4rem">
               <a href="/locates">See all requests</a> ·
               <a href="${mapUrl}">Open map for ${tail}</a>
             </div>`;
          // Refresh counts and locates card so the UI reflects the send
          try { await loadSupervisorCounts(); } catch(e){}
          try { await loadSupervisorLocates(); } catch(e){}
        } else {
          result.style.color = '#a11';
          result.textContent = data.message || 'Failed to send.';
        }
      } catch(err){
        result.style.color = '#a11';
        result.textContent = 'Network error while sending.';
      }
    });
  })();

  // ───── Delete locate handlers (Supervisor list) ──────────────────────────
  (function(){
    // Delegate so clicks still work after the card refreshes via AJAX
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('.js-delete-locate');
      if (!btn) return;
      e.preventDefault();
      if (!confirm('Delete this locate request?')) return;
      const url = btn.getAttribute('data-delete-url');
      try {
        const resp = await fetch(url, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': '{{ csrf_token() }}'
          }
        });
        const j = await resp.json().catch(()=>({ok:false}));
        if (resp.ok && j.ok) {
          // Refresh the card so indexes and status stay accurate
          try { await loadSupervisorLocates(); } catch(e){}
          if (window.showToast) window.showToast('Locate deleted.', 'info');
        } else {
          alert(j.message || 'Failed to delete locate.');
        }
      } catch (err) {
        alert('Network error while deleting.');
      }
    });
  })();
</script>
{% endblock %}
