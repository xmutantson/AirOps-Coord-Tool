<!-- templates/inventory_scan.html -->
{% extends "base.html" %}
{% block title %}Scan Items{% endblock %}
{% block content %}
<div class="ramp-form-container">
<div id="scan-app"
     data-url-lookup="{{ url_for('inventory.api_lookup_barcode_post') }}"
     data-url-scan-post="{{ url_for('inventory.api_scan_barcode') }}"
     data-url-save-map="{{ url_for('inventory.api_save_barcode_mapping') }}"
     data-url-categories="{{ url_for('inventory.api_inventory_categories') }}"
     data-url-admin="{{ url_for('inventory.inventory_barcodes_admin') }}"
     data-zxing-url="{{ url_for('static', filename='js/zxing.min.js') }}"
     data-manifest-id="{{ request.args.get('mid','') }}"
     data-scanner-mode="{{ (scanner_mode or request.cookies.get('scanner_mode','prompt')) }}"
     class="ramp-form-container">
  <h2>Scan Items</h2>

  {# Flash area (page-level messages) #}
  {% with msgs = get_flashed_messages(with_categories=true) %}
    {% if msgs %}
      <div id="flash-box" style="display:grid;gap:8px;margin:8px 0;">
        {% for cat, msg in msgs %}
          <div class="alert alert-{{ cat }}" style="padding:.5rem .75rem;border-radius:8px;border:1px solid #ddd;">
            {{ msg }}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div id="flash-box" style="display:none;gap:8px;margin:8px 0;"></div>
    {% endif %}
  {% endwith %}

  <div class="row" style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
    <label><input type="radio" name="dir" value="IN" checked> Inbound</label>
    <label><input type="radio" name="dir" value="OUT"> Outbound</label>
    <span id="scan-status" class="badge">idle</span>
    <button id="scan-photo-btn" type="button">Scan with camera (photo)</button>
    <input id="scan-photo-input"
           type="file"
           accept="image/*"
           capture="environment"
           style="display:none;">
  </div>
  <div class="lookup-row scan-row" style="margin-top:12px;">
    <input id="scan-kbd" type="text" placeholder="Focus here and scan (Enter)…" autofocus>
    <button id="scan-kbd-submit" type="button" class="scan-lookup">Lookup</button>
  </div>
  <small>USB scanners act like keyboards; they usually send Enter.</small>

  <!-- Single-qty toggle (cookie-backed; uses same GET /scan_mode as Inventory Detail) -->
  <div style="margin-top:10px;">
    <div class="radio-toggle">
      <input type="radio" id="scan-mode-prompt" name="scanner_mode_toggle" value="prompt"
             {% if (scanner_mode or request.cookies.get('scanner_mode','prompt')) != 'auto1' %}checked{% endif %}>
      <label for="scan-mode-prompt">Prompt qty</label>
      <input type="radio" id="scan-mode-auto1" name="scanner_mode_toggle" value="auto1"
             {% if (scanner_mode or request.cookies.get('scanner_mode','prompt')) == 'auto1' %}checked{% endif %}>
      <label for="scan-mode-auto1">Single</label>
    </div>
  </div>

  <div id="scan-result" style="display:grid;gap:10px;margin-top:16px;"></div>

  <!-- Inline unknown mapping form (stays on page; no navigation) -->
  <div id="scan-create" class="card" hidden
       style="border:1px solid #ffd39b;background:#fff7ea;border-radius:10px;padding:12px;max-width:720px;margin-top:16px;">
    <h3>Add item for scanned barcode</h3>
    <div class="stack" style="display:grid;gap:8px;">
      <label>Barcode
        <input id="u_barcode" type="text" readonly style="padding:8px;width:100%;background:#f7f7f7;">
      </label>
      <label>Category
        <select id="u_cat" required style="padding:8px;width:100%;">
          <option value="" disabled selected>— choose category —</option>
        </select>
      </label>
      <label>Item name (will be sanitized)
        <input id="u_name" type="text" required style="padding:8px;width:100%;" placeholder="e.g. water">
      </label>
      <label>Unit size
        <div class="lookup-row" style="gap:8px;">
          <input id="u_wpu" type="number" step="any" min="0" required placeholder="e.g. 12">
          <select id="u_unit" required style="max-width:8ch;">
            <option value="" disabled selected>unit</option>
            <option value="lbs">lb</option>
            <option value="oz">oz</option>
          </select>
        </div>
      </label>
      <div class="row" style="display:flex;gap:8px;">
        <button id="u_save">Save & Prefill</button>
        <button id="u_cancel" type="button">Cancel</button>
      </div>
      <small>Saving creates a barcode→item mapping and pre-fills the normal inventory form.</small>
    </div>
  </div>

</div><!-- /#scan-app -->
</div><!-- /.ramp-form-container -->

<audio id="beep"><source src="data:audio/mpeg;base64,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" type="audio/wav"></audio>
<meta name="csrf-token" content="{{ csrf_token() }}">

<link rel="stylesheet" href="{{ url_for('static', filename='scan.css') if false else '' }}">
<script defer src="{{ url_for('static', filename='js/barcode_scan.js') }}"></script>
<script>
// Optional tiny helper that your existing JS can call to surface a
// “what was logged” message without a full page refresh.
window.showFlash = function (msg, level) {
  var box = document.getElementById('flash-box');
  if (!box) return;
  box.style.display = 'grid';
  var div = document.createElement('div');
  div.className = 'alert alert-' + (level || 'success');
  div.style.cssText = 'padding:.5rem .75rem;border-radius:8px;border:1px solid #ddd;';
  div.textContent = msg;
  box.prepend(div);
  // auto-fade after ~4s
  setTimeout(function(){ if(div && div.parentNode){ div.parentNode.removeChild(div); } }, 4000);
};
// If you emit a CustomEvent('scan:logged', {detail: '...'}), we’ll show it.
window.addEventListener('scan:logged', function(e){ window.showFlash(e.detail, 'success'); });
// Persist scanner mode via GET /scan_mode (same as Inventory Detail)
(function () {
  const url = '{{ url_for("inventory.set_scan_mode") }}';
  const radios = document.querySelectorAll('input[name="scanner_mode_toggle"]');
  const scanApp = document.getElementById('scan-app');
  radios.forEach(r => r.addEventListener('change', e => {
    if (scanApp) scanApp.dataset.scannerMode = e.target.value; // reflect immediately
    fetch(url + '?mode=' + encodeURIComponent(e.target.value),
      { headers: {'X-Requested-With':'XMLHttpRequest'}, credentials: 'same-origin' }
    ).catch(()=>{});
  }));
})();
</script>
{% endblock %}
