{% extends "base.html" %}
{% block title %}Preferences – Aircraft Ops{% endblock %}

{% block content %}
<div class="container preferences">
  <form id="prefs-form" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- ── Ops / Display Prefs ─────────────────────────────── -->
    <h3>Display / Operational Prefs</h3>

    <label>Default Origin (ICAO or FAA):</label>
    <input
      id="default-origin"
      name="default_origin"
      value="{{ default_origin }}"
      placeholder="e.g. KSEA or SEA">

    <label>Airport Code Format:</label>
    <select name="code_format" onchange="this.form.submit()">
      <option value="icao4" {% if current_code=='icao4' %}selected{% endif %}>ICAO (4-letter)</option>
      <option value="iata"  {% if current_code=='iata'  %}selected{% endif %}>IATA (3-letter)</option>
      <option value="local" {% if current_code=='local' %}selected{% endif %}>FAA/GPS/Local</option>
    </select>

    <label style="margin-top:18px">Mass Unit:</label>
    <select name="mass_unit" onchange="this.form.submit()">
      <option value="lbs" {% if current_mass=='lbs' %}selected{% endif %}>lbs</option>
      <option value="kg"  {% if current_mass=='kg'  %}selected{% endif %}>kg</option>
    </select>

    <label style="margin-top:18px">Distance Unit:</label>
    <select name="distance_unit" onchange="this.form.submit()">
      <option value="nm" {% if distance_unit=='nm' %}selected{% endif %}>nautical miles</option>
      <option value="mi" {% if distance_unit=='mi' %}selected{% endif %}>statute miles</option>
      <option value="km" {% if distance_unit=='km' %}selected{% endif %}>kilometers</option>
    </select>

    <hr>

    <!-- ── Dashboard Prefs ────────────────────────────────── -->
    <h3>Dashboard Preferences</h3>

    <label>Hide “TBD” / empty cells in tables:</label>
    <select name="hide_tbd" onchange="document.getElementById('prefs-form').submit()">
      <option value="no"  {% if not hide_tbd %}selected{% endif %}>No</option>
      <option value="yes" {% if hide_tbd     %}selected{% endif %}>Yes</option>
    </select>

    <label>Sort by entry sequence:</label>
    <select name="dashboard_sort_seq" onchange="this.form.submit()">
      <option value="no"  {% if not sort_seq %}selected{% endif %}>Default grouping</option>
      <option value="yes" {% if sort_seq     %}selected{% endif %}>Newest first</option>
    </select>

    <hr>

    <!-- ── Radio-Operator Prefs ───────────────────────────── -->
    <h3>Radio Operator Prefs</h3>

    <label>Your Callsign:</label>
    <input
      id="cs"
      name="operator_call"
      value="{{ operator_call }}"
      oninput="this.value=this.value.toUpperCase()">
    <script>
      document.getElementById('cs')
              .addEventListener('blur', ()=>document.getElementById('prefs-form').submit());
    </script>

    <label style="margin-top:18px">Include test line in outgoing Winlink?</label>
    <select name="include_test" onchange="this.form.submit()">
      <option value="yes" {% if include_test=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if include_test=='no'  %}selected{% endif %}>No</option>
    </select>

    <label style="margin-top:18px">Only show unsent Ramp-Boss flights?</label>
    <select name="radio_show_unsent_only" onchange="this.form.submit()">
      <option value="no"  {% if current_radio_unsent=='no'  %}selected{% endif %}>No, show all</option>
      <option value="yes" {% if current_radio_unsent=='yes' %}selected{% endif %}>Yes, only unsent</option>
    </select>
  </form>

  <hr>

  <!-- ── Unlock Admin Mode ───────────────────────────────── -->
  <h3>Unlock Admin Mode</h3>
  <form method="POST" action="{{ url_for('preferences') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label for="admin-pass">Passphrase:</label>
    <input
      id="admin-pass"
      name="admin_passphrase"
      type="password"
      placeholder="I solemnly swear that I am up to no good"
      required>
    <button type="submit">Unlock</button>
  </form>

</div>

<script>
;(function(){
  const form  = document.getElementById('prefs-form');
  const input = document.getElementById('default-origin');
  let   timer;
  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(()=> form.submit(), 800);
  });
  input.addEventListener('blur', () => {
    clearTimeout(timer);
    form.submit();
  });
})();
</script>

{% endblock %}
