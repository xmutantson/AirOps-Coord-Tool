{% extends "base.html" %}
{% block title %}Preferences ‚Äì Aircraft Ops{% endblock %}

{% block content %}
<div class="container preferences">
  <form id="prefs-form" method="POST">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <!-- ‚îÄ‚îÄ Ops / Display Prefs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <h3>Display / Operational Prefs</h3>

    <label for="ramp_scan_adv_manifest"
      title="If Yes: on inbound Lookup Tail, parse the latest Remarks for advanced-manifest items and show the apply dialog."
    >Inbound manifest auto-scan</label>
    <select id="ramp_scan_adv_manifest" name="ramp_scan_adv_manifest" onchange="this.form.submit()">
      <option value="yes" {% if scan_adv_pref=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if scan_adv_pref=='no'  %}selected{% endif %}>No</option>
    </select>
    <label for="default-origin">Default Origin (ICAO or FAA):</label>
    <input
      id="default-origin"
      name="default_origin"
      value="{{ default_origin }}"
      placeholder="e.g. KSEA or SEA">

    <label for="code_format">Airport Code Format:</label>
    <select id="code_format" name="code_format" onchange="this.form.submit()">
      <option value="icao4" {% if current_code=='icao4' %}selected{% endif %}>ICAO (4-letter)</option>
      <option value="iata"  {% if current_code=='iata'  %}selected{% endif %}>IATA (3-letter)</option>
      <option value="local" {% if current_code=='local' %}selected{% endif %}>FAA/GPS/Local</option>
    </select>

    <label style="margin-top:18px" for="mass_unit">Mass Unit:</label>
    <select id="mass_unit" name="mass_unit" onchange="this.form.submit()">
      <option value="lbs" {% if current_mass=='lbs' %}selected{% endif %}>lbs</option>
      <option value="kg"  {% if current_mass=='kg'  %}selected{% endif %}>kg</option>
    </select>

    <label style="margin-top:18px" for="distance_unit">Distance Unit:</label>
    <select id="distance_unit" name="distance_unit" onchange="this.form.submit()">
      <option value="nm" {% if distance_unit=='nm' %}selected{% endif %}>nautical miles</option>
      <option value="mi" {% if distance_unit=='mi' %}selected{% endif %}>statute miles</option>
      <option value="km" {% if distance_unit=='km' %}selected{% endif %}>kilometers</option>
    </select>

    <hr>

    <!-- ‚îÄ‚îÄ Dashboard Prefs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <h3>Dashboard Preferences</h3>

    <label for="hide_tbd">Hide ‚ÄúTBD‚Äù / empty cells in tables:</label>
    <select id="hide_tbd" name="hide_tbd" onchange="document.getElementById('prefs-form').submit()">
      <option value="no"  {% if not hide_tbd %}selected{% endif %}>No</option>
      <option value="yes" {% if hide_tbd     %}selected{% endif %}>Yes</option>
    </select>

    <label for="dashboard_sort_seq">Sort by entry sequence:</label>
    <select id="dashboard_sort_seq" name="dashboard_sort_seq" onchange="this.form.submit()">
      <option value="no"  {% if not sort_seq %}selected{% endif %}>Default grouping</option>
      <option value="yes" {% if sort_seq     %}selected{% endif %}>Newest first</option>
    </select>

    <hr>

    <!-- ‚îÄ‚îÄ Radio-Operator Prefs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <h3>Radio Operator Prefs</h3>

    <label for="cs">Your Callsign:</label>
    <input
      id="cs"
      name="operator_call"
      value="{{ operator_call }}"
      oninput="this.value=this.value.toUpperCase()">
    <script>
      document.getElementById('cs')
              .addEventListener('blur', ()=>document.getElementById('prefs-form').submit());
    </script>

    <label style="margin-top:18px" for="include_test">Include test line in outgoing Winlink?</label>
    <select id="include_test" name="include_test" onchange="this.form.submit()">
      <option value="yes" {% if include_test=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if include_test=='no'  %}selected{% endif %}>No</option>
    </select>

    <label style="margin-top:18px" for="radio_show_unsent_only">Only show unsent Ramp-Boss flights?</label>
    <select id="radio_show_unsent_only" name="radio_show_unsent_only" onchange="this.form.submit()">
      <option value="no"  {% if current_radio_unsent=='no'  %}selected{% endif %}>No, show all</option>
      <option value="yes" {% if current_radio_unsent=='yes' %}selected{% endif %}>Yes, only unsent</option>
    </select>

    <hr>

    <!-- ‚îÄ‚îÄ Remote Airports (AOCT) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <h3>Remote Airports (AOCT)</h3>

    <label for="auto_broadcast_interval_min">Auto-broadcast interval:</label>
    <select id="auto_broadcast_interval_min" name="auto_broadcast_interval_min" onchange="this.form.submit()">
      <option value="0"
        {% if auto_broadcast_interval_min not in ['15','30','60'] %}selected{% endif %}>
        Disabled
      </option>
      <option value="15" {% if auto_broadcast_interval_min=='15' %}selected{% endif %}>
        Every 15 minutes
      </option>
      <option value="30" {% if auto_broadcast_interval_min=='30' %}selected{% endif %}>
        Every 30 minutes
      </option>
      <option value="60" {% if auto_broadcast_interval_min=='60' %}selected{% endif %}>
        Every 60 minutes
      </option>
    </select>

    <label style="margin-top:18px" for="auto_reply_enabled">Auto-reply to AOCT cargo queries?</label>
    <select id="auto_reply_enabled" name="auto_reply_enabled" onchange="this.form.submit()">
      <option value="yes" {% if auto_reply_enabled=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if auto_reply_enabled=='no'  %}selected{% endif %}>No</option>
    </select>

    <hr>

    <!-- ‚îÄ‚îÄ Flight Locate & Offline Maps ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <h3>Flight Locate &amp; Offline Maps</h3>

    <label for="adsb_base_url" class="hidden">ADS-B Base URL (aircraft.json):</label>
    <input
      id="adsb_base_url"
      type="hidden"
      name="adsb_base_url"
      value="{{ adsb_base_url }}"
      placeholder="http://192.168.8.x/tar1090">

    <label style="margin-top:18px" for="adsb_stream_url">ADS-B JSON stream (30154):</label>
    <input
      id="adsb_stream_url"
      name="adsb_stream_url"
      value="{{ adsb_stream_url }}"
      placeholder="tcp://ops.lan:30154">
    <small>Use <code>tcp://host:port</code> (recommended). If your setup serves JSON-lines over HTTP, use <code>http://host:port/</code>.</small>

    <label style="margin-top:18px" for="aoct_auto_reply_flight">Auto-reply to Flight Query with latest sighting?</label>
    <select id="aoct_auto_reply_flight" name="aoct_auto_reply_flight" onchange="this.form.submit()">
      <option value="yes" {% if aoct_auto_reply_flight=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if aoct_auto_reply_flight=='no'  %}selected{% endif %}>No</option>
    </select>

    <label style="margin-top:18px" for="adsb_poll_enabled">Enable local ADS-B poller?</label>
    <select id="adsb_poll_enabled" name="adsb_poll_enabled" onchange="this.form.submit()">
      <option value="no"  {% if adsb_poll_enabled!='yes' %}selected{% endif %}>No</option>
      <option value="yes" {% if adsb_poll_enabled=='yes' %}selected{% endif %}>Yes</option>
    </select>

    <label for="adsb_poll_interval_s">Poll interval (seconds):</label>
    <input
      id="adsb_poll_interval_s"
      name="adsb_poll_interval_s"
      type="number" inputmode="numeric" min="1" step="1"
      value="{{ adsb_poll_interval_s }}"
      placeholder="10">

    <label style="margin-top:18px" for="map_tiles_path">Map tiles path (directory or .mbtiles file):</label>
    <input
      id="map_tiles_path"
      name="map_tiles_path"
      value="{{ map_tiles_path }}"
      placeholder="{{ map_tiles_default }}">
    <small>Leave blank to use default: <code>{{ map_tiles_default }}</code></small>

    <label style="margin-top:18px" for="map_offline_seed">Seed low-zoom tiles on first boot?</label>
    <select id="map_offline_seed" name="map_offline_seed" onchange="this.form.submit()">
      <option value="yes" {% if map_offline_seed=='yes' %}selected{% endif %}>Yes</option>
      <option value="no"  {% if map_offline_seed=='no'  %}selected{% endif %}>No</option>
    </select>

  </form>

  <hr>
  <form id="mappings-form" method="POST" action="{{ url_for('preferences.preferences') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <h3>Airport ‚Üí WinLink Callsign Mappings</h3>
    <div id="airport-mappings">
      {% for code, cs in airport_mappings %}
      <div class="mapping-row">
        <input name="airport_codes[]" class="map-airport"
               value="{{ code }}" placeholder="Airport ICAO or FAA"
               oninput="this.value=this.value.toUpperCase()">
        <input name="winlink_callsigns[]" class="map-callsign"
               value="{{ cs }}" placeholder="WinLink Callsign"
               oninput="this.value=this.value.toUpperCase()">
        <button type="button" class="remove-mapping" title="Remove row">‚àí</button>
      </div>
      {% endfor %}
      {% if not airport_mappings %}
      <div class="mapping-row">
        <input name="airport_codes[]" class="map-airport"
               placeholder="Airport ICAO or FAA"
               oninput="this.value=this.value.toUpperCase()">
        <input name="winlink_callsigns[]" class="map-callsign"
               placeholder="WinLink Callsign"
               oninput="this.value=this.value.toUpperCase()">
        <button type="button" class="remove-mapping" title="Remove row">‚àí</button>
      </div>
      {% endif %}
    </div>
    <button type="button" id="add-mapping" class="block-btn">Ôºã Add mapping</button>

    <h3 style="margin-top:2em;">WinLink CC Addresses</h3>
    <div class="cc-row">
      {% for idx in [1,2,3] %}
        <input name="winlink_cc_{{ idx }}" class="map-cc"
               value="{{ (winlink_cc_1,winlink_cc_2,winlink_cc_3)[idx-1] }}"
               placeholder="CC Address #{{ idx }}"
               oninput="this.value=this.value.toUpperCase()">
      {% endfor %}
    </div>
    <div class="cc-row" style="margin-top:.5rem;">
      <strong>Include CCs on AOCT messages:</strong>
    </div>
    <div class="cc-row" style="display:grid;grid-template-columns: 240px 120px;gap:.5rem;align-items:center;">
      <label for="aoct_cc_query">‚Ä¢ Cargo <em>Query</em> sends:</label>
      <select id="aoct_cc_query" name="aoct_cc_query">
        <option value="no"  {% if aoct_cc_query!='yes' %}selected{% endif %}>No</option>
        <option value="yes" {% if aoct_cc_query=='yes' %}selected{% endif %}>Yes</option>
      </select>
      <label for="aoct_cc_reply">‚Ä¢ Cargo <em>Reply</em> sends:</label>
      <select id="aoct_cc_reply" name="aoct_cc_reply">
        <option value="no"  {% if aoct_cc_reply!='yes' %}selected{% endif %}>No</option>
        <option value="yes" {% if aoct_cc_reply=='yes' %}selected{% endif %}>Yes</option>
      </select>
      <label for="aoct_cc_broadcast">‚Ä¢ Cargo <em>Broadcast</em> sends:</label>
      <select id="aoct_cc_broadcast" name="aoct_cc_broadcast">
        <option value="no"  {% if aoct_cc_broadcast!='yes' %}selected{% endif %}>No</option>
        <option value="yes" {% if aoct_cc_broadcast=='yes' %}selected{% endif %}>Yes</option>
      </select>
    </div>
    <button type="submit" class="save-mappings-btn">üíæ Save WinLink Mappings & CCs</button>
  </form>
  <hr>

  <!-- ‚îÄ‚îÄ NetOps Feeder (Remote Push) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <h3>NetOps Feeder</h3>
  <form id="netops-form" method="POST" action="{{ url_for('preferences.preferences') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label for="netops_enabled">Enable NetOps Feeder:</label>
    <select id="netops_enabled" name="netops_enabled">
      <option value="no"  {% if netops_enabled!='yes' %}selected{% endif %}>No</option>
      <option value="yes" {% if netops_enabled=='yes' %}selected{% endif %}>Yes</option>
    </select>

    <label for="netops_url">NetOps URL:</label>
    <input id="netops_url" name="netops_url" value="{{ netops_url }}" placeholder="http://example.org:5250">

    <label for="netops_station">Station ID (Pelican Case):</label>
    <input id="netops_station" name="netops_station" value="{{ netops_station }}" placeholder="KALW" oninput="this.value=this.value.toUpperCase()">

    <label for="netops_password">Password:</label>
    <input id="netops_password" type="password" name="netops_password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
    <small>Leave blank to keep existing.</small>

    <label for="netops_push_interval_sec">Push Interval (seconds):</label>
    <input id="netops_push_interval_sec" name="netops_push_interval_sec"
           type="number" inputmode="numeric" min="1" step="1"
           value="{{ netops_push_interval_sec }}"
           placeholder="e.g. 30">

    <label for="netops_window_hours">Data Window (hours):</label>
    <input id="netops_window_hours" name="netops_window_hours"
           type="number" inputmode="numeric" min="1" step="1"
           value="{{ netops_window_hours }}"
           placeholder="e.g. 24">

    <label for="origin-lat">Origin Coordinates (lat, lon):</label>
    <div style="display:flex; gap:8px; align-items:center;">
      <input id="origin-lat" name="origin_lat"
             type="number" inputmode="decimal" step="any" min="-90"  max="90"
             value="{{ origin_lat }}" placeholder="Latitude (‚àí90 to 90)" style="flex:1;">
      <input id="origin-lon" name="origin_lon"
             type="number" inputmode="decimal" step="any" min="-180" max="180"
             value="{{ origin_lon }}" placeholder="Longitude (‚àí180 to 180)" style="flex:1;">
    </div>
    <button type="submit" style="margin-top:12px;">üíæ Save NetOps Settings</button>
    <button type="submit"
            name="netops_action"
            value="test"
            style="margin-top:12px;margin-left:8px;">
      üîå Test Connection
    </button>
  </form>

  <hr>

  <!-- ‚îÄ‚îÄ Unlock Admin Mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <h3>Unlock Admin Mode</h3>
  <form method="POST" action="{{ url_for('preferences.preferences') }}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <label for="admin-pass">Passphrase:</label>
    <input
      id="admin-pass"
      name="admin_passphrase"
      type="password"
      placeholder="I solemnly swear that I am up to no good"
      required>
    <button type="submit">Unlock</button>
  </form>

</div>

<script>
;(function(){
  const form  = document.getElementById('prefs-form');
  const input = document.getElementById('default-origin');
  let   timer;
  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(()=> form.submit(), 800);
  });
  input.addEventListener('blur', () => {
    clearTimeout(timer);
    form.submit();
  });
})();
</script>

<script>
(function(){
  const addBtn    = document.getElementById('add-mapping');
  const container = document.getElementById('airport-mappings');
  if (!addBtn || !container) return;

  addBtn.addEventListener('click', () => {
    const template = container.querySelector('.mapping-row').cloneNode(true);
    // Clear out values
    template.querySelectorAll('input').forEach(i => i.value = '');
    container.appendChild(template);
  });

  container.addEventListener('click', (e) => {
    if (e.target.matches('.remove-mapping') && container.children.length > 1) {
      e.target.closest('.mapping-row').remove();
    }
  });
})();
</script>

{% endblock %}
