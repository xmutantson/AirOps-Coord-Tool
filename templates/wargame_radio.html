{% extends "base.html" %}
{% block title %}Wargame · Radio Inbox{% endblock %}

{% block content %}
<div class="container">
  <h1>Wargame — Radio Inbox</h1>

  {% if emails|length == 0 %}
    <p>No messages yet.</p>
  {% else %}
    <table class="table table-striped wg-radio-table">
      <thead>
        <tr>
          <th style="white-space:nowrap;">Received (UTC)</th>
          <th>From → To</th>
          <th>Subject</th>
          <th style="text-align:right;">Size</th>
        </tr>
      </thead>
      <tbody>
      {% for e in emails %}
        <tr class="wg-email{% if e.read %} read{% endif %}">
          <td class="when" style="white-space:nowrap;">{{ e.generated_at }}</td>
          <td class="from">{{ e.sender }} → {{ e.recipient }}</td>
          <td class="subject">
            <a href="#" class="open-email" data-email-id="{{ e.id }}">{{ e.subject }}</a>
          </td>
          <td class="size" style="text-align:right;">{{ e.size_bytes }} B</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  <!-- Exit role (kept in normal flow; positioning via global .wg-exit-form CSS) -->
  <form class="wg-exit-form" method="post"
        action="{{ url_for('wargame_exit_role') }}"
        onsubmit="return confirm('Exit your role and choose a new one?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow">Exit role</button>
  </form>
</div>

<!-- Lightweight email viewer -->
<dialog id="emailDialog">
  <form method="dialog" class="email-modal">
    <h3 id="emailSubject" style="margin:0 0 .5rem 0;"></h3>
    <pre id="emailBody" style="white-space:pre-wrap; max-height:50vh; overflow:auto; margin:0;"></pre>
    <div style="text-align:right; margin-top:.75rem;">
      <button class="btn">Close</button>
    </div>
  </form>
</dialog>

<script>
(function(){
  const dlg  = document.getElementById('emailDialog');
  const subj = document.getElementById('emailSubject');
  const body = document.getElementById('emailBody');

  // Stable epoch for this Wargame run (namespaces the cookie)
  const EPOCH  = {{ epoch|default(0) }};
  const COOKIE = 'wargame_emails_read_' + EPOCH;

  function getCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|;\\s*)' + name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function setCookie(name, value){
    document.cookie = name + '=' + encodeURIComponent(value) + '; Max-Age=31536000; Path=/; SameSite=Lax';
  }
  function markRead(id, row){
    const current = getCookie(COOKIE);
    const set = new Set((current ? current.split(',') : []).filter(Boolean));
    set.add(String(id));
    setCookie(COOKIE, Array.from(set).join(','));
    if (row) row.classList.add('read');
  }

  document.querySelectorAll('.open-email').forEach(a => {
    a.addEventListener('click', ev => {
      ev.preventDefault();
      const id  = a.dataset.emailId;
      const row = a.closest('tr');
      // No url_for here — build the path on the client:
      fetch('/wargame/radio/email/' + id)
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(data => {
          subj.textContent = data.subject || '(no subject)';
          body.textContent = data.body || '';
          if (dlg.showModal) dlg.showModal(); else dlg.setAttribute('open', 'open');
          markRead(id, row);
        })
        .catch(() => {});
    });
  });

  // On load, apply “read” class from the stable cookie so it survives reloads.
  (function applyReadState(){
    const seen = new Set((getCookie(COOKIE) || '').split(',').filter(Boolean));
    if (seen.size === 0) return;
    document.querySelectorAll('a.open-email[data-email-id]').forEach(a => {
      if (seen.has(String(a.dataset.emailId))) {
        const tr = a.closest('tr');
        if (tr) tr.classList.add('read');
      }
    });
  })();
})();
</script>

{% endblock %}
