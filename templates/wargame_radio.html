{% extends "base.html" %}
{% block title %}Wargame · Radio Inbox{% endblock %}

{% block content %}
<div class="container">
  <h1>Wargame — Radio Inbox</h1>

  <table class="table table-striped wg-radio-table">
    <thead>
      <tr>
        <th style="width:1.5rem;"></th>
        <th style="white-space:nowrap;">Received (UTC)</th>
        <th>From → To</th>
        <th>Subject</th>
        <th>Size</th>
      </tr>
    </thead>
    <tbody>
      {% if emails and emails|length > 0 %}
        {% for e in emails %}
          <tr class="wg-email{% if e.read %} read{% endif %}" data-email-row="{{ e.id }}">
            <td><span class="dot" title="Unread"></span></td>
            <td class="when" style="white-space:nowrap;">{{ e.generated_at }}</td>
            <td class="from">{{ e.sender }} → {{ e.recipient }}</td>
            <td class="subject">
              <a href="#" class="open-email" data-email-id="{{ e.id }}">{{ e.subject }}</a>
            </td>
            <td class="size">{{ e.size_bytes }} B</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="muted">No messages yet.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <!-- Exit role (kept in normal flow; positioning via global .wg-exit-form CSS) -->
  <form class="wg-exit-form" method="post"
        action="{{ url_for('wargame_exit_role') }}"
        onsubmit="return confirm('Exit your role and choose a new one?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow">Exit role</button>
  </form>
</div>

<!-- Email viewer (centered, draggable via header bar only) -->
<dialog id="emailDialog" class="wg-modal" aria-modal="true">
  <form method="dialog" class="email-modal">
    <div id="wgModalDrag" class="wg-modal-header">
      <button type="button" id="wgClose" class="wg-modal-close" aria-label="Close">✕</button>
    </div>
    <div class="wg-modal-body email-content">
      <h3 id="emailSubject" class="wg-modal-subject"></h3>
      <pre id="emailBody" class="wg-modal-pre"></pre>
    </div>
  </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.__wgRadioInit) return;    // one-time init guard
  window.__wgRadioInit = true;

  const dlg      = document.getElementById('emailDialog');
  const subj     = document.getElementById('emailSubject');
  const body     = document.getElementById('emailBody');
  const closeBtn = document.getElementById('wgClose');
  const dragBar  = document.getElementById('wgModalDrag');

  // Namespace read-state per wargame run
  const EPOCH  = {{ epoch|default(0) }};
  const COOKIE = 'wargame_emails_read_' + EPOCH;

  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|;\\s*)' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function setCookie(name, value) {
    document.cookie = name + '=' + encodeURIComponent(value) + '; Max-Age=31536000; Path=/; SameSite=Lax';
  }
  function markRead(id, row) {
    const current = getCookie(COOKIE);
    const set = new Set((current ? current.split(',') : []).filter(Boolean));
    set.add(String(id));
    setCookie(COOKIE, Array.from(set).join(','));
    if (row) row.classList.add('read');
  }

  function openModal() {
    // center, then show
    dlg.style.left = '50%';
    dlg.style.top = '50%';
    dlg.style.transform = 'translate(-50%, -50%)';
    if (dlg.showModal) dlg.showModal(); else dlg.setAttribute('open', 'open');
  }
  function closeModal() {
    if (dlg.close) dlg.close(); else dlg.removeAttribute('open');
    localStorage.removeItem('wg_open_email_id');
  }

  closeBtn.addEventListener('click', closeModal);
  dlg.addEventListener('cancel', (e) => { e.preventDefault(); closeModal(); });

  function openEmail(id, row) {
    fetch('/wargame/radio/email/' + id)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(data => {
        subj.textContent = data.subject || '(no subject)';
        body.textContent = data.body || '';
        localStorage.setItem('wg_open_email_id', String(id));
        openModal();
        markRead(id, row);
      })
      .catch(() => { /* swallow; keep UI responsive */ });
  }

  // Drag only by the header bar
  (function enableDrag() {
    let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;

    dragBar.addEventListener('mousedown', (ev) => {
      // measure current box while centered, then "pin" it
      let box = dlg.getBoundingClientRect();
      dlg.style.left = box.left + 'px';
      dlg.style.top  = box.top  + 'px';
      dlg.style.transform = '';
      dragging = true;
      startLeft = box.left; startTop = box.top;
      startX = ev.clientX; startY = ev.clientY;
      ev.preventDefault();
    });

    window.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      dlg.style.left = (startLeft + dx) + 'px';
      dlg.style.top  = (startTop  + dy) + 'px';
    });

    window.addEventListener('mouseup', () => { dragging = false; });
  })();

  // Event delegation: open on subject click
  document.addEventListener('click', function (ev) {
    const link = ev.target.closest('a.open-email');
    if (!link) return;
    ev.preventDefault();
    const id  = link.dataset.emailId;
    const row = link.closest('tr');
    openEmail(id, row);
  });

  // Re-open last open message after refresh (if any)
  (function reopenIfNeeded() {
    const reopen = localStorage.getItem('wg_open_email_id');
    if (!reopen) return;
    const link = document.querySelector('a.open-email[data-email-id="' + reopen + '"]');
    openEmail(reopen, link ? link.closest('tr') : null);
  })();

  // Apply “read” class from cookie (persists across reloads)
  (function applyReadState() {
    const seen = new Set((getCookie(COOKIE) || '').split(',').filter(Boolean));
    if (seen.size === 0) return;
    document.querySelectorAll('a.open-email[data-email-id]').forEach(a => {
      if (seen.has(String(a.dataset.emailId))) {
        const tr = a.closest('tr');
        if (tr) tr.classList.add('read');
      }
    });
  })();
});
</script>
{% endblock %}
