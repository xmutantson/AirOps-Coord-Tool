{% extends "base.html" %}
{% block title %}Wargame · Radio Inbox{% endblock %}

{% block content %}
<div class="container">
  <h1>Wargame — Radio Inbox</h1>

  <table class="table table-striped wg-radio-table">
    <thead>
      <tr>
        <th style="width:1.5rem;"></th>
        <th style="white-space:nowrap;">Received (UTC)</th>
        <th>From → To</th>
        <th>Subject</th>
        <th>Size</th>
      </tr>
    </thead>
    <tbody>
      {% if emails and emails|length > 0 %}
        {% for e in emails %}
          <tr class="wg-email{% if e.read %} read{% endif %}" data-email-row="{{ e.id }}">
            <td><span class="dot" title="Unread"></span></td>
            <td class="when" style="white-space:nowrap;">{{ e.generated_at }}</td>
            <td class="from">{{ e.sender }} → {{ e.recipient }}</td>
            <td class="subject">
              <a href="#" class="open-email" data-email-id="{{ e.id }}">{{ e.subject }}</a>
            </td>
            <td class="size">{{ e.size_bytes }} B</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="muted">No messages yet.</td></tr>
      {% endif %}
    </tbody>
  </table>

  <!-- Exit role -->
  <form class="wg-exit-form" method="post"
        action="{{ url_for('wargame_exit_role') }}"
        onsubmit="return confirm('Exit your role and choose a new one?');">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="submit" class="btn btn-yellow">Exit role</button>
  </form>
</div>

<!-- Email viewer -->
<dialog id="emailDialog" class="wg-modal" aria-modal="true">
  <form method="dialog" class="email-modal">
    <div id="wgModalDrag" class="wg-modal-header">
      <button type="button" id="wgClose" class="wg-modal-close" aria-label="Close">✕</button>
    </div>
    <div class="wg-modal-body email-content">
      <h3 id="emailSubject" class="wg-modal-subject"></h3>
      <pre id="emailBody" class="wg-modal-pre"></pre>
    </div>
  </form>
</dialog>

<script>
document.addEventListener('DOMContentLoaded', function () {
  if (window.__wgRadioInit) return;
  window.__wgRadioInit = true;

  const dlg      = document.getElementById('emailDialog');
  const subj     = document.getElementById('emailSubject');
  const body     = document.getElementById('emailBody');
  const closeBtn = document.getElementById('wgClose');
  const dragBar  = document.getElementById('wgModalDrag');

  // Namespace read-state per wargame run
  const EPOCH  = {{ epoch|default(0) }};
  const COOKIE = 'wargame_emails_read_' + EPOCH;

  /* ── Cookie helpers ───────────────────────────────────────── */
  function getCookie(name) {
    const m = document.cookie.match(new RegExp('(?:^|;\\s*)' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function setCookie(name, value) {
    document.cookie = name + '=' + encodeURIComponent(value) + '; Max-Age=31536000; Path=/; SameSite=Lax';
  }

  /* ── Range codec (back‑compatible with comma‑separated ids) ─ */
  function mergeRanges(ranges){
    if (!ranges.length) return [];
    ranges.sort((a,b)=> (a[0]-b[0]) || (a[1]-b[1]));
    const out=[ranges[0].slice()];
    for(let i=1;i<ranges.length;i++){
      const [s,e]=ranges[i], last=out[out.length-1];
      if (s<=last[1]+1) last[1]=Math.max(last[1],e);
      else out.push([s,e]);
    }
    return out;
  }
  function parseRanges(str){
    if (!str) return [];
    const parts = str.split(',').map(s=>s.trim()).filter(Boolean);
    const ranges=[];
    for (const p of parts){
      if (/^\d+$/.test(p)){ const v=+p; ranges.push([v,v]); }
      else{
        const m=p.match(/^(\d+)-(\d+)$/);
        if (m){ const a=+m[1], b=+m[2]; ranges.push([Math.min(a,b), Math.max(a,b)]); }
      }
    }
    return mergeRanges(ranges);
  }
  function encodeRanges(ranges){
    return ranges.map(([s,e])=> s===e ? String(s) : `${s}-${e}`).join(',');
  }
  function contains(ranges, id){
    id = +id;
    return ranges.some(([s,e]) => id>=s && id<=e);
  }
  function addId(ranges, id){
    id = +id;
    return mergeRanges([...ranges, [id,id]]);
  }

  function markRead(id, row) {
    const current = getCookie(COOKIE);
    const ranges  = parseRanges(current);
    const next    = encodeRanges(addId(ranges, id));
    setCookie(COOKIE, next);
    if (row) row.classList.add('read');
  }

  function openModal() {
    dlg.style.left = '50%';
    dlg.style.top  = '50%';
    dlg.style.transform = 'translate(-50%, -50%)';
    if (dlg.showModal) dlg.showModal(); else dlg.setAttribute('open', 'open');
  }
  function closeModal() {
    if (dlg.close) dlg.close(); else dlg.removeAttribute('open');
    localStorage.removeItem('wg_open_email_id');
  }

  closeBtn.addEventListener('click', closeModal);
  dlg.addEventListener('cancel', (e) => { e.preventDefault(); closeModal(); });

  function openEmail(id, row) {
    fetch('/wargame/radio/email/' + id)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(data => {
        subj.textContent = data.subject || '(no subject)';
        body.textContent = data.body || '';
        localStorage.setItem('wg_open_email_id', String(id));
        openModal();
        markRead(id, row);
      })
      .catch(() => {});
  }

  // Drag only by the header bar
  (function enableDrag() {
    let dragging = false, startX = 0, startY = 0, startLeft = 0, startTop = 0;

    dragBar.addEventListener('mousedown', (ev) => {
      let box = dlg.getBoundingClientRect();
      dlg.style.left = box.left + 'px';
      dlg.style.top  = box.top  + 'px';
      dlg.style.transform = '';
      dragging = true;
      startLeft = box.left; startTop = box.top;
      startX = ev.clientX; startY = ev.clientY;
      ev.preventDefault();
    });

    window.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      dlg.style.left = (startLeft + dx) + 'px';
      dlg.style.top  = (startTop  + dy) + 'px';
    });

    window.addEventListener('mouseup', () => { dragging = false; });
  })();

  // Event delegation: open on subject click
  document.addEventListener('click', function (ev) {
    const link = ev.target.closest('a.open-email');
    if (!link) return;
    ev.preventDefault();
    const id  = link.dataset.emailId;
    const row = link.closest('tr');
    openEmail(id, row);
  });

  // Re-open last open message after refresh (if any)
  (function applyAutoReopen() {
    const qs = new URLSearchParams(location.search);
    const reopenId = +(qs.get('open_email') || 0);
    if (reopenId > 0) {
      openEmail(reopenId, null);
    }
  })();

  // Apply “read” class from range cookie
  (function applyReadState() {
    const ranges = parseRanges(getCookie(COOKIE) || '');
    if (!ranges.length) return;
    document.querySelectorAll('a.open-email[data-email-id]').forEach(a => {
      if (contains(ranges, a.dataset.emailId)) {
        const tr = a.closest('tr');
        if (tr) tr.classList.add('read');
      }
    });
  })();
});
</script>

<script>
(function(){
  // Simple US-style tail like N12345 or N1234X (no I/O/Q)
  function genTail(){
    const letters = "ABCDEFGHJKLMNPQRSTUVWXYZ";
    const n = Math.floor(10000 + Math.random()*90000); // 5 digits
    const suffix = Math.random() < 0.35 ? letters[Math.floor(Math.random()*letters.length)] : "";
    return "N" + n + suffix;
  }

  document.addEventListener('click', function(e){
    // When the cargo request UI is opened, ensure tail is prefilled once
    // Try a few common selectors; harmless if none exist on this page.
    const form = document.querySelector('#cargo-request-form, form[data-role="cargo-request"], form[name="cargo_request"]');
    if (!form) return;

    // If a button/link with an id/class hints the modal opens, hook that:
    if (e.target.closest('#open-cargo-request, .open-cargo-request, [data-open="cargo-request"]')) {
      const tail = form.querySelector('input[name="tail_number"], input[name="tail"], input[id*="tail"]');
      if (tail && !tail.value.trim()) tail.value = genTail();
    }
  });

  // Safety net: on submit, still ensure it exists (no effect outside this page)
  document.addEventListener('submit', function(ev){
    const form = ev.target;
    if (!form || !form.matches('#cargo-request-form, form[data-role="cargo-request"], form[name="cargo_request"]')) return;
    const tail = form.querySelector('input[name="tail_number"], input[name="tail"], input[id*="tail"]');
    if (tail && !tail.value.trim()) tail.value = genTail();
  }, true);
})();
</script>

{% endblock %}
